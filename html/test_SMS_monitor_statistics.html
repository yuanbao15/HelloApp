<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <title>è¿åœè­¦æŠ¥ç»Ÿè®¡</title>
    <link rel="stylesheet" href="../css/api.css">
    <script src="https://unpkg.com/mescroll.js@1.4.2/mescroll.min.js"></script>
    <style>
        .container {padding: 15px;}
        .stats-container {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;}
        .stats-header {background: #007aff; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;}
        .stats-header button:hover {opacity: 0.8;}
        .stats-summary .grid-item {transition: transform 0.2s;}
        .stats-summary .grid-item:hover {transform: scale(1.05);}
        .stats-charts {transition: all 0.3s ease;}
        .stats-charts:hover {box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .chart-bar {transition: height 0.5s ease;}
        .chart-bar:hover {opacity: 0.8;}
        .records-item {transition: all 0.2s ease;}
        .records-item:hover {background: #f0f0f0 !important; transform: translateX(2px);}
        .stats-actions button {transition: all 0.2s ease;}
        .stats-actions button:hover {transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
        .stats-actions button:active {transform: translateY(0);}
        .btn {padding: 10px 10px; margin: 5px; background: #007aff; color: white; border: none; border-radius: 5px; cursor: pointer;}
        .btn:disabled {background: #ccc; cursor: not-allowed; opacity: 0.6;}
        .btn:enabled:hover {background: #0056cc;}
        .btn-danger {background: #ff4444;}
        .btn-danger:hover {background: #cc0000;}
        .btn-success {background: #44aa44;}
        .btn-success:hover {background: #338833;}
        
        /* å¤šé€‰æ¨¡å¼æ ·å¼ */
        .records-item.multi-select { border: 2px solid #007aff; }
        .records-item.multi-select.selected { background: #e3f2fd !important; }
        .selection-indicator { 
            width: 20px; 
            height: 20px; 
            border: 2px solid #007aff; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px;
            font-weight: bold;
        }
        .selection-indicator.selected { 
            background: #007aff; 
            color: white; 
        }
        
        /* é•¿æŒ‰åé¦ˆæ ·å¼ */
        .records-item.long-pressing {
            transform: scale(0.98);
            opacity: 0.8;
            transition: all 0.1s ease;
        }
        
        /* é˜²æ­¢æ–‡æœ¬é€‰æ‹© */
        .records-item {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* å›¾è¡¨æ‚¬æµ®æç¤ºæ¡†æ ·å¼ */
        .chart-tooltip {
            position: fixed;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1000;
            pointer-events: none;
            transform: translate(-50%, -100%);
            margin-top: -15px;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }
        
        .chart-tooltip.show {
            opacity: 1;
            transform: translate(-50%, -100%) scale(1.05);
        }
        
        .chart-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #2c3e50;
        }
        
        /* æŸ±çŠ¶å›¾æ‚¬åœæ•ˆæœ */
        .chart-bar:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        /* æŸ±çŠ¶å›¾ç‚¹å‡»æ•ˆæœ */
        .chart-bar:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
        
        /* æŸ±çŠ¶å›¾é€‰ä¸­çŠ¶æ€ */
        .chart-bar.selected {
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.5);
            border: 2px solid #007aff;
        }
        
        /* æ»‘åŠ¨åˆ é™¤æ ·å¼ */
        .records-item-container {
            position: relative;
            overflow: hidden;
            margin: 5px 0;
            border-radius: 5px;
        }
        
        .records-item {
            position: relative;
            z-index: 2;
            transition: transform 0.3s ease;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ff4444;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .records-item.swiped {
            transform: translateX(-80px);
        }
        
        .delete-button {
            position: absolute;
            right: 0;
            top: 0;
            width: 80px;
            height: 100%;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1;
            border-radius: 0 5px 5px 0;
            box-shadow: inset 2px 0 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .delete-button:hover {
            background: linear-gradient(135deg, #cc0000, #990000);
        }
        
        .delete-button:active {
            transform: scale(0.95);
        }
        
        /* æ»‘åŠ¨æç¤º */
        .swipe-hint {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 3;
        }
        
        .records-item-container:hover .swipe-hint {
            opacity: 1;
        }
        
        /* æ»‘åŠ¨æ—¶çš„è§†è§‰åé¦ˆ */
        .records-item.swiping {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* é€‚é…æ¡†æ¶é¡µé¢ */
        .stats-container {
            padding-bottom: 20px; /* å‡å°‘åº•éƒ¨é—´è· */
        }

        /* mescrollæ ·å¼ */
        .mescroll {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: auto;
        }
        
        .mescroll-body {
            position: relative;
            /* height: 100%; */
            /* overflow: hidden; */
        }
        
        .mescroll-body .stats-container {
            padding-bottom: 0;
            min-height: 100vh;
        }

        /* è‡ªå®šä¹‰ä¸‹æ‹‰åˆ·æ–°æ ·å¼ */
        .mescroll-downwarp {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 14px;
            font-weight: 500;
        }
        
        .mescroll-downwarp .downwarp-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 0 20px;
            text-align: center;
        }
        
        .mescroll-downwarp .downwarp-tip {
            margin-left: 8px;
            font-size: 13px;
            opacity: 0.9;
        }
        
        .mescroll-downwarp .downwarp-progress {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            /* display: none; é»˜è®¤éšè—è¿™ä¸ªè½¬åœˆåŠ¨ç”» */
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å¼¹çª—åŠ¨ç”» */
        .dialog-fade {
            opacity: 0;
            transform: scale(0.96);
            transition: opacity 0.25s cubic-bezier(.4,0,.2,1), transform 0.25s cubic-bezier(.4,0,.2,1);
        }
        .dialog-fade.show {
            opacity: 1;
            transform: scale(1);
        }


    </style>
</head>
<body>
<!-- mescrollå®¹å™¨ -->
<div id="mescroll" class="mescroll">
    <div class="mescroll-body">
        <div class="stats-container" id="statsContainer">
            <div class="stats-header">
                <h2 style="margin: 0;" id="pageTitle">å¹´åº¦è¿åœè­¦æŠ¥ç»Ÿè®¡</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="yearSelector" onchange="changeYear(this.value)" style="padding: 5px; border: none; border-radius: 3px; background: white; color: #333;">
                        <!-- å¹´ä»½é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </select>
                    <button onclick="goBack()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">Ã—</button>
                </div>
            </div>
            
            <div class="stats-content" style="padding: 15px;">
                <div class="stats-summary" style="background: #f8f8f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #333;">ç»Ÿè®¡æ¦‚è§ˆ</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #ff4444;" id="totalAlerts">0</div>
                            <div style="font-size: 12px; color: #666;">æ€»è­¦æŠ¥æ¬¡æ•°</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #007aff;" id="avgPerMonth">0</div>
                            <div style="font-size: 12px; color: #666;">æœˆå¹³å‡æ¬¡æ•°</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #44aa44;" id="maxMonth">0</div>
                            <div style="font-size: 12px; color: #666;">æœ€é«˜æœˆæ¬¡æ•°</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #ff8800;" id="lastAlert">-</div>
                            <div style="font-size: 12px; color: #666;">æœ€è¿‘è­¦æŠ¥</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-risk" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <h3 style="margin-top: 0; color: #856404;">é£é™©åˆ†æ</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: #dc3545;" id="maxConsecutiveDays">0</div>
                            <div style="font-size: 12px; color: #666;">æœ€é•¿è¿ç»­å¤©æ•°</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: #6f42c1;" id="avgInterval">-</div>
                            <div style="font-size: 12px; color: #666;">å¹³å‡é—´éš”(å¤©)</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: #fd7e14;" id="trendStatus">-</div>
                            <div style="font-size: 12px; color: #666;">è¿‘æœŸè¶‹åŠ¿</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: #20c997;" id="riskLevel">-</div>
                            <div style="font-size: 12px; color: #666;">é£é™©ç­‰çº§</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-pattern" style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
                    <h3 style="margin-top: 0; color: #0c5460;">è¡Œä¸ºæ¨¡å¼ <span style="font-size: 12px; color: #666; font-weight: normal;">(ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</span></h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" 
                             onclick="showPatternDetail('weekday')" 
                             onmouseover="this.style.transform='scale(1.02)'" 
                             onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 18px; font-weight: bold; color: #495057;" id="peakWeekday">-</div>
                            <div style="font-size: 12px; color: #666;">æœ€é¢‘ç¹æ˜ŸæœŸ</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" 
                             onclick="showPatternDetail('hour')" 
                             onmouseover="this.style.transform='scale(1.02)'" 
                             onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 18px; font-weight: bold; color: #495057;" id="peakHour">-</div>
                            <div style="font-size: 12px; color: #666;">æœ€é¢‘ç¹æ—¶æ®µ</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" 
                             onclick="showPatternDetail('month')" 
                             onmouseover="this.style.transform='scale(1.02)'" 
                             onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 18px; font-weight: bold; color: #495057;" id="peakMonth">-</div>
                            <div style="font-size: 12px; color: #666;">æœ€é¢‘ç¹æœˆä»½</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" 
                             onclick="showPatternDetail('prediction')" 
                             onmouseover="this.style.transform='scale(1.02)'" 
                             onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 18px; font-weight: bold; color: #495057;" id="nextPrediction">-</div>
                            <div style="font-size: 12px; color: #666;">é¢„æµ‹ä¸‹æ¬¡</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-advice" style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                    <h3 style="margin-top: 0; color: #155724;">æ™ºèƒ½å»ºè®®</h3>
                    <div id="smartAdvice" style="background: white; padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <!-- æ™ºèƒ½å»ºè®®å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="stats-charts" style="margin-bottom: 20px;">
                    <h3 style="color: #333;">æœˆåº¦è¶‹åŠ¿ <span style="font-size: 12px; color: #666; font-weight: normal;">(ç‚¹å‡»æŸ±å­æŸ¥çœ‹è¯¦æƒ…)</span></h3>
                    <div id="monthlyChart" style="height: 200px; background: #f8f8f8; border-radius: 8px; display: flex; align-items: end; justify-content: space-around; padding: 20px;">
                        <!-- æœˆåº¦æŸ±çŠ¶å›¾å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="stats-charts" style="margin-bottom: 20px;">
                    <h3 style="color: #333;">æ˜ŸæœŸåˆ†å¸ƒ <span style="font-size: 12px; color: #666; font-weight: normal;">(ç‚¹å‡»æŸ±å­æŸ¥çœ‹è¯¦æƒ…)</span></h3>
                    <div id="weekdayChart" style="height: 200px; background: #f8f8f8; border-radius: 8px; display: flex; align-items: end; justify-content: space-around; padding: 20px;">
                        <!-- æ˜ŸæœŸæŸ±çŠ¶å›¾å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="stats-charts" style="margin-bottom: 20px;">
                    <h3 style="color: #333;">æ—¶æ®µåˆ†å¸ƒ <span style="font-size: 12px; color: #666; font-weight: normal;">(ç‚¹å‡»æŸ±å­æŸ¥çœ‹è¯¦æƒ…)</span></h3>
                    <div id="timeChart" style="height: 200px; background: #f8f8f8; border-radius: 8px; display: flex; align-items: end; justify-content: space-around; padding: 20px;">
                        <!-- æ—¶æ®µæŸ±çŠ¶å›¾å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="stats-actions" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn" onclick="exportStatistics()" style="flex: 1;">å¯¼å‡ºæ•°æ®</button>
                    <button class="btn btn-success" onclick="shareStatistics()" style="flex: 1;">åˆ†äº«ç»Ÿè®¡</button>
                    <button class="btn" onclick="toggleMultiSelect()" style="flex: 1;" id="multiSelectBtn">å¤šé€‰åˆ é™¤</button>
                    <button class="btn btn-danger" onclick="clearStatistics()" style="flex: 1;">æ¸…ç©ºè®°å½•</button>
                </div>
                
                <div id="multiSelectActions" style="display: none; margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn" onclick="selectAllRecords()" style="flex: 1;">å…¨é€‰</button>
                        <button class="btn" onclick="deselectAllRecords()" style="flex: 1;">å–æ¶ˆå…¨é€‰</button>
                        <button class="btn btn-danger" onclick="deleteSelectedRecords()" style="flex: 1;">åˆ é™¤é€‰ä¸­</button>
                    </div>
                    <div style="text-align: center; color: #666; font-size: 12px;">
                        å·²é€‰æ‹© <span id="selectedCount">0</span> æ¡è®°å½•
                    </div>
                    <div style="text-align: center; color: #999; font-size: 11px; margin-top: 5px;">
                        æç¤ºï¼šé•¿æŒ‰è®°å½•é¡¹å¯è¿›å…¥å¤šé€‰æ¨¡å¼ï¼Œæ»‘åŠ¨æ—¶ä¸ä¼šè§¦å‘å¤šé€‰
                    </div>
                </div>
                
                <div class="stats-list">
                    <h3 style="color: #333;">è¯¦ç»†è®°å½• <span style="font-size: 12px; color: #666; font-weight: normal;">(å·¦æ»‘åˆ é™¤ | é•¿æŒ‰å¤šé€‰)</span></h3>
                             <div id="recordsList" style="max-height: 500px; overflow-y: auto;">
                     <!-- è¯¦ç»†è®°å½•å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                 </div>
             </div>
         </div>
     </div>
 </div>

<!-- å›¾è¡¨æ‚¬æµ®æç¤ºæ¡† -->
<div id="chartTooltip" class="chart-tooltip"></div>

<script src="../script/api.js"></script>
<script>
    var alertRecords = []; // è­¦æŠ¥è®°å½•æ•°ç»„
    var currentYear = new Date().getFullYear(); // å½“å‰å¹´ä»½
    var isMultiSelectMode = false; // æ˜¯å¦å¤„äºå¤šé€‰æ¨¡å¼
    var selectedRecords = []; // é€‰ä¸­çš„è®°å½•IDæ•°ç»„
    var longPressTimer = null; // é•¿æŒ‰è®¡æ—¶å™¨
    var touchStartY = 0; // è§¦æ‘¸å¼€å§‹ä½ç½®
    var touchStartTime = 0; // è§¦æ‘¸å¼€å§‹æ—¶é—´
    var hasMoved = false; // æ˜¯å¦å‘ç”Ÿäº†ç§»åŠ¨
    var moveThreshold = 10; // ç§»åŠ¨é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
    var longPressThreshold = 1000; // é•¿æŒ‰é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
    var isSwipeInProgress = false; // è·Ÿè¸ªæ»‘åŠ¨çŠ¶æ€
    var justEnteredMultiSelectByLongPress = false;
    var shareAction = null; // åˆ†äº«æ¨¡å—
    var mescroll = null; // mescrollå®ä¾‹
    
    apiready = function() {
        // åˆ†äº«æ¨¡å—å¼•å…¥
        shareAction = api.require('shareAction'); 
        
        // è·å–é¡µé¢å‚æ•°
        var pageParam = api.pageParam;
        if (pageParam && pageParam.currentYear) {
            currentYear = pageParam.currentYear;
        } else {
            // å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œä½¿ç”¨å½“å‰å¹´ä»½
            currentYear = new Date().getFullYear();
        }
        
        // è®¾ç½®é¡µé¢æ ‡é¢˜
        document.getElementById('pageTitle').textContent = currentYear + 'å¹´è¿åœè­¦æŠ¥ç»Ÿè®¡';
        
        // åŠ¨æ€ç”Ÿæˆå¹´ä»½é€‰æ‹©å™¨é€‰é¡¹
        generateYearOptions();
        
        // è®¾ç½®å¹´ä»½é€‰æ‹©å™¨é»˜è®¤å€¼
        document.getElementById('yearSelector').value = currentYear;
        
        // åˆå§‹åŒ–mescroll
        initMescroll();
        
        // åŠ è½½è­¦æŠ¥è®°å½•
        loadAlertRecords();
        
        // ç”Ÿæˆç»Ÿè®¡æ•°æ®
        generateStatistics();
    };

    // åˆå§‹åŒ–mescroll
    function initMescroll() {
        mescroll = new MeScroll("mescroll", {
            isBounce: true, // å…è®¸å¼¹æ€§æ»šåŠ¨
            down: {
                auto: false, // ç¦ç”¨è‡ªåŠ¨ä¸‹æ‹‰åˆ·æ–°
                callback: function() {
                    // åªåœ¨mescrollå®¹å™¨é¡¶éƒ¨æ‰åˆ·æ–°
                    var scrollTop = document.getElementById('mescroll').scrollTop;
                    if (scrollTop <= 0) {
                        refreshDataOnly();
                    } else {
                        mescroll.endSuccess();
                    }
                },
                htmlContent: '<div class="downwarp-content"><div class="downwarp-progress"></div><div class="downwarp-tip">æ­£åœ¨åˆ·æ–°æ•°æ®...</div></div>',
                // htmlContent: '<div class="downwarp-content"><div class="downwarp-progress"></div><div class="downwarp-tip"></div></div>',
                offset: 60,
                textInOffset: 'ä¸‹æ‹‰åˆ·æ–°',
                textOutOffset: 'é‡Šæ”¾åˆ·æ–°',
                textLoading: 'æ­£åœ¨åˆ·æ–°...',
                threshold: 50
            },
            up: {
                auto: false,
                callback: function() {
                    mescroll.endSuccess();
                },
                page: {
                    num: 0,
                    size: 10,
                    time: Date.now()
                },
                htmlNodata: 'å·²ç»åˆ°åº•äº†~',
                htmlLoading: '',
                htmlError: ''
            }
        });

        // // mescrollåˆå§‹åŒ–åï¼Œå¼ºåˆ¶éšè—ä¸‹æ‹‰åˆ·æ–°åŒºåŸŸï¼Œé˜²æ­¢åˆå§‹åŒ–æ—¶æ˜¾ç¤ºåœ¨é¡¶éƒ¨
        // var downwarp = document.querySelector('.mescroll-downwarp');
        // // å…ˆéšè—ä¸‹æ‹‰åˆ·æ–°åŒºåŸŸï¼Œé˜²æ­¢åˆå§‹åŒ–æ—¶æ˜¾ç¤ºåœ¨é¡¶éƒ¨
        // if (downwarp) {
        //     downwarp.style.display = 'none';
        //     // ç›‘å¬ä¸‹æ‹‰åŠ¨ä½œï¼Œå¼€å§‹ä¸‹æ‹‰æ—¶å†æ˜¾ç¤º
        //     document.getElementById('mescroll').addEventListener('touchstart', function() {
        //         downwarp.style.display = 'block';
        //     }, { once: true });
        // }
    }
    
    // è¿”å›ä¸Šä¸€é¡µ
    function goBack() {
        console.log('è¿”å›é”®è¢«è§¦å‘ï¼Œå½“å‰å¤šé€‰æ¨¡å¼çŠ¶æ€ï¼š', isMultiSelectMode);
        
        // å¦‚æœå¤„äºå¤šé€‰æ¨¡å¼ï¼Œå…ˆé€€å‡ºå¤šé€‰æ¨¡å¼
        if (isMultiSelectMode) {
            console.log('é€€å‡ºå¤šé€‰æ¨¡å¼');
            exitMultiSelectMode();
            api.toast({
                msg: 'å·²é€€å‡ºå¤šé€‰æ¨¡å¼',
                duration: 1500,
                location: 'top'
            });
        } else {
            console.log('å…³é—­ç»Ÿè®¡é¡µé¢ï¼Œå›åˆ°é¦–é¡µ');
            // éå¤šé€‰æ¨¡å¼ä¸‹ï¼Œç›´æ¥å…³é—­frameï¼Œè®©ä¸»æ¡†æ¶å¤„ç†é¡µé¢åˆ‡æ¢
            console.log('å…³é—­ç»Ÿè®¡é¡µé¢frame');
            api.closeWin();
        }
    }
    
    // åˆ·æ–°ç»Ÿè®¡æ•°æ®ï¼ˆä¾›å¤–éƒ¨è°ƒç”¨ï¼‰
    function refreshStatisticsData(year) {
        if (year) {
            currentYear = year;
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.getElementById('pageTitle').textContent = currentYear + 'å¹´è¿åœè­¦æŠ¥ç»Ÿè®¡';
            // æ›´æ–°å¹´ä»½é€‰æ‹©å™¨
            document.getElementById('yearSelector').value = currentYear;
        }
        
        // é‡æ–°åŠ è½½è­¦æŠ¥è®°å½•
        loadAlertRecords();
        
        // é‡æ–°ç”Ÿæˆç»Ÿè®¡æ•°æ®
        generateStatistics();
        
        console.log('ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°ï¼Œå¹´ä»½ï¼š' + currentYear);
    }
    
    // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œç¡®ä¿èƒ½è¢«å¤–éƒ¨è°ƒç”¨
    window.refreshStatisticsData = refreshStatisticsData;
    window.goBack = goBack;
    window.refreshDataOnly = refreshDataOnly;
    
    // åªåˆ·æ–°æ•°æ®ï¼Œä¿æŒå½“å‰å¹´ä»½é€‰æ‹©
    function refreshDataOnly() {
        // é‡æ–°åŠ è½½è­¦æŠ¥è®°å½•ï¼ˆä½¿ç”¨å½“å‰é€‰æ‹©çš„å¹´ä»½ï¼‰
        loadAlertRecords();
        
        // é‡æ–°ç”Ÿæˆç»Ÿè®¡æ•°æ®
        generateStatistics();
        
        console.log('æ•°æ®å·²åˆ·æ–°ï¼Œå¹´ä»½ï¼š' + currentYear);
        // ç¡®ä¿åˆ·æ–°å®Œæˆåè°ƒç”¨endSuccess
        if (mescroll) {
            mescroll.endSuccess();
        }
        api.toast({
            msg: 'æ•°æ®å·²åˆ·æ–°ï¼Œå¹´ä»½ï¼š' + currentYear,
            location: 'bottom',
            duration: 2000
        });
    }
    

    
    // åŠ¨æ€ç”Ÿæˆå¹´ä»½é€‰æ‹©å™¨é€‰é¡¹
    function generateYearOptions() {
        var yearSelector = document.getElementById('yearSelector');
        var optionsHTML = '';
        
        // ç”Ÿæˆå½“å‰å¹´ä»½åŠå‰ä¸¤å¹´çš„é€‰é¡¹
        for (var i = 0; i < 3; i++) {
            var year = currentYear - i;
            var selected = i === 0 ? ' selected' : '';
            optionsHTML += '<option value="' + year + '"' + selected + '>' + year + 'å¹´</option>';
        }
        
        yearSelector.innerHTML = optionsHTML;
    }

    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è­¦æŠ¥è®°å½•
    function loadAlertRecords() {
        try {
            var savedRecords = api.getPrefs({sync: true, key: 'alertRecords_' + currentYear});
            if (savedRecords) {
                alertRecords = JSON.parse(savedRecords);
                console.log('å·²åŠ è½½' + alertRecords.length + 'æ¡è­¦æŠ¥è®°å½•');
            } else {
                alertRecords = [];
                console.log('æœªæ‰¾åˆ°å†å²è­¦æŠ¥è®°å½•');
            }
        } catch (e) {
            alertRecords = [];
            console.log('åŠ è½½è­¦æŠ¥è®°å½•å¤±è´¥: ' + e.message);
        }
    }

    // ç”Ÿæˆç»Ÿè®¡æ•°æ®
    function generateStatistics() {
        // æ¸…é™¤ç¼“å­˜
        clearCache();
        
        // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
        updateSummaryStats();
        
        // ç”Ÿæˆæœˆåº¦è¶‹åŠ¿å›¾
        generateMonthlyChart();
        
        // ç”Ÿæˆæ˜ŸæœŸåˆ†å¸ƒå›¾
        generateWeekdayChart();
        
        // ç”Ÿæˆæ—¶æ®µåˆ†å¸ƒå›¾
        generateTimeChart();
        
        // ç”Ÿæˆè¯¦ç»†è®°å½•åˆ—è¡¨
        generateRecordsList();
    }

    // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
    function updateSummaryStats() {
        var totalAlerts = alertRecords.length;
        var avgPerMonth = totalAlerts > 0 ? (totalAlerts / 12).toFixed(1) : 0;
        
        // è®¡ç®—æœ€é«˜æœˆæ¬¡æ•°
        var monthlyData = new Array(12).fill(0);
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.month >= 1 && record.month <= 12) {
                    monthlyData[record.month - 1]++;
                }
            }
        });
        var maxMonth = Math.max(...monthlyData);
        
        // è®¡ç®—æœ€è¿‘è­¦æŠ¥æ—¶é—´
        var lastAlert = '-';
        if (alertRecords.length > 0) {
            var lastRecord = getSortedRecordsDesc()[0];
            
            // è·å–å½“å‰æ—¥æœŸå’Œè®°å½•æ—¥æœŸï¼ˆåªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶é—´ï¼‰
            var now = new Date();
            var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var lastDate = new Date(lastRecord.timestamp);
            var recordDate = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
            
            // è®¡ç®—æ—¥æœŸå·®ï¼ˆæ¯«ç§’ï¼‰
            var diffTime = today.getTime() - recordDate.getTime();
            var diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                lastAlert = 'ä»Šå¤©';
            } else if (diffDays === 1) {
                lastAlert = 'æ˜¨å¤©';
            } else if (diffDays < 7) {
                lastAlert = diffDays + 'å¤©å‰';
            } else {
                lastAlert = lastRecord.date;
            }
        }
        
        document.getElementById('totalAlerts').textContent = totalAlerts;
        document.getElementById('avgPerMonth').textContent = avgPerMonth;
        document.getElementById('maxMonth').textContent = maxMonth;
        document.getElementById('lastAlert').textContent = lastAlert;
        
        // è®¡ç®—é£é™©åˆ†ææ•°æ®
        calculateRiskAnalysis();
        
        // è®¡ç®—è¡Œä¸ºæ¨¡å¼æ•°æ®
        calculateBehaviorPatterns();
        
        // ç”Ÿæˆæ™ºèƒ½å»ºè®®
        generateSmartAdvice();
    }

    // ç”Ÿæˆæœˆåº¦è¶‹åŠ¿å›¾
    function generateMonthlyChart() {
        var monthlyData = new Array(12).fill(0);
        var monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        // ç»Ÿè®¡æ¯æœˆè­¦æŠ¥æ¬¡æ•°
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.month >= 1 && record.month <= 12) {
                    monthlyData[record.month - 1]++;
                }
            }
        });
        var maxValue = Math.max(...monthlyData);
        var chartHTML = '';
        monthlyData.forEach(function(count, index) {
            var height = maxValue > 0 ? (count / maxValue * 150) : 0;
            var color = count > 0 ? '#ff4444' : '#ddd';
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end;">
                    <div style="font-size: 10px; color: #666; margin-bottom: 2px; font-weight: bold;">${count}</div>
                    <div class="chart-bar" style="width: 20px; height: 0px; background: ${color}; border-radius: 3px; margin-bottom: 2px; transition: height 0.8s ease; cursor: pointer;" 
                         title="${monthNames[index]}: ${count}æ¬¡" 
                         data-height="${height}"
                         data-month="${monthNames[index]}"
                         data-count="${count}"
                         onclick="showChartTooltip(event, '${monthNames[index]}', ${count}, 'æœˆåº¦è¶‹åŠ¿')"></div>
                    <div style="font-size: 10px; color: #666; margin-top: 2px;">${monthNames[index]}</div>
                </div>
            `;
        });
        document.getElementById('monthlyChart').innerHTML = chartHTML;
        setTimeout(function() {
            var bars = document.querySelectorAll('#monthlyChart .chart-bar');
            bars.forEach(function(bar) {
                var height = bar.getAttribute('data-height');
                bar.style.height = height + 'px';
            });
        }, 100);
    }

    // ç”Ÿæˆæ˜ŸæœŸåˆ†å¸ƒå›¾
    function generateWeekdayChart() {
        var weekdayData = new Array(7).fill(0);
        var weekdayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.weekday >= 0 && record.weekday < 7) {
                    weekdayData[record.weekday]++;
                }
            }
        });
        var maxValue = Math.max(...weekdayData);
        var chartHTML = '';
        weekdayData.forEach(function(count, index) {
            var height = maxValue > 0 ? (count / maxValue * 150) : 0;
            var color = count > 0 ? '#007aff' : '#ddd';
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end;">
                    <div style="font-size: 10px; color: #666; margin-bottom: 2px; font-weight: bold;">${count}</div>
                    <div class="chart-bar" style="width: 20px; height: 0px; background: ${color}; border-radius: 3px; margin-bottom: 2px; transition: height 0.8s ease; cursor: pointer;" 
                         title="${weekdayNames[index]}: ${count}æ¬¡" 
                         data-height="${height}"
                         data-weekday="${weekdayNames[index]}"
                         data-count="${count}"
                         onclick="showChartTooltip(event, '${weekdayNames[index]}', ${count}, 'æ˜ŸæœŸåˆ†å¸ƒ')"></div>
                    <div style="font-size: 10px; color: #666; margin-top: 2px;">${weekdayNames[index]}</div>
                </div>
            `;
        });
        document.getElementById('weekdayChart').innerHTML = chartHTML;
        setTimeout(function() {
            var bars = document.querySelectorAll('#weekdayChart .chart-bar');
            bars.forEach(function(bar) {
                var height = bar.getAttribute('data-height');
                bar.style.height = height + 'px';
            });
        }, 200);
    }

    // è®¡ç®—é£é™©åˆ†ææ•°æ®
    function calculateRiskAnalysis() {
        if (alertRecords.length === 0) {
            document.getElementById('maxConsecutiveDays').textContent = '0';
            document.getElementById('avgInterval').textContent = '-';
            document.getElementById('trendStatus').textContent = '-';
            document.getElementById('riskLevel').textContent = '-';
            return;
        }
        
        // 1. è®¡ç®—æœ€é•¿è¿ç»­å¤©æ•°
        var maxConsecutiveDays = calculateMaxConsecutiveDays();
        
        // 2. è®¡ç®—å¹³å‡é—´éš”
        var avgInterval = calculateAverageInterval();
        
        // 3. è®¡ç®—è¿‘æœŸè¶‹åŠ¿
        var trendStatus = calculateTrendStatus();
        
        // 4. è®¡ç®—é£é™©ç­‰çº§
        var riskLevel = calculateRiskLevel();
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('maxConsecutiveDays').textContent = maxConsecutiveDays;
        document.getElementById('avgInterval').textContent = avgInterval;
        document.getElementById('trendStatus').textContent = trendStatus;
        document.getElementById('riskLevel').textContent = riskLevel;
        
        // ä¿å­˜è®¡ç®—ç»“æœä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        window.riskAnalysisData = {
            maxConsecutiveDays: maxConsecutiveDays,
            avgInterval: avgInterval,
            trendStatus: trendStatus,
            riskLevel: riskLevel
        };
    }
    
    // è·å–æŒ‰æ—¶é—´æ’åºçš„è®°å½•ï¼ˆç¼“å­˜ç»“æœï¼‰
    function getSortedRecords() {
        if (!window.sortedRecordsCache) {
            window.sortedRecordsCache = alertRecords.slice().sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });
        }
        return window.sortedRecordsCache;
    }
    
    // è·å–æŒ‰æ—¶é—´å€’åºæ’åºçš„è®°å½•ï¼ˆç¼“å­˜ç»“æœï¼‰
    function getSortedRecordsDesc() {
        if (!window.sortedRecordsDescCache) {
            window.sortedRecordsDescCache = alertRecords.slice().sort(function(a, b) {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
        }
        return window.sortedRecordsDescCache;
    }
    
    // æ¸…é™¤ç¼“å­˜ï¼ˆåœ¨æ•°æ®æ›´æ–°æ—¶è°ƒç”¨ï¼‰
    function clearCache() {
        window.sortedRecordsCache = null;
        window.sortedRecordsDescCache = null;
        window.riskAnalysisData = null;
        window.behaviorPatternData = null;
    }
    
    // è®¡ç®—æ—¥æœŸå·®ï¼ˆé€šç”¨å‡½æ•°ï¼‰
    function calculateDaysDifference(timestamp) {
        var now = new Date();
        var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        var recordDate = new Date(timestamp);
        var recordDay = new Date(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate());
        
        var diffTime = today.getTime() - recordDay.getTime();
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    }
    
    // è®¡ç®—æœ€é•¿è¿ç»­å¤©æ•°
    function calculateMaxConsecutiveDays() {
        if (alertRecords.length < 2) return 1;
        
        var sortedRecords = getSortedRecords();
        
        var maxConsecutive = 1;
        var currentConsecutive = 1;
        
        for (var i = 1; i < sortedRecords.length; i++) {
            var prevDate = new Date(sortedRecords[i-1].timestamp);
            var currDate = new Date(sortedRecords[i].timestamp);
            
            var prevDay = new Date(prevDate.getFullYear(), prevDate.getMonth(), prevDate.getDate());
            var currDay = new Date(currDate.getFullYear(), currDate.getMonth(), currDate.getDate());
            
            var diffDays = Math.floor((currDay.getTime() - prevDay.getTime()) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                currentConsecutive++;
                maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
            } else {
                currentConsecutive = 1;
            }
        }
        
        return maxConsecutive;
    }
    
    // è®¡ç®—å¹³å‡é—´éš”
    function calculateAverageInterval() {
        if (alertRecords.length < 2) return '-';
        
        var sortedRecords = getSortedRecords();
        
        var totalInterval = 0;
        var intervalCount = 0;
        
        for (var i = 1; i < sortedRecords.length; i++) {
            var prevDate = new Date(sortedRecords[i-1].timestamp);
            var currDate = new Date(sortedRecords[i].timestamp);
            
            var prevDay = new Date(prevDate.getFullYear(), prevDate.getMonth(), prevDate.getDate());
            var currDay = new Date(currDate.getFullYear(), currDate.getMonth(), currDate.getDate());
            
            var diffDays = Math.floor((currDay.getTime() - prevDay.getTime()) / (1000 * 60 * 60 * 24));
            
            if (diffDays > 0) {
                totalInterval += diffDays;
                intervalCount++;
            }
        }
        
        return intervalCount > 0 ? Math.round(totalInterval / intervalCount) : '-';
    }
    
    // è®¡ç®—è¿‘æœŸè¶‹åŠ¿
    function calculateTrendStatus() {
        if (alertRecords.length < 4) return 'æ•°æ®ä¸è¶³';
        
        var sortedRecords = getSortedRecords();
        
        // è·å–æœ€è¿‘30å¤©çš„è®°å½•
        var now = new Date();
        var thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        var recentRecords = sortedRecords.filter(function(record) {
            return new Date(record.timestamp) >= thirtyDaysAgo;
        });
        
        var previousRecords = sortedRecords.filter(function(record) {
            var recordDate = new Date(record.timestamp);
            return recordDate >= new Date(thirtyDaysAgo.getTime() - 30 * 24 * 60 * 60 * 1000) && recordDate < thirtyDaysAgo;
        });
        
        if (recentRecords.length === 0 && previousRecords.length === 0) {
            return 'æ— å˜åŒ–';
        }
        
        if (recentRecords.length > previousRecords.length) {
            return 'ä¸Šå‡';
        } else if (recentRecords.length < previousRecords.length) {
            return 'ä¸‹é™';
        } else {
            return 'ç¨³å®š';
        }
    }
    
    // è®¡ç®—é£é™©ç­‰çº§
    function calculateRiskLevel() {
        if (alertRecords.length === 0) return '-';
        
        var totalAlerts = alertRecords.length;
        var avgPerMonth = totalAlerts / 12;
        var maxConsecutive = calculateMaxConsecutiveDays();
        
        if (avgPerMonth >= 5 || maxConsecutive >= 3) {
            return 'é«˜é£é™©';
        } else if (avgPerMonth >= 3 || maxConsecutive >= 2) {
            return 'ä¸­é£é™©';
        } else if (avgPerMonth >= 1) {
            return 'ä½é£é™©';
        } else {
            return 'å®‰å…¨';
        }
    }
    
    // è®¡ç®—è¡Œä¸ºæ¨¡å¼æ•°æ®
    function calculateBehaviorPatterns() {
        if (alertRecords.length === 0) {
            document.getElementById('peakWeekday').textContent = '-';
            document.getElementById('peakHour').textContent = '-';
            document.getElementById('peakMonth').textContent = '-';
            document.getElementById('nextPrediction').textContent = '-';
            return;
        }
        
        // 1. æœ€é¢‘ç¹æ˜ŸæœŸ
        var peakWeekday = calculatePeakWeekday();
        
        // 2. æœ€é¢‘ç¹æ—¶æ®µ
        var peakHour = calculatePeakHour();
        
        // 3. æœ€é¢‘ç¹æœˆä»½
        var peakMonth = calculatePeakMonth();
        
        // 4. é¢„æµ‹ä¸‹æ¬¡
        var nextPrediction = calculateNextPrediction();
        
        // æ›´æ–°æ˜¾ç¤º
        document.getElementById('peakWeekday').textContent = peakWeekday;
        document.getElementById('peakHour').textContent = peakHour;
        document.getElementById('peakMonth').textContent = peakMonth;
        document.getElementById('nextPrediction').textContent = nextPrediction;
        
        // ä¿å­˜è®¡ç®—ç»“æœä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        window.behaviorPatternData = {
            peakWeekday: peakWeekday,
            peakHour: peakHour,
            peakMonth: peakMonth,
            nextPrediction: nextPrediction
        };
    }
    
    // è®¡ç®—æœ€é¢‘ç¹æ˜ŸæœŸ
    function calculatePeakWeekday() {
        var weekdayCounts = new Array(7).fill(0);
        var weekdayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        
        alertRecords.forEach(function(record) {
            if (record.weekday >= 0 && record.weekday < 7) {
                weekdayCounts[record.weekday]++;
            }
        });
        
        var maxIndex = weekdayCounts.indexOf(Math.max(...weekdayCounts));
        return weekdayNames[maxIndex];
    }
    
    // è®¡ç®—æœ€é¢‘ç¹æ—¶æ®µ
    function calculatePeakHour() {
        var hourCounts = new Array(24).fill(0);
        
        alertRecords.forEach(function(record) {
            var hour = parseInt(record.time.split(':')[0]);
            if (!isNaN(hour) && hour >= 0 && hour < 24) {
                hourCounts[hour]++;
            }
        });
        
        var maxIndex = hourCounts.indexOf(Math.max(...hourCounts));
        return maxIndex + 'æ—¶';
    }
    
    // è®¡ç®—æœ€é¢‘ç¹æœˆä»½
    function calculatePeakMonth() {
        var monthCounts = new Array(12).fill(0);
        var monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        
        alertRecords.forEach(function(record) {
            if (record.month >= 1 && record.month <= 12) {
                monthCounts[record.month - 1]++;
            }
        });
        
        var maxIndex = monthCounts.indexOf(Math.max(...monthCounts));
        return monthNames[maxIndex];
    }
    
    // è®¡ç®—é¢„æµ‹ä¸‹æ¬¡
    function calculateNextPrediction() {
        if (alertRecords.length < 2) return '-';
        
        var avgInterval = calculateAverageInterval();
        if (avgInterval === '-') return '-';
        
        var lastRecord = getSortedRecordsDesc()[0];
        
        var lastDate = new Date(lastRecord.timestamp);
        var predictedDate = new Date(lastDate.getTime() + avgInterval * 24 * 60 * 60 * 1000);
        
        var now = new Date();
        var diffDays = Math.floor((predictedDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            return 'å·²é€¾æœŸ';
        } else if (diffDays === 0) {
            return 'ä»Šå¤©';
        } else if (diffDays === 1) {
            return 'æ˜å¤©';
        } else if (diffDays < 7) {
            return diffDays + 'å¤©å';
        } else {
            return predictedDate.getMonth() + 1 + 'æœˆ' + predictedDate.getDate() + 'æ—¥';
        }
    }
    
    // ç”Ÿæˆæ™ºèƒ½å»ºè®®
    function generateSmartAdvice() {
        if (alertRecords.length === 0) {
            document.getElementById('smartAdvice').innerHTML = '<p style="color: #666; text-align: center; margin: 0;">æš‚æ— æ•°æ®ï¼Œæ— æ³•ç”Ÿæˆå»ºè®®</p>';
            return;
        }
        
        var advice = [];
        
        // ä½¿ç”¨ç¼“å­˜çš„é£é™©åˆ†ææ•°æ®
        var riskData = window.riskAnalysisData || {};
        var behaviorData = window.behaviorPatternData || {};
        
        // åŸºäºé£é™©ç­‰çº§çš„å»ºè®®
        var riskLevel = riskData.riskLevel || calculateRiskLevel();
        if (riskLevel === 'é«˜é£é™©') {
            advice.push('âš ï¸ <strong>é«˜é£é™©æé†’</strong>ï¼šæ‚¨çš„è¿ç« é¢‘ç‡è¾ƒé«˜ï¼Œå»ºè®®ç«‹å³è°ƒæ•´é©¾é©¶ä¹ æƒ¯ï¼Œé¿å…è¿ç»­è¿ç« ã€‚');
        } else if (riskLevel === 'ä¸­é£é™©') {
            advice.push('âš ï¸ <strong>ä¸­é£é™©æé†’</strong>ï¼šæ‚¨çš„è¿ç« é¢‘ç‡ä¸­ç­‰ï¼Œå»ºè®®æ³¨æ„é©¾é©¶è§„èŒƒï¼Œå‡å°‘è¿ç« å‘ç”Ÿã€‚');
        }
        
        // åŸºäºè¿ç»­å¤©æ•°çš„å»ºè®®
        var maxConsecutive = riskData.maxConsecutiveDays || calculateMaxConsecutiveDays();
        if (maxConsecutive >= 3) {
            advice.push('ğŸš¨ <strong>è¿ç»­è¿ç« è­¦å‘Š</strong>ï¼šæ‚¨æ›¾è¿ç»­' + maxConsecutive + 'å¤©è¿ç« ï¼Œè¯·ç‰¹åˆ«æ³¨æ„é¿å…è¿ç»­è¿ç« è¡Œä¸ºã€‚');
        }
        
        // åŸºäºæ—¶é—´æ¨¡å¼çš„å»ºè®®
        var peakWeekday = behaviorData.peakWeekday || calculatePeakWeekday();
        var peakHour = behaviorData.peakHour || calculatePeakHour();
        advice.push('ğŸ“… <strong>æ—¶é—´æé†’</strong>ï¼šæ‚¨åœ¨' + peakWeekday + peakHour + 'æœ€å®¹æ˜“è¿ç« ï¼Œè¯·åœ¨è¿™äº›æ—¶æ®µç‰¹åˆ«æ³¨æ„ã€‚');
        
        // åŸºäºè¶‹åŠ¿çš„å»ºè®®
        var trendStatus = riskData.trendStatus || calculateTrendStatus();
        if (trendStatus === 'ä¸Šå‡') {
            advice.push('ğŸ“ˆ <strong>è¶‹åŠ¿æé†’</strong>ï¼šæ‚¨çš„è¿ç« é¢‘ç‡å‘ˆä¸Šå‡è¶‹åŠ¿ï¼Œå»ºè®®åŠ å¼ºå®‰å…¨æ„è¯†ã€‚');
        } else if (trendStatus === 'ä¸‹é™') {
            advice.push('ğŸ“‰ <strong>è¿›æ­¥æé†’</strong>ï¼šæ‚¨çš„è¿ç« é¢‘ç‡å‘ˆä¸‹é™è¶‹åŠ¿ï¼Œç»§ç»­ä¿æŒï¼');
        }
        
        // åŸºäºé¢„æµ‹çš„å»ºè®®
        var nextPrediction = behaviorData.nextPrediction || calculateNextPrediction();
        if (nextPrediction !== '-' && nextPrediction !== 'å·²é€¾æœŸ') {
            advice.push('ğŸ”® <strong>é¢„æµ‹æé†’</strong>ï¼šæ ¹æ®å†å²æ•°æ®ï¼Œä¸‹æ¬¡å¯èƒ½è¿ç« æ—¶é—´åœ¨' + nextPrediction + 'ï¼Œè¯·æå‰æ³¨æ„ã€‚');
        }
        
        // é€šç”¨å»ºè®®
        advice.push('ğŸ’¡ <strong>é€šç”¨å»ºè®®</strong>ï¼šéµå®ˆäº¤é€šè§„åˆ™ï¼Œä¿æŒå®‰å…¨è½¦è·ï¼Œé¿å…ç–²åŠ³é©¾é©¶ã€‚');
        
        // ç”ŸæˆHTML
        var adviceHTML = '';
        advice.forEach(function(item) {
            adviceHTML += '<p style="margin: 8px 0; line-height: 1.5;">' + item + '</p>';
        });
        
        document.getElementById('smartAdvice').innerHTML = adviceHTML;
    }

    // ç”Ÿæˆæ—¶æ®µåˆ†å¸ƒå›¾
    function generateTimeChart() {
        var timeData = new Array(24).fill(0);
        var timeLabels = [];
        for (var i = 0; i < 24; i++) {
            timeLabels.push(i + 'æ—¶');
        }
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                var hour = parseInt(record.time.split(':')[0]);
                if (!isNaN(hour) && hour >= 0 && hour < 24) {
                    timeData[hour]++;
                }
            }
        });
        var maxValue = Math.max(...timeData);
        var chartHTML = '';
        var nonZeroData = timeData.map(function(count, index) {
            return { count: count, hour: index };
        }).filter(function(item) {
            return item.count > 0;
        });
        if (nonZeroData.length > 12) {
            var groupedData = [];
            var groupSize = Math.ceil(nonZeroData.length / 12);
            for (var i = 0; i < nonZeroData.length; i += groupSize) {
                var group = nonZeroData.slice(i, i + groupSize);
                var totalCount = group.reduce(function(sum, item) { return sum + item.count; }, 0);
                var avgHour = Math.round(group.reduce(function(sum, item) { return sum + item.hour; }, 0) / group.length);
                groupedData.push({ count: totalCount, hour: avgHour });
            }
            nonZeroData = groupedData;
        }
        nonZeroData.forEach(function(item) {
            var height = maxValue > 0 ? (item.count / maxValue * 150) : 0;
            var color = '#44aa44';
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end;">
                    <div style="font-size: 10px; color: #666; margin-bottom: 2px; font-weight: bold;">${item.count}</div>
                    <div class="chart-bar" style="width: 15px; height: 0px; background: ${color}; border-radius: 3px; margin-bottom: 2px; transition: height 0.8s ease; cursor: pointer;" 
                         title="${item.hour}æ—¶: ${item.count}æ¬¡" 
                         data-height="${height}"
                         data-hour="${item.hour}"
                         data-count="${item.count}"
                         onclick="showChartTooltip(event, '${item.hour}æ—¶', ${item.count}, 'æ—¶æ®µåˆ†å¸ƒ')"></div>
                    <div style="font-size: 8px; color: #666; margin-top: 2px;">${item.hour}æ—¶</div>
                </div>
            `;
        });
        document.getElementById('timeChart').innerHTML = chartHTML;
        setTimeout(function() {
            var bars = document.querySelectorAll('#timeChart .chart-bar');
            bars.forEach(function(bar) {
                var height = bar.getAttribute('data-height');
                bar.style.height = height + 'px';
                // è®©æŸ±çŠ¶å›¾æ”¯æŒæ»‘åŠ¨å†’æ³¡åˆ°mescroll
                bar.addEventListener('touchstart', function(e) { /* ä¸é˜»æ­¢å†’æ³¡ */ });
                bar.addEventListener('touchmove', function(e) { /* ä¸é˜»æ­¢å†’æ³¡ */ });
                bar.addEventListener('touchend', function(e) { /* ä¸é˜»æ­¢å†’æ³¡ */ });
            });
        }, 300);
    }

    // ç”Ÿæˆè¯¦ç»†è®°å½•åˆ—è¡¨
    function generateRecordsList() {
        var recordsList = document.getElementById('recordsList');
        var recordsHTML = '';
        
        if (alertRecords.length === 0) {
            recordsHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è­¦æŠ¥è®°å½•</div>';
        } else {
                    // æŒ‰æ—¶é—´å€’åºæ’åˆ—
        var sortedRecords = getSortedRecordsDesc();
            
            sortedRecords.forEach(function(record) {
                var date = new Date(record.timestamp);
                var weekdayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                
                // æˆªå–çŸ­ä¿¡å†…å®¹ï¼Œé¿å…è¿‡é•¿
                var shortContent = record.content.length > 50 ? record.content.substring(0, 50) + '...' : record.content;
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºæµ‹è¯•è®°å½•ï¼šæµ‹è¯•è®°å½•ä¸ºæµ…ç°è‰²ï¼Œæ­£å¸¸è®°å½•ä¸ºé»‘è‰²ï¼Œé¢œè‰²åŒºåˆ†ä¾¿äºé˜…è¯»
                var isTestRecord = record.content.indexOf('æµ‹è¯•') !== -1 || record.content.indexOf('TEST') !== -1 || record.content.indexOf('Test') !== -1;
                var textColor = isTestRecord ? '#999' : '#333'; // æµ‹è¯•è®°å½•ä¸ºæµ…ç°è‰²ï¼Œæ­£å¸¸è®°å½•ä¸ºé»‘è‰²
                var bgColor = isTestRecord ? '#f0f0f0' : '#f8f8f8'; // æµ‹è¯•è®°å½•èƒŒæ™¯è‰²ç¨æµ…
                var borderColor = isTestRecord ? '#ccc' : '#ff4444'; // æµ‹è¯•è®°å½•è¾¹æ¡†ä¸ºç°è‰²
                
                var isSelected = selectedRecords.indexOf(record.id.toString()) !== -1;
                var selectionStyle = isSelected ? 'background: #007aff; color: white;' : '';
                var selectionIcon = isSelected ? 'âœ“' : '';
                
                // å…è®¸é€šè¿‡é•¿æŒ‰è§¦å‘å¤šé€‰åˆ é™¤ï¼ŒåŒæ—¶æ”¯æŒæ»‘åŠ¨åˆ é™¤
                recordsHTML += `
                    <div class="records-item-container">
                        <div class="records-item${isSelected ? ' selected' : ''}" 
                             style="background: ${bgColor}; border-left: 4px solid ${borderColor};" 
                             data-record-id="${record.id}"
                             data-touch-start-x="0"
                             data-touch-start-y="0"
                             data-touch-current-x="0"
                             data-touch-current-y="0"
                             data-is-touching="false"
                             data-swipe-threshold="50"
                             onclick="handleRecordClick('${record.id}')"
                             onmousedown="handleMouseDown(event, '${record.id}')"
                             onmousemove="handleMouseMove(event)"
                             onmouseup="handleMouseUp(event, '${record.id}')"
                             onmouseleave="handleMouseLeave()">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="font-weight: bold; color: ${textColor};">${record.date} ${record.time}</div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="font-size: 12px; color: ${isTestRecord ? '#999' : '#666'};">${weekdayNames[record.weekday]}</div>
                                    ${isMultiSelectMode ? `<div class="selection-box" 
                                        style="width: 24px; height: 24px; border: 2px solid #007aff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-left: 10px; z-index: 1000; position: relative; cursor: pointer; ${selectionStyle}" 
                                        onclick="event.stopPropagation(); toggleRecordSelection('${record.id}');"
                                        onmousedown="event.stopPropagation();"
                                        onmouseup="event.stopPropagation();">${selectionIcon}</div>` : ''}
                                </div>
                            </div>
                            <div style="font-size: 12px; color: ${isTestRecord ? '#999' : '#666'}; margin-bottom: 5px;">æ¥è‡ª: ${record.phoneNumber}</div>
                            <div style="font-size: 12px; color: ${textColor}; line-height: 1.4; word-break: break-all;">${shortContent}</div>
                        </div>
                        <div class="delete-button" onclick="deleteSingleRecord('${record.id}')">
                            åˆ é™¤
                        </div>
                        ${!isMultiSelectMode ? '<div class="swipe-hint">â† å·¦æ»‘åˆ é™¤</div>' : ''}
                    </div>
                `;
            });
        }
        
        recordsList.innerHTML = recordsHTML;
        
        // ç»‘å®šè§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨
        bindTouchEvents();
    }

    // ç»‘å®šè§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶ç›‘å¬å™¨
    function bindTouchEvents() {
        var recordItems = document.querySelectorAll('.records-item');
        recordItems.forEach(function(item) {
            // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
            item.removeEventListener('touchstart', handleTouchStart);
            item.removeEventListener('touchmove', handleTouchMove);
            item.removeEventListener('touchend', handleTouchEnd);
            item.removeEventListener('mousedown', handleMouseDownForSwipe);
            item.removeEventListener('mousemove', handleMouseMoveForSwipe);
            item.removeEventListener('mouseup', handleMouseUpForSwipe);
            item.removeEventListener('mouseleave', handleMouseLeaveForSwipe);
            
            // æ·»åŠ è§¦æ‘¸äº‹ä»¶ç›‘å¬å™¨ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼
            item.addEventListener('touchstart', handleTouchStart, { passive: true });
            item.addEventListener('touchmove', handleTouchMove, { passive: false });
            item.addEventListener('touchend', handleTouchEnd, { passive: true });
            
            // æ·»åŠ é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨ï¼ˆç”¨äºæ¡Œé¢ç«¯ï¼‰
            item.addEventListener('mousedown', handleMouseDownForSwipe, { passive: true });
            item.addEventListener('mousemove', handleMouseMoveForSwipe, { passive: true });
            item.addEventListener('mouseup', handleMouseUpForSwipe, { passive: true });
            item.addEventListener('mouseleave', handleMouseLeaveForSwipe, { passive: true });
        });
    }

    // åˆ‡æ¢å¹´ä»½
    function changeYear(year) {
        currentYear = parseInt(year);
        
        // æ›´æ–°æ ‡é¢˜
        document.getElementById('pageTitle').textContent = currentYear + 'å¹´è¿åœè­¦æŠ¥ç»Ÿè®¡';
        
        // é‡æ–°ç”Ÿæˆå¹´ä»½é€‰æ‹©å™¨é€‰é¡¹ï¼ˆä¿æŒå½“å‰é€‰ä¸­çŠ¶æ€ï¼‰
        // generateYearOptions(); // ä¸éœ€è¦é‡æ–°ç”Ÿæˆ
        
        // åŠ è½½å¯¹åº”å¹´ä»½çš„æ•°æ®
        loadYearData(currentYear);
        
        // é‡æ–°ç”Ÿæˆç»Ÿè®¡
        generateStatistics();
        
        console.log('å·²åˆ‡æ¢åˆ°' + currentYear + 'å¹´');
    }

    // åŠ è½½æŒ‡å®šå¹´ä»½çš„æ•°æ®
    function loadYearData(year) {
        try {
            var savedRecords = api.getPrefs({sync: true, key: 'alertRecords_' + year});
            if (savedRecords) {
                alertRecords = JSON.parse(savedRecords);
                console.log('å·²åŠ è½½' + year + 'å¹´çš„' + alertRecords.length + 'æ¡è­¦æŠ¥è®°å½•');
            } else {
                alertRecords = [];
                console.log('æœªæ‰¾åˆ°' + year + 'å¹´çš„è­¦æŠ¥è®°å½•');
            }
        } catch (e) {
            alertRecords = [];
            console.log('åŠ è½½' + year + 'å¹´è­¦æŠ¥è®°å½•å¤±è´¥: ' + e.message);
        }
    }

    // æ˜¾ç¤ºè®°å½•è¯¦æƒ…
    function showRecordDetail(recordId) {
        var record = alertRecords.find(function(r) {
            return r.id.toString() === recordId;
        });
        
        if (!record) {
            api.toast({
                msg: 'æœªæ‰¾åˆ°è®°å½•',
                duration: 2000,
                location: 'top'
            });
            return;
        }
        
        var weekdayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºæµ‹è¯•è®°å½•ï¼šæµ‹è¯•è®°å½•ä¸ºæµ…ç°è‰²ï¼Œæ­£å¸¸è®°å½•ä¸ºé»‘è‰²ï¼Œé¢œè‰²åŒºåˆ†ä¾¿äºé˜…è¯»
        var isTestRecord = record.content.indexOf('TEST') !== -1 || record.content.indexOf('æµ‹è¯•') !== -1;
        var textColor = isTestRecord ? '#999' : '#333';
        var bgColor = isTestRecord ? '#f0f0f0' : '#f8f8f8';
        var titleColor = isTestRecord ? '#999' : '#333';
        var titleText = isTestRecord ? 'æµ‹è¯•è­¦æŠ¥è¯¦æƒ…' : 'è­¦æŠ¥è¯¦æƒ…';
        
        var detailHTML = `
        <div class="detail-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
            <div class="detail-modal" style="background: white; border-radius: 10px; padding: 20px; margin: 20px; max-width: 90%; max-height: 80%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: ${titleColor};">${titleText}</h3>
                    <button onclick="closeRecordDetail()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">Ã—</button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: ${textColor};">æ—¶é—´ï¼š</span>
                        <span style="color: ${isTestRecord ? '#999' : '#666'};">${record.date} ${record.time}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: ${textColor};">æ˜ŸæœŸï¼š</span>
                        <span style="color: ${isTestRecord ? '#999' : '#666'};">${weekdayNames[record.weekday]}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: ${textColor};">æ¥æºå·ç ï¼š</span>
                        <span style="color: ${isTestRecord ? '#999' : '#666'};">${record.phoneNumber}</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; color: ${textColor}; margin-bottom: 8px;">çŸ­ä¿¡å†…å®¹ï¼š</div>
                    <div style="background: ${bgColor}; padding: 10px; border-radius: 5px; line-height: 1.5; color: ${textColor}; white-space: pre-wrap; word-break: break-all;">${record.content}</div>
                </div>
                
                <div style="text-align: center; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="deleteSingleRecord('${recordId}')" style="padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">åˆ é™¤</button>
                    <button onclick="closeRecordDetail()" style="padding: 10px 20px; background: #007aff; color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailHTML);

        // é˜²æ­¢æ»‘åŠ¨ç©¿é€
        document.body.style.overflow = 'hidden';

        // æ·»åŠ æ·¡å…¥åŠ¨ç”»
        var detailModal = document.querySelector('.detail-modal');
        if (detailModal) {
            detailModal.classList.add('dialog-fade');
            setTimeout(function() {
                detailModal.classList.add('show');
            }, 10);
        }
    }

    // å…³é—­è®°å½•è¯¦æƒ…
    function closeRecordDetail() {
        var detailOverlay = document.querySelector('.detail-overlay');
        var detailModal = document.querySelector('.detail-modal');
        if (detailModal) {
            detailModal.classList.remove('show');
            setTimeout(function() {
                if (detailOverlay) detailOverlay.remove();
                document.body.style.overflow = '';
            }, 250); // åŠ¨ç”»æ—¶é•¿è¦å’ŒCSSä¸€è‡´
        } else {
            if (detailOverlay) detailOverlay.remove();
            document.body.style.overflow = '';
        }
    }



    // è§¦æ‘¸å¼€å§‹å¤„ç†
    function handleTouchStart(event) {
        if (isMultiSelectMode) return; // å¤šé€‰æ¨¡å¼ä¸‹ç¦ç”¨æ»‘åŠ¨åˆ é™¤
        
        var touch = event.touches[0];
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        recordItem.setAttribute('data-touch-start-x', touch.clientX);
        recordItem.setAttribute('data-touch-start-y', touch.clientY);
        recordItem.setAttribute('data-touch-current-x', touch.clientX);
        recordItem.setAttribute('data-touch-current-y', touch.clientY);
        recordItem.setAttribute('data-is-touching', 'true');
        
        isSwipeInProgress = false; // é‡ç½®æ»‘åŠ¨çŠ¶æ€
        
        // åŒæ—¶è§¦å‘é•¿æŒ‰é€»è¾‘
        handleMouseDown(event, recordId);
        // ä¸è¦åœ¨touchstartä¸­è°ƒç”¨preventDefault
    }



    // é¼ æ ‡æŒ‰ä¸‹å¤„ç†ï¼ˆä¹Ÿå¤„ç†è§¦æ‘¸äº‹ä»¶ï¼‰
    function handleMouseDown(event, recordId) {
        // è·å–æ­£ç¡®çš„åæ ‡ï¼ˆæ”¯æŒè§¦æ‘¸å’Œé¼ æ ‡ï¼‰
        var clientY = event.clientY || (event.touches && event.touches[0] ? event.touches[0].clientY : 0);
        
        touchStartY = clientY;
        touchStartTime = Date.now();
        hasMoved = false;
        
        // æ·»åŠ é•¿æŒ‰è§†è§‰åé¦ˆ
        var element = event.target.closest('.records-item');
        if (element) {
            element.classList.add('long-pressing');
        }
        
        // å¼€å§‹é•¿æŒ‰è®¡æ—¶å™¨
        longPressTimer = setTimeout(function() {
            if (!hasMoved && !isMultiSelectMode && !isSwipeInProgress) {
                enterMultiSelectMode(recordId);
            }
        }, longPressThreshold);
    }

    // é¼ æ ‡ç§»åŠ¨å¤„ç†ï¼ˆä¹Ÿå¤„ç†è§¦æ‘¸äº‹ä»¶ï¼‰
    function handleMouseMove(event) {
        if (longPressTimer) {
            // è·å–æ­£ç¡®çš„åæ ‡ï¼ˆæ”¯æŒè§¦æ‘¸å’Œé¼ æ ‡ï¼‰
            var clientY = event.clientY || (event.touches && event.touches[0] ? event.touches[0].clientY : 0);
            var moveDistance = Math.abs(clientY - touchStartY);
            
            if (moveDistance > moveThreshold) {
                hasMoved = true;
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                // ç§»é™¤é•¿æŒ‰è§†è§‰åé¦ˆ
                var element = document.querySelector('.records-item.long-pressing');
                if (element) {
                    element.classList.remove('long-pressing');
                }
            }
        }
    }

    // é¼ æ ‡æŠ¬èµ·å¤„ç†
    function handleMouseUp(event, recordId) {
        var touchDuration = Date.now() - touchStartTime;
        
        // ç§»é™¤é•¿æŒ‰è§†è§‰åé¦ˆ
        var element = event.target.closest('.records-item');
        if (element) {
            element.classList.remove('long-pressing');
        }
        
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
        
        // æ–°å¢ï¼šå¦‚æœåˆšåˆšé•¿æŒ‰è¿›å…¥å¤šé€‰ï¼Œåˆ™æœ¬æ¬¡ä¸å¤„ç†ç‚¹å‡»
        if (justEnteredMultiSelectByLongPress) {
            justEnteredMultiSelectByLongPress = false;
            return;
        }
        
        // å¦‚æœæ²¡æœ‰ç§»åŠ¨ä¸”æ—¶é—´è¶³å¤ŸçŸ­ï¼Œåˆ™è®¤ä¸ºæ˜¯ç‚¹å‡»
        if (!hasMoved && touchDuration < longPressThreshold) {
            handleRecordClick(recordId);
        }
        
        // é‡ç½®çŠ¶æ€
        hasMoved = false;
        touchStartY = 0;
        touchStartTime = 0;
    }

    // é¼ æ ‡ç¦»å¼€å¤„ç†
    function handleMouseLeave() {
        // ç§»é™¤é•¿æŒ‰è§†è§‰åé¦ˆ
        var element = document.querySelector('.records-item.long-pressing');
        if (element) {
            element.classList.remove('long-pressing');
        }
        
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
        hasMoved = false;
        touchStartY = 0;
        touchStartTime = 0;
    }

    // å¤„ç†è®°å½•ç‚¹å‡»
    function handleRecordClick(recordId) {
        // æ£€æŸ¥æ˜¯å¦åœ¨æ»‘åŠ¨çŠ¶æ€
        if (isSwipeInProgress) {
            return; // å¦‚æœæ­£åœ¨æ»‘åŠ¨ï¼Œä¸è§¦å‘ç‚¹å‡»äº‹ä»¶
        }
        
        var recordItem = document.querySelector(`[data-record-id="${recordId}"]`);
        if (recordItem && recordItem.classList.contains('swiped')) {
            return; // å¦‚æœå·²æ»‘åŠ¨æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘ç‚¹å‡»äº‹ä»¶
        }
        
        if (isMultiSelectMode) {
            // åœ¨å¤šé€‰æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»æ•´è¡Œè®°å½•éƒ½å¯ä»¥åˆ‡æ¢é€‰æ‹©çŠ¶æ€
            toggleRecordSelection(recordId);
        } else {
            showRecordDetail(recordId);
        }
    }

    // åˆ‡æ¢å¤šé€‰æ¨¡å¼
    function toggleMultiSelect() {
        if (isMultiSelectMode) {
            exitMultiSelectMode();
        } else {
            enterMultiSelectMode();
        }
    }

    // è¿›å…¥å¤šé€‰æ¨¡å¼
    function enterMultiSelectMode(preSelectRecordId) {
        isMultiSelectMode = true;
        selectedRecords = [];
        
        // å¦‚æœæŒ‡å®šäº†è¦é¢„å…ˆé€‰ä¸­çš„è®°å½•ï¼Œåˆ™æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
        if (preSelectRecordId) {
            selectedRecords.push(preSelectRecordId);
            justEnteredMultiSelectByLongPress = true;
        }
        
        document.getElementById('multiSelectBtn').textContent = 'é€€å‡ºå¤šé€‰';
        document.getElementById('multiSelectBtn').style.background = '#ff8800';
        document.getElementById('multiSelectActions').style.display = 'block';
        updateSelectedCount();
        
        // é‡ç½®æ‰€æœ‰æ»‘åŠ¨çŠ¶æ€
        resetAllSwipeStates();
        
        generateRecordsList(); // é‡æ–°ç”Ÿæˆåˆ—è¡¨ä»¥æ˜¾ç¤ºé€‰æ‹©æ¡†
    }

    // é€€å‡ºå¤šé€‰æ¨¡å¼
    function exitMultiSelectMode() {
        isMultiSelectMode = false;
        selectedRecords = [];
        document.getElementById('multiSelectBtn').textContent = 'å¤šé€‰åˆ é™¤';
        document.getElementById('multiSelectBtn').style.background = '#007aff';
        document.getElementById('multiSelectActions').style.display = 'none';
        
        // é‡ç½®æ‰€æœ‰æ»‘åŠ¨çŠ¶æ€
        resetAllSwipeStates();
        
        generateRecordsList(); // é‡æ–°ç”Ÿæˆåˆ—è¡¨ä»¥éšè—é€‰æ‹©æ¡†
    }

    // åˆ‡æ¢è®°å½•é€‰æ‹©çŠ¶æ€
    function toggleRecordSelection(recordId) {
        var index = selectedRecords.indexOf(recordId);
        if (index === -1) {
            selectedRecords.push(recordId);
        } else {
            selectedRecords.splice(index, 1);
        }
        
        updateSelectedCount();
        
        // æ›´æ–°å½“å‰é¡¹çš„æ ·å¼å’Œé€‰æ‹©æ¡†
        var recordItem = document.querySelector(`[data-record-id="${recordId}"]`);
        if (recordItem) {
            // æ›´æ–°è®°å½•é¡¹çš„é€‰ä¸­çŠ¶æ€
            if (selectedRecords.indexOf(recordId) !== -1) {
                recordItem.classList.add('selected');
            } else {
                recordItem.classList.remove('selected');
            }
            
            // æ›´æ–°é€‰æ‹©æ¡†çš„æ ·å¼
            var selectionBox = recordItem.querySelector('.selection-box');
            if (selectionBox) {
                var isSelected = selectedRecords.indexOf(recordId) !== -1;
                if (isSelected) {
                    selectionBox.style.background = '#007aff';
                    selectionBox.style.color = 'white';
                    selectionBox.style.fontWeight = 'bold';
                    selectionBox.style.fontSize = '14px';
                    selectionBox.style.borderColor = '#0056cc';
                    selectionBox.style.boxShadow = '0 2px 4px rgba(0,122,255,0.3)';
                    selectionBox.textContent = 'âœ“';
                } else {
                    selectionBox.style.background = '#f0f0f0';
                    selectionBox.style.color = '#999';
                    selectionBox.style.fontWeight = 'normal';
                    selectionBox.style.fontSize = '12px';
                    selectionBox.style.borderColor = '#007aff';
                    selectionBox.style.boxShadow = 'none';
                    selectionBox.textContent = '';
                }
            }
        }
    }

    // å…¨é€‰è®°å½•
    function selectAllRecords() {
        selectedRecords = alertRecords.map(function(record) {
            return record.id.toString();
        });
        updateSelectedCount();
        generateRecordsList();
    }

    // å–æ¶ˆå…¨é€‰
    function deselectAllRecords() {
        selectedRecords = [];
        updateSelectedCount();
        generateRecordsList();
    }

    // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = selectedRecords.length;
    }

    // åˆ é™¤é€‰ä¸­çš„è®°å½•
    function deleteSelectedRecords() {
        if (selectedRecords.length === 0) {
            api.toast({
                msg: 'è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•',
                duration: 2000,
                location: 'top'
            });
            return;
        }

        api.confirm({
            title: 'ç¡®è®¤åˆ é™¤',
            msg: 'ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ' + selectedRecords.length + ' æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
            buttons: ['å–æ¶ˆ', 'ç¡®å®šåˆ é™¤']
        }, function(ret) {
            if (ret.buttonIndex === 2) {
                // åˆ é™¤é€‰ä¸­çš„è®°å½•
                alertRecords = alertRecords.filter(function(record) {
                    return selectedRecords.indexOf(record.id.toString()) === -1;
                });
                
                // ä¿å­˜æ›´æ–°åçš„è®°å½•
                saveAlertRecords();
                
                // é€€å‡ºå¤šé€‰æ¨¡å¼
                exitMultiSelectMode();
                
                // é‡æ–°ç”Ÿæˆç»Ÿè®¡
                generateStatistics();
                
                api.toast({
                    msg: 'å·²åˆ é™¤ ' + selectedRecords.length + ' æ¡è®°å½•',
                    duration: 2000,
                    location: 'top'
                });
            }
        });
    }



    // å¯¼å‡ºç»Ÿè®¡æ•°æ®
    function exportStatistics() {
        if (alertRecords.length === 0) {
            api.toast({
                msg: 'æš‚æ— æ•°æ®å¯å¯¼å‡º',
                duration: 2000,
                location: 'top'
            });
            return;
        }
        
        try {
            var exportData = {
                year: currentYear,
                totalAlerts: alertRecords.length,
                records: alertRecords,
                exportTime: new Date().toISOString()
            };
            
            var dataStr = JSON.stringify(exportData, null, 2);
            var fileName = `è¿åœè­¦æŠ¥ç»Ÿè®¡_${currentYear}å¹´_${new Date().toISOString().split('T')[0]}.json`;
            
            // è¿™é‡Œå¯ä»¥è°ƒç”¨æ–‡ä»¶ä¿å­˜API            
            api.writeFile({
                path: "fs://export/" + fileName,
                data: dataStr
            }, function(ret, err) {
                if (ret && ret.status) {
                    console.log('æ•°æ®å·²å†™å…¥æ–‡ä»¶ï¼š' + fileName );
                    api.toast({
                        msg: 'æ•°æ®å·²å†™å…¥æ–‡ä»¶ï¼š' + fileName,
                        duration: 2000,
                        location: 'top'
                    });
                } else {
                    console.log('å†™å…¥æ–‡ä»¶å¤±è´¥: ' + JSON.stringify(err));
                }
            });
            
            console.log('ç»Ÿè®¡æ•°æ®å¯¼å‡ºæˆåŠŸ: ' + fileName);
        } catch (e) {
            console.log('æ•°æ®å¯¼å‡ºå¤±è´¥: ' + e.message);
            api.toast({
                msg: 'æ•°æ®å¯¼å‡ºå¤±è´¥: ' + e.message,
                duration: 2000,
                location: 'top'
            });
        }
    }

    // æ¸…ç©ºç»Ÿè®¡è®°å½•
    function clearStatistics() {
        api.confirm({
            title: 'ç¡®è®¤æ¸…ç©º',
            msg: 'ç¡®å®šè¦æ¸…ç©º' + currentYear + 'å¹´çš„æ‰€æœ‰è­¦æŠ¥è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
            buttons: ['å–æ¶ˆ', 'ç¡®å®šæ¸…ç©º']
        }, function(ret) {
            if (ret.buttonIndex === 2) {
                alertRecords = [];
                saveAlertRecords();
                console.log('å·²æ¸…ç©º' + currentYear + 'å¹´çš„æ‰€æœ‰è­¦æŠ¥è®°å½•');
                
                // åˆ·æ–°ç»Ÿè®¡é¡µé¢
                generateStatistics();
                
                api.toast({
                    msg: currentYear + 'å¹´è®°å½•å·²æ¸…ç©º',
                    duration: 2000,
                    location: 'top'
                });
            }
        });
    }

    // ä¿å­˜è­¦æŠ¥è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
    function saveAlertRecords() {
        try {
            api.setPrefs({
                key: 'alertRecords_' + currentYear,
                value: JSON.stringify(alertRecords)
            });
        } catch (e) {
            console.log('ä¿å­˜è­¦æŠ¥è®°å½•å¤±è´¥: ' + e.message);
        }
    }

    // åˆ†äº«ç»Ÿè®¡ç»“æœ
    function shareStatistics() {
        if (alertRecords.length === 0) {
            api.toast({
                msg: 'æš‚æ— æ•°æ®å¯åˆ†äº«',
                duration: 2000,
                location: 'top'
            });
            return;
        }
        
        try {
            // ç”Ÿæˆåˆ†äº«æ–‡æœ¬
            var shareText = generateShareText();
            console.log('åˆ†äº«æ–‡æœ¬ï¼š' + shareText);
            
            // è°ƒç”¨ç³»ç»Ÿåˆ†äº«åŠŸèƒ½
            shareAction.shareText({
                text: shareText
            });
        } catch (e) {
            console.log('åˆ†äº«åŠŸèƒ½å¼‚å¸¸: ' + e.message);
            api.toast({
                msg: 'åˆ†äº«åŠŸèƒ½å¼‚å¸¸',
                duration: 2000,
                location: 'top'
            });
        }
    }

    // ç”Ÿæˆåˆ†äº«æ–‡æœ¬
    function generateShareText() {
        var totalAlerts = alertRecords.length;
        var avgPerMonth = totalAlerts > 0 ? (totalAlerts / 12).toFixed(1) : 0;
        
        // è®¡ç®—æœ€é«˜æœˆæ¬¡æ•°
        var monthlyData = new Array(12).fill(0);
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.month >= 1 && record.month <= 12) {
                    monthlyData[record.month - 1]++;
                }
            }
        });
        var maxMonth = Math.max(...monthlyData);
        
        // è®¡ç®—æœ€è¿‘è­¦æŠ¥æ—¶é—´
        var lastAlert = 'æ— ';
        if (alertRecords.length > 0) {
            var lastRecord = getSortedRecordsDesc()[0];
            
            // è·å–å½“å‰æ—¥æœŸå’Œè®°å½•æ—¥æœŸï¼ˆåªæ¯”è¾ƒæ—¥æœŸéƒ¨åˆ†ï¼Œå¿½ç•¥æ—¶é—´ï¼‰
            var now = new Date();
            var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var lastDate = new Date(lastRecord.timestamp);
            var recordDate = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
            
            // è®¡ç®—æ—¥æœŸå·®ï¼ˆæ¯«ç§’ï¼‰
            var diffTime = today.getTime() - recordDate.getTime();
            var diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                lastAlert = 'ä»Šå¤©';
            } else if (diffDays === 1) {
                lastAlert = 'æ˜¨å¤©';
            } else if (diffDays < 7) {
                lastAlert = diffDays + 'å¤©å‰';
            } else {
                lastAlert = lastRecord.date;
            }
        }
        
        // ä½¿ç”¨ç¼“å­˜çš„é£é™©åˆ†ææ•°æ®å’Œè¡Œä¸ºæ¨¡å¼æ•°æ®
        var riskData = window.riskAnalysisData || {};
        var behaviorData = window.behaviorPatternData || {};
        
        var maxConsecutiveDays = riskData.maxConsecutiveDays || calculateMaxConsecutiveDays();
        var avgInterval = riskData.avgInterval || calculateAverageInterval();
        var trendStatus = riskData.trendStatus || calculateTrendStatus();
        var riskLevel = riskData.riskLevel || calculateRiskLevel();
        
        var peakWeekday = behaviorData.peakWeekday || calculatePeakWeekday();
        var peakHour = behaviorData.peakHour || calculatePeakHour();
        var peakMonth = behaviorData.peakMonth || calculatePeakMonth();
        var nextPrediction = behaviorData.nextPrediction || calculateNextPrediction();
        
        var shareText = `ğŸš¨ ${currentYear}å¹´è¿åœè­¦æŠ¥ç»Ÿè®¡æŠ¥å‘Š
        
ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆï¼š
â€¢ æ€»è­¦æŠ¥æ¬¡æ•°ï¼š${totalAlerts}æ¬¡
â€¢ æœˆå¹³å‡æ¬¡æ•°ï¼š${avgPerMonth}æ¬¡
â€¢ æœ€é«˜æœˆæ¬¡æ•°ï¼š${maxMonth}æ¬¡
â€¢ æœ€è¿‘è­¦æŠ¥ï¼š${lastAlert}

âš ï¸ é£é™©åˆ†æï¼š
â€¢ æœ€é•¿è¿ç»­å¤©æ•°ï¼š${maxConsecutiveDays}å¤©
â€¢ å¹³å‡é—´éš”ï¼š${avgInterval}å¤©
â€¢ è¿‘æœŸè¶‹åŠ¿ï¼š${trendStatus}
â€¢ é£é™©ç­‰çº§ï¼š${riskLevel}

ğŸ“ˆ è¡Œä¸ºæ¨¡å¼ï¼š
â€¢ æœ€é¢‘ç¹æ˜ŸæœŸï¼š${peakWeekday}
â€¢ æœ€é¢‘ç¹æ—¶æ®µï¼š${peakHour}
â€¢ æœ€é¢‘ç¹æœˆä»½ï¼š${peakMonth}
â€¢ é¢„æµ‹ä¸‹æ¬¡ï¼š${nextPrediction}

ğŸ’¡ ä½¿ç”¨äº¤è­¦çŸ­ä¿¡æé†’APPï¼ŒåŠæ—¶æŒæ¡è¿ç« ä¿¡æ¯ï¼Œé¿å…é€¾æœŸå¤„ç†ï¼

#äº¤è­¦çŸ­ä¿¡æé†’ #è¿ç« ç»Ÿè®¡ #å®‰å…¨é©¾é©¶`;
        
        return shareText;
    }

    // æ˜¾ç¤ºå›¾è¡¨æ‚¬æµ®æç¤ºæ¡†
    function showChartTooltip(event, label, count, chartType) {
        // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.chart-bar.selected').forEach(function(bar) {
            bar.classList.remove('selected');
        });
        
        // æ·»åŠ å½“å‰æŸ±å­çš„é€‰ä¸­çŠ¶æ€
        event.target.classList.add('selected');
        
        var tooltip = document.getElementById('chartTooltip');
        var rect = event.target.getBoundingClientRect();
        
        // è®¡ç®—æç¤ºæ¡†ä½ç½®
        var left = rect.left + rect.width / 2;
        var top = rect.top - 10;
        
        // è®¡ç®—ç™¾åˆ†æ¯”
        var totalCount = 0;
        switch(chartType) {
            case 'æœˆåº¦è¶‹åŠ¿':
                var monthlyData = new Array(12).fill(0);
                alertRecords.forEach(function(record) {
                    if (record.year === currentYear && record.month >= 1 && record.month <= 12) {
                        monthlyData[record.month - 1]++;
                    }
                });
                totalCount = monthlyData.reduce((sum, val) => sum + val, 0);
                break;
            case 'æ˜ŸæœŸåˆ†å¸ƒ':
                var weekdayData = new Array(7).fill(0);
                alertRecords.forEach(function(record) {
                    if (record.year === currentYear && record.weekday >= 0 && record.weekday < 7) {
                        weekdayData[record.weekday]++;
                    }
                });
                totalCount = weekdayData.reduce((sum, val) => sum + val, 0);
                break;
            case 'æ—¶æ®µåˆ†å¸ƒ':
                var timeData = new Array(24).fill(0);
                alertRecords.forEach(function(record) {
                    if (record.year === currentYear) {
                        var hour = parseInt(record.time.split(':')[0]);
                        if (!isNaN(hour) && hour >= 0 && hour < 24) {
                            timeData[hour]++;
                        }
                    }
                });
                totalCount = timeData.reduce((sum, val) => sum + val, 0);
                break;
        }
        
        var percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(1) : 0;
        
        // ç”Ÿæˆæç¤ºå†…å®¹
        var tooltipContent = '';
        var icon = '';
        switch(chartType) {
            case 'æœˆåº¦è¶‹åŠ¿':
                icon = 'ğŸ“…';
                tooltipContent = `${icon} <strong>${label}</strong><br>è­¦æŠ¥æ¬¡æ•°ï¼š${count}æ¬¡<br>å æ¯”ï¼š${percentage}%`;
                break;
            case 'æ˜ŸæœŸåˆ†å¸ƒ':
                icon = 'ğŸ“†';
                tooltipContent = `${icon} <strong>${label}</strong><br>è­¦æŠ¥æ¬¡æ•°ï¼š${count}æ¬¡<br>å æ¯”ï¼š${percentage}%`;
                break;
            case 'æ—¶æ®µåˆ†å¸ƒ':
                icon = 'ğŸ•';
                tooltipContent = `${icon} <strong>${label}</strong><br>è­¦æŠ¥æ¬¡æ•°ï¼š${count}æ¬¡<br>å æ¯”ï¼š${percentage}%`;
                break;
            default:
                tooltipContent = `${label}ï¼š${count}æ¬¡`;
        }
        
        // è®¾ç½®æç¤ºæ¡†å†…å®¹å’Œä½ç½®
        tooltip.innerHTML = tooltipContent;
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        
        // æ˜¾ç¤ºæç¤ºæ¡†
        tooltip.classList.add('show');
        
        // 4ç§’åè‡ªåŠ¨éšè—
        setTimeout(function() {
            hideChartTooltip();
        }, 4000);
    }

    // éšè—å›¾è¡¨æ‚¬æµ®æç¤ºæ¡†
    function hideChartTooltip() {
        var tooltip = document.getElementById('chartTooltip');
        tooltip.classList.remove('show');
        
        // ç§»é™¤é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.chart-bar.selected').forEach(function(bar) {
            bar.classList.remove('selected');
        });
    }

    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶éšè—æç¤ºæ¡†
    document.addEventListener('click', function(event) {
        if (!event.target.classList.contains('chart-bar')) {
            hideChartTooltip();
        }
    });

    // è§¦æ‘¸äº‹ä»¶å¤„ç† - æ»‘åŠ¨åˆ é™¤åŠŸèƒ½
    function handleTouchStart(event) {
        if (isMultiSelectMode) return; // å¤šé€‰æ¨¡å¼ä¸‹ç¦ç”¨æ»‘åŠ¨åˆ é™¤
        
        var touch = event.touches[0];
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        recordItem.setAttribute('data-touch-start-x', touch.clientX);
        recordItem.setAttribute('data-touch-start-y', touch.clientY);
        recordItem.setAttribute('data-touch-current-x', touch.clientX);
        recordItem.setAttribute('data-touch-current-y', touch.clientY);
        recordItem.setAttribute('data-is-touching', 'true');
        
        isSwipeInProgress = false; // é‡ç½®æ»‘åŠ¨çŠ¶æ€
        
        // åŒæ—¶è§¦å‘é•¿æŒ‰é€»è¾‘
        handleMouseDown(event, recordId);
        // ä¸è¦åœ¨touchstartä¸­è°ƒç”¨preventDefault
    }

    function handleTouchMove(event) {
        var touch = event.touches[0];
        var recordItem = event.currentTarget;
        
        if (recordItem.getAttribute('data-is-touching') !== 'true') return;
        
        // æ›´æ–°å½“å‰è§¦æ‘¸ä½ç½®
        recordItem.setAttribute('data-touch-current-x', touch.clientX);
        recordItem.setAttribute('data-touch-current-y', touch.clientY);
        
        if (isMultiSelectMode) {
            // å¤šé€‰æ¨¡å¼ä¸‹åªè®°å½•ä½ç½®ï¼Œä¸å¤„ç†æ»‘åŠ¨
            return;
        }
        
        // éå¤šé€‰æ¨¡å¼ä¸‹çš„æ»‘åŠ¨åˆ é™¤é€»è¾‘
        var startX = parseInt(recordItem.getAttribute('data-touch-start-x'));
        var currentX = parseInt(recordItem.getAttribute('data-touch-current-x'));
        var startY = parseInt(recordItem.getAttribute('data-touch-start-y'));
        var currentY = parseInt(recordItem.getAttribute('data-touch-current-y'));
        
        var deltaX = currentX - startX;
        var deltaY = Math.abs(currentY - startY);
        
        // åŒæ—¶è§¦å‘é•¿æŒ‰ç§»åŠ¨é€»è¾‘
        handleMouseMove(event);
        
        // åªå¤„ç†æ°´å¹³æ»‘åŠ¨ï¼Œå‚ç›´æ»‘åŠ¨è·ç¦»ä¸èƒ½å¤ªå¤§
        if (deltaY < 50 && deltaX < 0) {
            var swipeDistance = Math.min(Math.abs(deltaX), 80);
            recordItem.style.transform = `translateX(-${swipeDistance}px)`;
            recordItem.classList.add('swiping');
            isSwipeInProgress = true; // æ ‡è®°æ­£åœ¨æ»‘åŠ¨
            // åªæœ‰åœ¨å®é™…è¿›è¡Œæ»‘åŠ¨æ—¶æ‰é˜»æ­¢é»˜è®¤æ»šåŠ¨
            if (event.cancelable) {
                event.preventDefault();
            }
        }
    }

    function handleTouchEnd(event) {
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        // æ–°å¢ï¼šå¦‚æœåˆšåˆšé•¿æŒ‰è¿›å…¥å¤šé€‰ï¼Œåˆ™æœ¬æ¬¡ä¸å¤„ç†ç‚¹å‡»
        if (justEnteredMultiSelectByLongPress) {
            justEnteredMultiSelectByLongPress = false;
            return;
        }
        
        if (isMultiSelectMode) {
            // å¤šé€‰æ¨¡å¼ä¸‹ï¼Œç›´æ¥å¤„ç†ç‚¹å‡»äº‹ä»¶
            if (recordItem.getAttribute('data-is-touching') === 'true') {
                var startX = parseInt(recordItem.getAttribute('data-touch-start-x'));
                var currentX = parseInt(recordItem.getAttribute('data-touch-current-x'));
                var startY = parseInt(recordItem.getAttribute('data-touch-start-y'));
                var currentY = parseInt(recordItem.getAttribute('data-touch-current-y'));
                
                var deltaX = Math.abs(currentX - startX);
                var deltaY = Math.abs(currentY - startY);
                
                // å¦‚æœç§»åŠ¨è·ç¦»å¾ˆå°ï¼Œè®¤ä¸ºæ˜¯ç‚¹å‡»
                if (deltaX < 10 && deltaY < 10) {
                    handleRecordClick(recordId);
                }
            }
            return;
        }
        
        // éå¤šé€‰æ¨¡å¼ä¸‹çš„æ»‘åŠ¨åˆ é™¤é€»è¾‘
        if (recordItem.getAttribute('data-is-touching') !== 'true') return;
        
        var startX = parseInt(recordItem.getAttribute('data-touch-start-x'));
        var currentX = parseInt(recordItem.getAttribute('data-touch-current-x'));
        var swipeThreshold = parseInt(recordItem.getAttribute('data-swipe-threshold'));
        
        var deltaX = currentX - startX;
        
        // ç§»é™¤æ»‘åŠ¨çŠ¶æ€
        recordItem.classList.remove('swiping');
        
        // å¦‚æœæ»‘åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        if (deltaX < -swipeThreshold) {
            // å…ˆé‡ç½®å…¶ä»–é¡¹çš„æ»‘åŠ¨çŠ¶æ€ï¼Œç¡®ä¿åªæœ‰å½“å‰é¡¹æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            resetOtherSwipeStates(recordId);
            recordItem.classList.add('swiped');
        } else {
            recordItem.classList.remove('swiped');
            recordItem.style.transform = '';
        }
        
        recordItem.setAttribute('data-is-touching', 'false');
        isSwipeInProgress = false; // é‡ç½®æ»‘åŠ¨çŠ¶æ€
        
        // åŒæ—¶è§¦å‘é•¿æŒ‰ç»“æŸé€»è¾‘
        handleMouseUp(event, recordId);
    }

    // é¼ æ ‡äº‹ä»¶å¤„ç† - æ»‘åŠ¨åˆ é™¤åŠŸèƒ½ï¼ˆæ¡Œé¢ç«¯æ”¯æŒï¼‰
    function handleMouseDownForSwipe(event) {
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        // è®°å½•é¼ æ ‡å¼€å§‹ä½ç½®
        recordItem.setAttribute('data-mouse-start-x', event.clientX);
        recordItem.setAttribute('data-mouse-start-y', event.clientY);
        recordItem.setAttribute('data-mouse-current-x', event.clientX);
        recordItem.setAttribute('data-mouse-current-y', event.clientY);
        recordItem.setAttribute('data-is-mousing', 'true');
        
        // åŒæ—¶è§¦å‘é•¿æŒ‰é€»è¾‘
        handleMouseDown(event, recordId);
        // ä¸è¦åœ¨mousedownä¸­è°ƒç”¨preventDefault
    }

    function handleMouseMoveForSwipe(event) {
        var recordItem = event.currentTarget;
        
        if (recordItem.getAttribute('data-is-mousing') !== 'true') return;
        
        // æ›´æ–°å½“å‰é¼ æ ‡ä½ç½®
        recordItem.setAttribute('data-mouse-current-x', event.clientX);
        recordItem.setAttribute('data-mouse-current-y', event.clientY);
        
        if (isMultiSelectMode) {
            // å¤šé€‰æ¨¡å¼ä¸‹åªè®°å½•ä½ç½®ï¼Œä¸å¤„ç†æ»‘åŠ¨
            return;
        }
        
        // éå¤šé€‰æ¨¡å¼ä¸‹çš„æ»‘åŠ¨åˆ é™¤é€»è¾‘
        var startX = parseInt(recordItem.getAttribute('data-mouse-start-x'));
        var currentX = parseInt(recordItem.getAttribute('data-mouse-current-x'));
        var startY = parseInt(recordItem.getAttribute('data-mouse-start-y'));
        var currentY = parseInt(recordItem.getAttribute('data-mouse-current-y'));
        
        var deltaX = currentX - startX;
        var deltaY = Math.abs(currentY - startY);
        
        // åŒæ—¶è§¦å‘é•¿æŒ‰ç§»åŠ¨é€»è¾‘
        handleMouseMove(event);
        
        // åªå¤„ç†æ°´å¹³æ»‘åŠ¨ï¼Œå‚ç›´æ»‘åŠ¨è·ç¦»ä¸èƒ½å¤ªå¤§
        if (deltaY < 50 && deltaX < 0) {
            var swipeDistance = Math.min(Math.abs(deltaX), 80);
            recordItem.style.transform = `translateX(-${swipeDistance}px)`;
            recordItem.classList.add('swiping');
            isSwipeInProgress = true; // æ ‡è®°æ­£åœ¨æ»‘åŠ¨
        }
        // ä¸è¦åœ¨mousemoveä¸­è°ƒç”¨preventDefault
    }

    function handleMouseUpForSwipe(event) {
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        if (isMultiSelectMode) {
            // å¤šé€‰æ¨¡å¼ä¸‹ï¼Œç›´æ¥å¤„ç†ç‚¹å‡»äº‹ä»¶
            if (recordItem.getAttribute('data-is-mousing') === 'true') {
                var startX = parseInt(recordItem.getAttribute('data-mouse-start-x'));
                var currentX = parseInt(recordItem.getAttribute('data-mouse-current-x'));
                var startY = parseInt(recordItem.getAttribute('data-mouse-start-y'));
                var currentY = parseInt(recordItem.getAttribute('data-mouse-current-y'));
                
                var deltaX = Math.abs(currentX - startX);
                var deltaY = Math.abs(currentY - startY);
                
                // å¦‚æœç§»åŠ¨è·ç¦»å¾ˆå°ï¼Œè®¤ä¸ºæ˜¯ç‚¹å‡»
                if (deltaX < 10 && deltaY < 10) {
                    handleRecordClick(recordId);
                }
            }
            return;
        }
        
        // éå¤šé€‰æ¨¡å¼ä¸‹çš„æ»‘åŠ¨åˆ é™¤é€»è¾‘
        if (recordItem.getAttribute('data-is-mousing') !== 'true') return;
        
        var startX = parseInt(recordItem.getAttribute('data-mouse-start-x'));
        var currentX = parseInt(recordItem.getAttribute('data-mouse-current-x'));
        var swipeThreshold = parseInt(recordItem.getAttribute('data-swipe-threshold'));
        
        var deltaX = currentX - startX;
        
        // ç§»é™¤æ»‘åŠ¨çŠ¶æ€
        recordItem.classList.remove('swiping');
        
        // å¦‚æœæ»‘åŠ¨è·ç¦»è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        if (deltaX < -swipeThreshold) {
            // å…ˆé‡ç½®å…¶ä»–é¡¹çš„æ»‘åŠ¨çŠ¶æ€ï¼Œç¡®ä¿åªæœ‰å½“å‰é¡¹æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            resetOtherSwipeStates(recordId);
            recordItem.classList.add('swiped');
        } else {
            recordItem.classList.remove('swiped');
            recordItem.style.transform = '';
        }
        
        recordItem.setAttribute('data-is-mousing', 'false');
        isSwipeInProgress = false; // é‡ç½®æ»‘åŠ¨çŠ¶æ€
        
        // åŒæ—¶è§¦å‘é•¿æŒ‰ç»“æŸé€»è¾‘
        handleMouseUp(event, recordId);
    }

    function handleMouseLeaveForSwipe(event) {
        if (isMultiSelectMode) return; // å¤šé€‰æ¨¡å¼ä¸‹ç¦ç”¨æ»‘åŠ¨åˆ é™¤
        
        var recordItem = event.currentTarget;
        
        if (recordItem.getAttribute('data-is-mousing') === 'true') {
            recordItem.classList.remove('swiping');
            recordItem.classList.remove('swiped');
            recordItem.style.transform = '';
            recordItem.setAttribute('data-is-mousing', 'false');
            isSwipeInProgress = false; // é‡ç½®æ»‘åŠ¨çŠ¶æ€
        }
    }

    // åˆ é™¤å•æ¡è®°å½•
    function deleteSingleRecord(recordId) {
        var record = alertRecords.find(function(r) {
            return r.id.toString() === recordId;
        });
        
        if (!record) {
            api.toast({
                msg: 'æœªæ‰¾åˆ°è®°å½•',
                duration: 2000,
                location: 'top'
            });
            return;
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        var confirmMsg = 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è­¦æŠ¥è®°å½•å—ï¼Ÿ\n\n';
        confirmMsg += 'ğŸ“… æ—¶é—´ï¼š' + record.date + ' ' + record.time + '\n';
        confirmMsg += 'ğŸ“± æ¥æºï¼š' + record.phoneNumber + '\n';
        confirmMsg += 'ğŸ“ å†…å®¹ï¼š' + (record.content.length > 40 ? record.content.substring(0, 40) + '...' : record.content);
        
        api.confirm({
            title: 'ç¡®è®¤åˆ é™¤',
            msg: confirmMsg,
            buttons: ['å–æ¶ˆ', 'ç¡®å®šåˆ é™¤']
        }, function(ret) {
            if (ret.buttonIndex === 2) {
                // ä»æ•°ç»„ä¸­ç§»é™¤è®°å½•
                var index = alertRecords.findIndex(function(r) {
                    return r.id.toString() === recordId;
                });
                
                if (index !== -1) {
                    alertRecords.splice(index, 1);
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    saveAlertRecords();
                    
                    // æ¸…é™¤ç¼“å­˜
                    clearCache();
                    
                    // é‡æ–°ç”Ÿæˆç»Ÿè®¡å’Œåˆ—è¡¨
                    generateStatistics();
                    
                    // éšè—åˆ é™¤æŒ‰é’®
                    var recordItem = document.querySelector(`[data-record-id="${recordId}"]`);
                    if (recordItem) {
                        recordItem.classList.remove('swiped');
                        recordItem.style.transform = '';
                    }
                    
                    api.toast({
                        msg: 'è®°å½•å·²åˆ é™¤',
                        duration: 2000,
                        location: 'top'
                    });
                    
                    console.log('å·²åˆ é™¤è®°å½•ï¼š' + recordId);
                }
            }
        });
    }

    // é‡ç½®æ‰€æœ‰æ»‘åŠ¨çŠ¶æ€
    function resetAllSwipeStates() {
        document.querySelectorAll('.records-item.swiped').forEach(function(item) {
            item.classList.remove('swiped');
            item.style.transform = '';
        });
        
        document.querySelectorAll('.records-item.swiping').forEach(function(item) {
            item.classList.remove('swiping');
            item.style.transform = '';
        });
    }

    // é‡ç½®é™¤æŒ‡å®šé¡¹å¤–çš„æ‰€æœ‰æ»‘åŠ¨çŠ¶æ€
    function resetOtherSwipeStates(exceptRecordId) {
        var allRecordItems = document.querySelectorAll('.records-item');
        allRecordItems.forEach(function(item) {
            var itemRecordId = item.getAttribute('data-record-id');
            if (itemRecordId !== exceptRecordId) {
                item.classList.remove('swiped');
                item.classList.remove('swiping');
                item.style.transform = '';
            }
        });
    }

    // é¡µé¢ç‚¹å‡»æ—¶é‡ç½®æ»‘åŠ¨çŠ¶æ€
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.records-item-container') && !event.target.closest('.delete-button')) {
            resetAllSwipeStates();
        }
    });

    // æ˜¾ç¤ºè¡Œä¸ºæ¨¡å¼è¯¦æƒ…
    function showPatternDetail(type) {
        var title = '';
        var content = '';
        var records = [];
        
        switch(type) {
            case 'weekday':
                var peakWeekday = document.getElementById('peakWeekday').textContent;
                if (peakWeekday === '-') {
                    api.toast({
                        msg: 'æš‚æ— æ•°æ®',
                        duration: 2000,
                        location: 'top'
                    });
                    return;
                }
                
                title = 'æ˜ŸæœŸè¯¦æƒ… - ' + peakWeekday;
                
                // è·å–è¯¥æ˜ŸæœŸçš„æ‰€æœ‰è®°å½•
                var weekdayIndex = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'].indexOf(peakWeekday);
                records = alertRecords.filter(function(record) {
                    return record.weekday === weekdayIndex;
                });
                
                content = generatePatternDetailContent(records, 'æ˜ŸæœŸ', peakWeekday);
                break;
                
            case 'hour':
                var peakHour = document.getElementById('peakHour').textContent;
                if (peakHour === '-') {
                    api.toast({
                        msg: 'æš‚æ— æ•°æ®',
                        duration: 2000,
                        location: 'top'
                    });
                    return;
                }
                
                title = 'æ—¶æ®µè¯¦æƒ… - ' + peakHour;
                
                // è·å–è¯¥æ—¶æ®µçš„æ‰€æœ‰è®°å½•
                var hour = parseInt(peakHour.replace('æ—¶', ''));
                records = alertRecords.filter(function(record) {
                    var recordHour = parseInt(record.time.split(':')[0]);
                    return recordHour === hour;
                });
                
                content = generatePatternDetailContent(records, 'æ—¶æ®µ', peakHour);
                break;
                
            case 'month':
                var peakMonth = document.getElementById('peakMonth').textContent;
                if (peakMonth === '-') {
                    api.toast({
                        msg: 'æš‚æ— æ•°æ®',
                        duration: 2000,
                        location: 'top'
                    });
                    return;
                }
                
                title = 'æœˆä»½è¯¦æƒ… - ' + peakMonth;
                
                // è·å–è¯¥æœˆä»½çš„æ‰€æœ‰è®°å½•
                var month = parseInt(peakMonth.replace('æœˆ', ''));
                records = alertRecords.filter(function(record) {
                    return record.month === month;
                });
                
                content = generatePatternDetailContent(records, 'æœˆä»½', peakMonth);
                break;
                
            case 'prediction':
                var nextPrediction = document.getElementById('nextPrediction').textContent;
                if (nextPrediction === '-') {
                    api.toast({
                        msg: 'æš‚æ— é¢„æµ‹æ•°æ®',
                        duration: 2000,
                        location: 'top'
                    });
                    return;
                }
                
                title = 'é¢„æµ‹è¯¦æƒ…';
                content = generatePredictionDetailContent();
                break;
        }
        
        // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
        showDetailDialog(title, content);
    }
    
    // ç”Ÿæˆè¡Œä¸ºæ¨¡å¼è¯¦æƒ…å†…å®¹
    function generatePatternDetailContent(records, type, value) {
        if (records.length === 0) {
            return '<p style="text-align: center; color: #666;">æš‚æ— ç›¸å…³æ•°æ®</p>';
        }
        
        var content = '<div style="max-height: 400px; overflow-y: auto;">';
        
        // ç»Ÿè®¡ä¿¡æ¯
        content += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
        content += '<h4 style="margin: 0 0 10px 0; color: #495057;">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h4>';
        content += '<p style="margin: 5px 0; color: #666;">â€¢ æ€»è®°å½•æ•°ï¼š<strong>' + records.length + '</strong> æ¡</p>';
        content += '<p style="margin: 5px 0; color: #666;">â€¢ å æ¯”ï¼š<strong>' + ((records.length / alertRecords.length) * 100).toFixed(1) + '%</strong></p>';
        
        // è®¡ç®—å¹³å‡é—´éš”
        if (records.length > 1) {
            var sortedRecords = records.sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });
            
            var totalInterval = 0;
            for (var i = 1; i < sortedRecords.length; i++) {
                var interval = (new Date(sortedRecords[i].timestamp) - new Date(sortedRecords[i-1].timestamp)) / (1000 * 60 * 60 * 24);
                totalInterval += interval;
            }
            var avgInterval = totalInterval / (sortedRecords.length - 1);
            content += '<p style="margin: 5px 0; color: #666;">â€¢ å¹³å‡é—´éš”ï¼š<strong>' + avgInterval.toFixed(1) + '</strong> å¤©</p>';
        }
        
        content += '</div>';
        
        // è¯¦ç»†è®°å½•åˆ—è¡¨
        content += '<div style="background: white; border-radius: 8px; padding: 15px;">';
        content += '<h4 style="margin: 0 0 15px 0; color: #495057;">ğŸ“ è¯¦ç»†è®°å½•</h4>';
        
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—
        var sortedRecords = records.sort(function(a, b) {
            return new Date(b.timestamp) - new Date(a.timestamp);
        });
        
        sortedRecords.forEach(function(record, index) {
            if (index < 10) { // åªæ˜¾ç¤ºæœ€è¿‘10æ¡è®°å½•
                content += '<div style="border-bottom: 1px solid #eee; padding: 10px 0; margin-bottom: 10px;">';
                content += '<div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 5px;">';
                content += '<span style="font-weight: bold; color: #333;">' + record.date + ' ' + record.time + '</span>';
                // å»é™¤IDå±•ç¤º
                // content += '<span style="font-size: 12px; color: #666;">#' + record.id + '</span>';
                content += '</div>';
                content += '<div style="color: #666; font-size: 14px; line-height: 1.4;">' + record.content + '</div>';
                content += '<div style="font-size: 12px; color: #999; margin-top: 5px;">æ¥æºï¼š' + record.phoneNumber + '</div>';
                content += '</div>';
            }
        });
        
        if (records.length > 10) {
            content += '<div style="text-align: center; color: #666; font-size: 12px; padding: 10px;">è¿˜æœ‰ ' + (records.length - 10) + ' æ¡è®°å½•...</div>';
        }
        
        content += '</div>';
        content += '</div>';
        
        return content;
    }
    
    // ç”Ÿæˆé¢„æµ‹è¯¦æƒ…å†…å®¹
    function generatePredictionDetailContent() {
        var content = '<div style="max-height: 400px; overflow-y: auto;">';
        
        // é¢„æµ‹ç®—æ³•è¯´æ˜
        content += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
        content += '<h4 style="margin: 0 0 10px 0; color: #495057;">ğŸ”® é¢„æµ‹ç®—æ³•</h4>';
        content += '<p style="margin: 5px 0; color: #666; line-height: 1.5;">åŸºäºå†å²æ•°æ®çš„é—´éš”åˆ†æï¼Œè®¡ç®—å¹³å‡è¿ç« é—´éš”æ—¶é—´ï¼Œé¢„æµ‹ä¸‹æ¬¡å¯èƒ½è¿ç« çš„æ—¶é—´ç‚¹ã€‚</p>';
        content += '</div>';
        
        // å†å²é—´éš”åˆ†æ
        if (alertRecords.length >= 2) {
            var sortedRecords = alertRecords.sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });
            
            content += '<div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">';
            content += '<h4 style="margin: 0 0 10px 0; color: #495057;">ğŸ“ˆ é—´éš”åˆ†æ</h4>';
            
            var intervals = [];
            for (var i = 1; i < sortedRecords.length; i++) {
                var interval = (new Date(sortedRecords[i].timestamp) - new Date(sortedRecords[i-1].timestamp)) / (1000 * 60 * 60 * 24);
                intervals.push(interval);
            }
            
            var avgInterval = intervals.reduce(function(sum, val) { return sum + val; }, 0) / intervals.length;
            var minInterval = Math.min(...intervals);
            var maxInterval = Math.max(...intervals);
            
            content += '<p style="margin: 5px 0; color: #666;">â€¢ å¹³å‡é—´éš”ï¼š<strong>' + avgInterval.toFixed(1) + '</strong> å¤©</p>';
            content += '<p style="margin: 5px 0; color: #666;">â€¢ æœ€çŸ­é—´éš”ï¼š<strong>' + minInterval.toFixed(1) + '</strong> å¤©</p>';
            content += '<p style="margin: 5px 0; color: #666;">â€¢ æœ€é•¿é—´éš”ï¼š<strong>' + maxInterval.toFixed(1) + '</strong> å¤©</p>';
            content += '</div>';
        }
        
        // é¢„æµ‹å»ºè®®
        content += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">';
        content += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ’¡ é¢„æµ‹å»ºè®®</h4>';
        content += '<p style="margin: 5px 0; color: #333; line-height: 1.5;">â€¢ é¢„æµ‹ä»…ä¾›å‚è€ƒï¼Œå®é™…è¿ç« æ—¶é—´å¯èƒ½å› å„ç§å› ç´ è€Œå˜åŒ–</p>';
        content += '<p style="margin: 5px 0; color: #333; line-height: 1.5;">â€¢ å»ºè®®åœ¨é¢„æµ‹æ—¶é—´å‰åç‰¹åˆ«æ³¨æ„é©¾é©¶è¡Œä¸º</p>';
        content += '<p style="margin: 5px 0; color: #333; line-height: 1.5;">â€¢ ä¿æŒè‰¯å¥½çš„é©¾é©¶ä¹ æƒ¯æ˜¯é¿å…è¿ç« çš„æœ€ä½³æ–¹æ³•</p>';
        content += '</div>';
        
        content += '</div>';
        
        return content;
    }
    
    // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
    function showDetailDialog(title, content) {
        // åˆ›å»ºå¼¹çª—å®¹å™¨
        var dialog = document.createElement('div');
        dialog.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        `;
        
        // åˆ›å»ºå¼¹çª—å†…å®¹
        var dialogContent = document.createElement('div');
        dialogContent.style.cssText = `
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 80%;
            width: 100%;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        `;
        
        // åˆ›å»ºå¼¹çª—å¤´éƒ¨
        var dialogHeader = document.createElement('div');
        dialogHeader.style.cssText = `
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        `;
        dialogHeader.innerHTML = `
            <h3 style="margin: 0; color: #333; font-size: 18px;">${title}</h3>
            <button onclick="closeDetailDialog()" style="
                background: none;
                border: none;
                font-size: 24px;
                color: #666;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.2s;
            " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">Ã—</button>
        `;
        
        // åˆ›å»ºå¼¹çª—ä¸»ä½“
        var dialogBody = document.createElement('div');
        dialogBody.style.cssText = `
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        `;
        dialogBody.innerHTML = content;

        
        // ç»„è£…å¼¹çª—
        dialogContent.appendChild(dialogHeader);
        dialogContent.appendChild(dialogBody);
        dialog.appendChild(dialogContent);
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(dialog);
        // ç¦æ­¢é¡µé¢æ»šåŠ¨ï¼Œé˜²æ­¢æ»‘åŠ¨ç©¿é€
        document.body.style.overflow = 'hidden';
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
        dialog.addEventListener('click', function(e) {
            if (e.target === dialog) {
                closeDetailDialog();
            }
        });
        
        // æ·»åŠ å…³é—­å‡½æ•°åˆ°å…¨å±€
        window.closeDetailDialog = function() {
            if (dialog && dialog.parentNode) {
                dialog.parentNode.removeChild(dialog);
            }
            // æ¢å¤é¡µé¢æ»šåŠ¨
            document.body.style.overflow = '';
        };
    }


</script>

</body>
</html> 