<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <title>违停警报统计</title>
    <link rel="stylesheet" href="../css/api.css">
    <script src="https://unpkg.com/mescroll.js@1.4.2/mescroll.min.js"></script>
    <style>
        /* .container {
            padding: 15px;
        } */
         /* ------------------------- 优化顶部左右有空白区域问题-BEGIN ------------------------------ */
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        /* 优化：去除顶部和左右空白 */
        html, body, #mescroll, .mescroll-body, .stats-container {
            margin: 0 !important;
            padding: 0 !important;
            width: 100vw !important;
            min-width: 100vw !important;
            max-width: 100vw !important;
        }
        .container {
            padding: 0 !important;
        }
        .stats-container {
            padding: 0 !important;
            margin: 0 !important;
            width: 100vw !important;
            min-width: 100vw !important;
            max-width: 100vw !important;
        }
        .mescroll {
            width: 100vw !important;
            min-width: 100vw !important;
            max-width: 100vw !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        .mescroll-body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100vw !important;
            min-width: 100vw !important;
            max-width: 100vw !important;
        }
        /* 统计内容区块保持原有圆角和间距 */
        .stats-summary, .stats-risk, .stats-pattern, .stats-advice, .stats-charts, .stats-list {
            margin-left: 10px;
            margin-right: 10px;
        }
        /* 头部紧贴顶部 */
        .stats-header {
            margin-top: 0 !important;
            border-radius: 0 0 0px 0px;
        }
        /* ------------------------- 优化顶部左右有空白区域问题-END ------------------------------ */


        .stats-container {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;}
        .stats-header {background: #007aff; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;}
        .stats-header button:hover {opacity: 0.8;}
        .stats-summary .grid-item {transition: transform 0.2s;}
        .stats-summary .grid-item:hover {transform: scale(1.05);}
        .stats-charts {transition: all 0.3s ease;}
        .stats-charts:hover {box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .chart-bar {transition: height 0.5s ease;}
        .chart-bar:hover {opacity: 0.8;}
        .records-item {transition: all 0.2s ease;}
        .records-item:hover {background: #f0f0f0 !important; transform: translateX(2px);}
        .stats-actions button {transition: all 0.2s ease;}
        .stats-actions button:hover {transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
        .stats-actions button:active {transform: translateY(0);}
        .btn {padding: 10px 10px; margin: 5px; background: #007aff; color: white; border: none; border-radius: 5px; cursor: pointer;}
        .btn:disabled {background: #ccc; cursor: not-allowed; opacity: 0.6;}
        .btn:enabled:hover {background: #0056cc;}
        .btn-danger {background: #ff4444;}
        .btn-danger:hover {background: #cc0000;}
        .btn-success {background: #44aa44;}
        .btn-success:hover {background: #338833;}
        
        /* 多选模式样式 */
        .records-item.multi-select { border: 2px solid #007aff; }
        .records-item.multi-select.selected { background: #e3f2fd !important; }
        .selection-indicator { 
            width: 20px; 
            height: 20px; 
            border: 2px solid #007aff; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px;
            font-weight: bold;
        }
        .selection-indicator.selected { 
            background: #007aff; 
            color: white; 
        }
        
        /* 长按反馈样式 */
        .records-item.long-pressing {
            transform: scale(0.98);
            opacity: 0.8;
            transition: all 0.1s ease;
        }
        
        /* 防止文本选择 */
        .records-item {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* 图表悬浮提示框样式 */
        .chart-tooltip {
            position: fixed;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1000;
            pointer-events: none;
            transform: translate(-50%, -100%);
            margin-top: -15px;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }
        
        .chart-tooltip.show {
            opacity: 1;
            transform: translate(-50%, -100%) scale(1.05);
        }
        
        .chart-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #2c3e50;
        }
        
        /* 柱状图悬停效果 */
        .chart-bar:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }
        
        /* 柱状图点击效果 */
        .chart-bar:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
        
        /* 柱状图选中状态 */
        .chart-bar.selected {
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.5);
            border: 2px solid #007aff;
        }
        
        /* 滑动删除样式 */
        .records-item-container {
            position: relative;
            overflow: hidden;
            margin: 5px 0;
            border-radius: 5px;
        }
        
        .records-item {
            position: relative;
            z-index: 2;
            transition: transform 0.3s ease;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #ff4444;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .records-item.swiped {
            transform: translateX(-80px);
        }
        
        .delete-button {
            position: absolute;
            right: 0;
            top: 0;
            width: 80px;
            height: 100%;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1;
            border-radius: 0 5px 5px 0;
            box-shadow: inset 2px 0 5px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .delete-button:hover {
            background: linear-gradient(135deg, #cc0000, #990000);
        }
        
        .delete-button:active {
            transform: scale(0.95);
        }
        
        /* 滑动提示 */
        .swipe-hint {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 3;
        }
        
        .records-item-container:hover .swipe-hint {
            opacity: 1;
        }
        
        /* 滑动时的视觉反馈 */
        .records-item.swiping {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* 适配框架页面 */
        .stats-container {
            padding-bottom: 20px; /* 减少底部间距 */
        }

        /* mescroll样式 */
        .mescroll {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: auto;
        }
        
        .mescroll-body {
            position: relative;
            /* height: 100%; */
            /* overflow: hidden; */
        }
        
        .mescroll-body .stats-container {
            padding-bottom: 0;
            min-height: 100vh;
        }

        /* 自定义下拉刷新样式 */
        .mescroll-downwarp {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 14px;
            font-weight: 500;
        }
        
        .mescroll-downwarp .downwarp-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 0 20px;
            text-align: center;
        }
        
        .mescroll-downwarp .downwarp-tip {
            margin-left: 8px;
            font-size: 13px;
            opacity: 0.9;
        }
        
        .mescroll-downwarp .downwarp-progress {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            /* display: none; 默认隐藏这个转圈动画 */
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 弹窗动画 */
        .dialog-fade {
            opacity: 0;
            transform: scale(0.96);
            transition: opacity 0.25s cubic-bezier(.4,0,.2,1), transform 0.25s cubic-bezier(.4,0,.2,1);
        }
        .dialog-fade.show {
            opacity: 1;
            transform: scale(1);
        }


    </style>
</head>
<body>
<!-- mescroll容器 -->
<div id="mescroll" class="mescroll">
    <div class="mescroll-body">
        <div class="stats-container" id="statsContainer">
            <div class="stats-header">
                <h2 style="margin: 0;" id="pageTitle">年度违停警报统计</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <select id="yearSelector" onchange="changeYear(this.value)" style="padding: 5px; border: none; border-radius: 3px; background: white; color: #333;">
                        <!-- 年份选项将在这里动态生成 -->
                    </select>
                    <button onclick="goBack()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">×</button>
                </div>
            </div>
            
            <div class="stats-content" style="padding: 15px;">
                <div class="stats-summary" style="background: #f8f8f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #333;">统计概览</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #ff4444;" id="totalAlerts">0</div>
                            <div style="font-size: 12px; color: #666;">总警报次数</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #007aff;" id="avgPerMonth">0</div>
                            <div style="font-size: 12px; color: #666;">月平均次数</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #44aa44;" id="maxMonth">0</div>
                            <div style="font-size: 12px; color: #666;">最高月次数</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 8px 5px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 24px; font-weight: bold; color: #ff8800; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="lastAlert">-</div>
                            <div style="font-size: 12px; color: #666;">最近警报</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-risk" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <h3 style="margin-top: 0; color: #856404;">风险分析</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: #dc3545;" id="maxConsecutiveDays">0</div>
                            <div style="font-size: 12px; color: #666;">最长连续天数</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: #6f42c1;" id="avgInterval">-</div>
                            <div style="font-size: 12px; color: #666;">平均间隔(天)</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: #fd7e14;" id="trendStatus">-</div>
                            <div style="font-size: 12px; color: #666;">近期趋势</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="font-size: 20px; font-weight: bold; color: #20c997;" id="riskLevel">-</div>
                            <div style="font-size: 12px; color: #666;">风险等级</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-pattern" style="background: #d1ecf1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #17a2b8;">
                    <h3 style="margin-top: 0; color: #0c5460;">行为模式 <span style="font-size: 12px; color: #666; font-weight: normal;">(点击查看详情)</span></h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" 
                             onclick="showPatternDetail('weekday')" 
                             onmouseover="this.style.transform='scale(1.02)'" 
                             onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 18px; font-weight: bold; color: #495057;" id="peakWeekday">-</div>
                            <div style="font-size: 12px; color: #666;">最频繁星期</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" 
                             onclick="showPatternDetail('hour')" 
                             onmouseover="this.style.transform='scale(1.02)'" 
                             onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 18px; font-weight: bold; color: #495057;" id="peakHour">-</div>
                            <div style="font-size: 12px; color: #666;">最频繁时段</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" 
                             onclick="showPatternDetail('month')" 
                             onmouseover="this.style.transform='scale(1.02)'" 
                             onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 18px; font-weight: bold; color: #495057;" id="peakMonth">-</div>
                            <div style="font-size: 12px; color: #666;">最频繁月份</div>
                        </div>
                        <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s ease;" 
                             onclick="showPatternDetail('prediction')" 
                             onmouseover="this.style.transform='scale(1.02)'" 
                             onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 18px; font-weight: bold; color: #495057;" id="nextPrediction">-</div>
                            <div style="font-size: 12px; color: #666;">预测下次</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-advice" style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                    <h3 style="margin-top: 0; color: #155724;">智能建议</h3>
                    <div id="smartAdvice" style="background: white; padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <!-- 智能建议将在这里生成 -->
                    </div>
                </div>
                
                <div class="stats-charts" style="margin-bottom: 20px;">
                    <h3 style="color: #333;">月度趋势 <span style="font-size: 12px; color: #666; font-weight: normal;">(点击柱子查看详情)</span></h3>
                    <div id="monthlyChart" style="height: 200px; background: #f8f8f8; border-radius: 8px; display: flex; align-items: end; justify-content: space-around; padding: 20px;">
                        <!-- 月度柱状图将在这里生成 -->
                    </div>
                </div>
                
                <div class="stats-charts" style="margin-bottom: 20px;">
                    <h3 style="color: #333;">星期分布 <span style="font-size: 12px; color: #666; font-weight: normal;">(点击柱子查看详情)</span></h3>
                    <div id="weekdayChart" style="height: 200px; background: #f8f8f8; border-radius: 8px; display: flex; align-items: end; justify-content: space-around; padding: 20px;">
                        <!-- 星期柱状图将在这里生成 -->
                    </div>
                </div>
                
                <div class="stats-charts" style="margin-bottom: 20px;">
                    <h3 style="color: #333;">时段分布 <span style="font-size: 12px; color: #666; font-weight: normal;">(点击柱子查看详情)</span></h3>
                    <div id="timeChart" style="height: 200px; background: #f8f8f8; border-radius: 8px; display: flex; align-items: end; justify-content: space-around; padding: 20px;">
                        <!-- 时段柱状图将在这里生成 -->
                    </div>
                </div>
                
                <div class="stats-actions" style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn" onclick="exportStatistics()" style="flex: 1;">导出数据</button>
                    <button class="btn btn-success" onclick="shareStatistics()" style="flex: 1;">分享统计</button>
                    <button class="btn" onclick="toggleMultiSelect()" style="flex: 1;" id="multiSelectBtn">多选删除</button>
                    <button class="btn btn-danger" onclick="clearStatistics()" style="flex: 1;">清空记录</button>
                </div>
                
                <div id="multiSelectActions" style="display: none; margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button class="btn" onclick="selectAllRecords()" style="flex: 1;">全选</button>
                        <button class="btn" onclick="deselectAllRecords()" style="flex: 1;">取消全选</button>
                        <button class="btn btn-danger" onclick="deleteSelectedRecords()" style="flex: 1;">删除选中</button>
                    </div>
                    <div style="text-align: center; color: #666; font-size: 12px;">
                        已选择 <span id="selectedCount">0</span> 条记录
                    </div>
                    <div style="text-align: center; color: #999; font-size: 11px; margin-top: 5px;">
                        提示：长按记录项可进入多选模式，滑动时不会触发多选
                    </div>
                </div>
                
                <div class="stats-list">
                    <h3 style="color: #333;">详细记录 <span style="font-size: 12px; color: #666; font-weight: normal;">(左滑删除 | 长按多选)</span></h3>
                             <div id="recordsList" style="max-height: 500px; overflow-y: auto;">
                     <!-- 详细记录将在这里生成 -->
                 </div>
             </div>
         </div>
     </div>
 </div>

<!-- 图表悬浮提示框 -->
<div id="chartTooltip" class="chart-tooltip"></div>

<script src="../script/api.js"></script>
<script>
    var alertRecords = []; // 警报记录数组
    var currentYear = new Date().getFullYear(); // 当前年份
    var isMultiSelectMode = false; // 是否处于多选模式
    var selectedRecords = []; // 选中的记录ID数组
    var longPressTimer = null; // 长按计时器
    var touchStartY = 0; // 触摸开始位置
    var touchStartTime = 0; // 触摸开始时间
    var hasMoved = false; // 是否发生了移动
    var moveThreshold = 10; // 移动阈值（像素）
    var longPressThreshold = 1000; // 长按阈值（毫秒）
    var isSwipeInProgress = false; // 跟踪滑动状态
    var justEnteredMultiSelectByLongPress = false;
    var shareAction = null; // 分享模块
    var mescroll = null; // mescroll实例
    var isConfirmDialogOpen = false; // 是否有确认对话框打开
    
    apiready = function() {
        // 分享模块引入
        shareAction = api.require('shareAction'); 
        
        // 获取页面参数
        var pageParam = api.pageParam;
        if (pageParam && pageParam.currentYear) {
            currentYear = pageParam.currentYear;
        } else {
            // 如果没有参数，使用当前年份
            currentYear = new Date().getFullYear();
        }
        
        // 设置页面标题
        document.getElementById('pageTitle').textContent = currentYear + '年违停警报统计';
        
        // 动态生成年份选择器选项
        generateYearOptions();
        
        // 设置年份选择器默认值
        document.getElementById('yearSelector').value = currentYear;
        
        // 初始化mescroll
        initMescroll();
        
        // 加载警报记录
        loadAlertRecords();
        
        // 生成统计数据
        generateStatistics();
    };

    // 初始化mescroll
    function initMescroll() {
        mescroll = new MeScroll("mescroll", {
            isBounce: true, // 允许弹性滚动
            down: {
                auto: false, // 禁用自动下拉刷新
                callback: function() {
                    // 只在mescroll容器顶部才刷新
                    var scrollTop = document.getElementById('mescroll').scrollTop;
                    if (scrollTop <= 0) {
                        // 显示刷新中状态
                        var downwarpContent = document.querySelector('.mescroll-downwarp .downwarp-content');
                        if (downwarpContent) {
                            downwarpContent.innerHTML = '<div class="downwarp-progress"></div><div class="downwarp-tip">正在刷新数据...</div>';
                        }
                        refreshDataOnly();
                    } else {
                        mescroll.endSuccess();
                    }
                },
                // 初始内容为空
                htmlContent: '<div class="downwarp-content"></div>',
                offset: 60,
                // 当下拉到offset范围内时触发
                inOffset: function() {
                    var downwarpContent = document.querySelector('.mescroll-downwarp .downwarp-content');
                    if (downwarpContent) {
                        downwarpContent.innerHTML = '<div class="downwarp-progress"></div><div class="downwarp-tip">下拉刷新</div>';
                    }
                },
                // 当下拉超过offset范围时触发
                outOffset: function() {
                    var downwarpContent = document.querySelector('.mescroll-downwarp .downwarp-content');
                    if (downwarpContent) {
                        downwarpContent.innerHTML = '<div class="downwarp-progress"></div><div class="downwarp-tip">释放刷新</div>';
                    }
                },
                threshold: 50
            },
            up: {
                auto: false,
                callback: function() {
                    mescroll.endSuccess();
                },
                page: {
                    num: 0,
                    size: 10,
                    time: Date.now()
                },
                htmlNodata: '已经到底了~',
                htmlLoading: '',
                htmlError: ''
            }
        });

        // 初始化后，强制隐藏下拉刷新区域
        var downwarp = document.querySelector('.mescroll-downwarp');
        if (downwarp) {
            downwarp.style.visibility = 'hidden';
            downwarp.style.opacity = '0';
            downwarp.style.transition = 'visibility 0s, opacity 0.3s ease';
        }

        // 添加滚动监听，控制下拉刷新区域的显示
        var mescrollEl = document.getElementById('mescroll');
        mescrollEl.addEventListener('scroll', function() {
            if (mescrollEl.scrollTop <= 0 && downwarp) {
                downwarp.style.visibility = 'visible';
                downwarp.style.opacity = '1';
            } else if (downwarp && !mescroll.isDownLoading) {
                downwarp.style.visibility = 'hidden';
                downwarp.style.opacity = '0';
            }
        });
    }
    
    // 返回上一页
    function goBack() {
        console.log('返回键被触发，当前多选模式状态：', isMultiSelectMode);
        
        // 检查是否有打开的记录详情弹窗
        var detailOverlay = document.querySelector('.detail-overlay');
        if (detailOverlay) {
            console.log('关闭记录详情弹窗');
            closeRecordDetail();
            return;
        }
        
        // 检查是否有打开的模式详情弹窗
        var patternDialog = document.querySelector('#pattern_dialog');
        if (patternDialog && typeof window.closeDetailDialog === 'function') {
            console.log('关闭模式详情弹窗');
            window.closeDetailDialog();
            return;
        }
        
        // 检查是否有打开的确认对话框
        if (isConfirmDialogOpen) {
            console.log('关闭确认对话框');
            // 在APICloud中，无法直接关闭由api.confirm创建的对话框
            // 这里我们通过设置标志位并模拟点击对话框外部来关闭
            isConfirmDialogOpen = false;
            // 发送一个自定义事件通知对话框关闭
            api.sendEvent({
                name: 'closeConfirmDialog'
            });
            return;
        }
        
        // 如果处于多选模式，先退出多选模式
        if (isMultiSelectMode) {
            console.log('退出多选模式');
            exitMultiSelectMode();
            api.toast({
                msg: '已退出多选模式',
                duration: 1500,
                location: 'middle'
            });
        } else {
            console.log('关闭统计页面，回到首页');
            // 非多选模式下需要回到首页，不是直接关闭frame，而是让主框架处理页面切换
            api.execScript({
                script: 'switchPage(\'home\')'
            })
        }
    }
    
    // 刷新统计数据（供外部调用）
    function refreshStatisticsData(year) {
        if (year) {
            currentYear = year;
            // 更新页面标题
            document.getElementById('pageTitle').textContent = currentYear + '年违停警报统计';
            // 更新年份选择器
            document.getElementById('yearSelector').value = currentYear;
        }
        
        // 重新加载警报记录
        loadAlertRecords();
        
        // 重新生成统计数据
        generateStatistics();
        
        console.log('统计数据已刷新，年份：' + currentYear);
    }
    
    // 将函数暴露到全局作用域，确保能被外部调用
    window.refreshStatisticsData = refreshStatisticsData;
    window.goBack = goBack; // 生效中，作返回
    window.refreshDataOnly = refreshDataOnly;
    
    // 只刷新数据，保持当前年份选择
    function refreshDataOnly() {
        // 重新加载警报记录（使用当前选择的年份）
        loadAlertRecords();
        
        // 重新生成统计数据
        generateStatistics();
        
        console.log('数据已刷新，年份：' + currentYear);
        // 确保刷新完成后调用endSuccess
        if (mescroll) {
            mescroll.endSuccess();
        }
        api.toast({
            msg: '数据已刷新，年份：' + currentYear,
            location: 'bottom',
            duration: 2000
        });
    }
    

    
    // 动态生成年份选择器选项
    function generateYearOptions() {
        var yearSelector = document.getElementById('yearSelector');
        var optionsHTML = '';
        
        // 生成当前年份及前两年的选项
        for (var i = 0; i < 3; i++) {
            var year = currentYear - i;
            var selected = i === 0 ? ' selected' : '';
            optionsHTML += '<option value="' + year + '"' + selected + '>' + year + '年</option>';
        }
        
        yearSelector.innerHTML = optionsHTML;
    }

    // 从本地存储加载警报记录
    function loadAlertRecords() {
        try {
            var savedRecords = api.getPrefs({sync: true, key: 'alertRecords_' + currentYear});
            if (savedRecords) {
                alertRecords = JSON.parse(savedRecords);
                console.log('已加载' + alertRecords.length + '条警报记录');
            } else {
                alertRecords = [];
                console.log('未找到历史警报记录');
            }
        } catch (e) {
            alertRecords = [];
            console.log('加载警报记录失败: ' + e.message);
        }
    }

    // 生成统计数据
    function generateStatistics() {
        // 清除缓存
        clearCache();
        
        // 更新统计概览
        updateSummaryStats();
        
        // 生成月度趋势图
        generateMonthlyChart();
        
        // 生成星期分布图
        generateWeekdayChart();
        
        // 生成时段分布图
        generateTimeChart();
        
        // 生成详细记录列表
        generateRecordsList();
    }

    // 更新统计概览
    function updateSummaryStats() {
        var totalAlerts = alertRecords.length;
        var avgPerMonth = totalAlerts > 0 ? (totalAlerts / 12).toFixed(1) : 0;
        
        // 计算最高月次数
        var monthlyData = new Array(12).fill(0);
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.month >= 1 && record.month <= 12) {
                    monthlyData[record.month - 1]++;
                }
            }
        });
        var maxMonth = Math.max(...monthlyData);
        
        // 计算最近警报时间
        var lastAlert = '-';
        if (alertRecords.length > 0) {
            var lastRecord = getSortedRecordsDesc()[0];
            
            // 获取当前日期和记录日期（只比较日期部分，忽略时间）
            var now = new Date();
            var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var lastDate = new Date(lastRecord.timestamp);
            var recordDate = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
            
            // 计算日期差（毫秒）
            var diffTime = today.getTime() - recordDate.getTime();
            var diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                lastAlert = '今天';
            } else if (diffDays === 1) {
                lastAlert = '昨天';
            } else if (diffDays < 7) {
                lastAlert = diffDays + '天前';
            } else {
                // 只显示月和日，不显示年份
                var dateParts = lastRecord.date.split('-');
                if (dateParts.length === 3) {
                    lastAlert = dateParts[1] + '-' + dateParts[2];
                } else {
                    lastAlert = lastRecord.date;
                }
            }
        }
        
        document.getElementById('totalAlerts').textContent = totalAlerts;
        document.getElementById('avgPerMonth').textContent = avgPerMonth;
        document.getElementById('maxMonth').textContent = maxMonth;
        document.getElementById('lastAlert').textContent = lastAlert;
        
        // 计算风险分析数据
        calculateRiskAnalysis();
        
        // 计算行为模式数据
        calculateBehaviorPatterns();
        
        // 生成智能建议
        generateSmartAdvice();
    }

    // 生成月度趋势图
    function generateMonthlyChart() {
        var monthlyData = new Array(12).fill(0);
        var monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        // 统计每月警报次数
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.month >= 1 && record.month <= 12) {
                    monthlyData[record.month - 1]++;
                }
            }
        });
        var maxValue = Math.max(...monthlyData);
        var chartHTML = '';
        monthlyData.forEach(function(count, index) {
            var height = maxValue > 0 ? (count / maxValue * 150) : 0;
            var color = count > 0 ? '#ff4444' : '#ddd';
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end;">
                    <div style="font-size: 10px; color: #666; margin-bottom: 2px; font-weight: bold;">${count}</div>
                    <div class="chart-bar" style="width: 20px; height: 0px; background: ${color}; border-radius: 3px; margin-bottom: 2px; transition: height 0.8s ease; cursor: pointer;" 
                         title="${monthNames[index]}: ${count}次" 
                         data-height="${height}"
                         data-month="${monthNames[index]}"
                         data-count="${count}"
                         onclick="showChartTooltip(event, '${monthNames[index]}', ${count}, '月度趋势')"></div>
                    <div style="font-size: 10px; color: #666; margin-top: 2px;">${monthNames[index]}</div>
                </div>
            `;
        });
        document.getElementById('monthlyChart').innerHTML = chartHTML;
        setTimeout(function() {
            var bars = document.querySelectorAll('#monthlyChart .chart-bar');
            bars.forEach(function(bar) {
                var height = bar.getAttribute('data-height');
                bar.style.height = height + 'px';
            });
        }, 100);
    }

    // 生成星期分布图
    function generateWeekdayChart() {
        var weekdayData = new Array(7).fill(0);
        var weekdayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.weekday >= 0 && record.weekday < 7) {
                    weekdayData[record.weekday]++;
                }
            }
        });
        var maxValue = Math.max(...weekdayData);
        var chartHTML = '';
        weekdayData.forEach(function(count, index) {
            var height = maxValue > 0 ? (count / maxValue * 150) : 0;
            var color = count > 0 ? '#007aff' : '#ddd';
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end;">
                    <div style="font-size: 10px; color: #666; margin-bottom: 2px; font-weight: bold;">${count}</div>
                    <div class="chart-bar" style="width: 20px; height: 0px; background: ${color}; border-radius: 3px; margin-bottom: 2px; transition: height 0.8s ease; cursor: pointer;" 
                         title="${weekdayNames[index]}: ${count}次" 
                         data-height="${height}"
                         data-weekday="${weekdayNames[index]}"
                         data-count="${count}"
                         onclick="showChartTooltip(event, '${weekdayNames[index]}', ${count}, '星期分布')"></div>
                    <div style="font-size: 10px; color: #666; margin-top: 2px;">${weekdayNames[index]}</div>
                </div>
            `;
        });
        document.getElementById('weekdayChart').innerHTML = chartHTML;
        setTimeout(function() {
            var bars = document.querySelectorAll('#weekdayChart .chart-bar');
            bars.forEach(function(bar) {
                var height = bar.getAttribute('data-height');
                bar.style.height = height + 'px';
            });
        }, 200);
    }

    // 计算风险分析数据
    function calculateRiskAnalysis() {
        if (alertRecords.length === 0) {
            document.getElementById('maxConsecutiveDays').textContent = '0';
            document.getElementById('avgInterval').textContent = '-';
            document.getElementById('trendStatus').textContent = '-';
            document.getElementById('riskLevel').textContent = '-';
            return;
        }
        
        // 1. 计算最长连续天数
        var maxConsecutiveDays = calculateMaxConsecutiveDays();
        
        // 2. 计算平均间隔
        var avgInterval = calculateAverageInterval();
        
        // 3. 计算近期趋势
        var trendStatus = calculateTrendStatus();
        
        // 4. 计算风险等级
        var riskLevel = calculateRiskLevel();
        
        // 更新显示
        document.getElementById('maxConsecutiveDays').textContent = maxConsecutiveDays;
        document.getElementById('avgInterval').textContent = avgInterval;
        document.getElementById('trendStatus').textContent = trendStatus;
        document.getElementById('riskLevel').textContent = riskLevel;
        
        // 保存计算结果供其他函数使用
        window.riskAnalysisData = {
            maxConsecutiveDays: maxConsecutiveDays,
            avgInterval: avgInterval,
            trendStatus: trendStatus,
            riskLevel: riskLevel
        };
    }
    
    // 获取按时间排序的记录（缓存结果）
    function getSortedRecords() {
        if (!window.sortedRecordsCache) {
            window.sortedRecordsCache = alertRecords.slice().sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });
        }
        return window.sortedRecordsCache;
    }
    
    // 获取按时间倒序排序的记录（缓存结果）
    function getSortedRecordsDesc() {
        if (!window.sortedRecordsDescCache) {
            window.sortedRecordsDescCache = alertRecords.slice().sort(function(a, b) {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
        }
        return window.sortedRecordsDescCache;
    }
    
    // 清除缓存（在数据更新时调用）
    function clearCache() {
        window.sortedRecordsCache = null;
        window.sortedRecordsDescCache = null;
        window.riskAnalysisData = null;
        window.behaviorPatternData = null;
    }
    
    // 计算日期差（通用函数）
    function calculateDaysDifference(timestamp) {
        var now = new Date();
        var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        var recordDate = new Date(timestamp);
        var recordDay = new Date(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate());
        
        var diffTime = today.getTime() - recordDay.getTime();
        return Math.floor(diffTime / (1000 * 60 * 60 * 24));
    }
    
    // 计算最长连续天数
    function calculateMaxConsecutiveDays() {
        if (alertRecords.length < 2) return 1;
        
        var sortedRecords = getSortedRecords();
        
        var maxConsecutive = 1;
        var currentConsecutive = 1;
        
        for (var i = 1; i < sortedRecords.length; i++) {
            var prevDate = new Date(sortedRecords[i-1].timestamp);
            var currDate = new Date(sortedRecords[i].timestamp);
            
            var prevDay = new Date(prevDate.getFullYear(), prevDate.getMonth(), prevDate.getDate());
            var currDay = new Date(currDate.getFullYear(), currDate.getMonth(), currDate.getDate());
            
            var diffDays = Math.floor((currDay.getTime() - prevDay.getTime()) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                currentConsecutive++;
                maxConsecutive = Math.max(maxConsecutive, currentConsecutive);
            } else {
                currentConsecutive = 1;
            }
        }
        
        return maxConsecutive;
    }
    
    // 计算平均间隔
    function calculateAverageInterval() {
        if (alertRecords.length < 2) return '-';
        
        var sortedRecords = getSortedRecords();
        
        var totalInterval = 0;
        var intervalCount = 0;
        
        for (var i = 1; i < sortedRecords.length; i++) {
            var prevDate = new Date(sortedRecords[i-1].timestamp);
            var currDate = new Date(sortedRecords[i].timestamp);
            
            var prevDay = new Date(prevDate.getFullYear(), prevDate.getMonth(), prevDate.getDate());
            var currDay = new Date(currDate.getFullYear(), currDate.getMonth(), currDate.getDate());
            
            var diffDays = Math.floor((currDay.getTime() - prevDay.getTime()) / (1000 * 60 * 60 * 24));
            
            if (diffDays > 0) {
                totalInterval += diffDays;
                intervalCount++;
            }
        }
        
        return intervalCount > 0 ? Math.round(totalInterval / intervalCount) : '-';
    }
    
    // 计算近期趋势
    function calculateTrendStatus() {
        if (alertRecords.length < 4) return '数据不足';
        
        var sortedRecords = getSortedRecords();
        
        // 获取最近30天的记录
        var now = new Date();
        var thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        var recentRecords = sortedRecords.filter(function(record) {
            return new Date(record.timestamp) >= thirtyDaysAgo;
        });
        
        var previousRecords = sortedRecords.filter(function(record) {
            var recordDate = new Date(record.timestamp);
            return recordDate >= new Date(thirtyDaysAgo.getTime() - 30 * 24 * 60 * 60 * 1000) && recordDate < thirtyDaysAgo;
        });
        
        if (recentRecords.length === 0 && previousRecords.length === 0) {
            return '无变化';
        }
        
        if (recentRecords.length > previousRecords.length) {
            return '上升';
        } else if (recentRecords.length < previousRecords.length) {
            return '下降';
        } else {
            return '稳定';
        }
    }
    
    // 计算风险等级
    function calculateRiskLevel() {
        if (alertRecords.length === 0) return '-';
        
        var totalAlerts = alertRecords.length;
        var avgPerMonth = totalAlerts / 12;
        var maxConsecutive = calculateMaxConsecutiveDays();
        
        if (avgPerMonth >= 5 || maxConsecutive >= 3) {
            return '高风险';
        } else if (avgPerMonth >= 3 || maxConsecutive >= 2) {
            return '中风险';
        } else if (avgPerMonth >= 1) {
            return '低风险';
        } else {
            return '安全';
        }
    }
    
    // 计算行为模式数据
    function calculateBehaviorPatterns() {
        if (alertRecords.length === 0) {
            document.getElementById('peakWeekday').textContent = '-';
            document.getElementById('peakHour').textContent = '-';
            document.getElementById('peakMonth').textContent = '-';
            document.getElementById('nextPrediction').textContent = '-';
            return;
        }
        
        // 1. 最频繁星期
        var peakWeekday = calculatePeakWeekday();
        
        // 2. 最频繁时段
        var peakHour = calculatePeakHour();
        
        // 3. 最频繁月份
        var peakMonth = calculatePeakMonth();
        
        // 4. 预测下次
        var nextPrediction = calculateNextPrediction();
        
        // 更新显示
        document.getElementById('peakWeekday').textContent = peakWeekday;
        document.getElementById('peakHour').textContent = peakHour;
        document.getElementById('peakMonth').textContent = peakMonth;
        document.getElementById('nextPrediction').textContent = nextPrediction;
        
        // 保存计算结果供其他函数使用
        window.behaviorPatternData = {
            peakWeekday: peakWeekday,
            peakHour: peakHour,
            peakMonth: peakMonth,
            nextPrediction: nextPrediction
        };
    }
    
    // 计算最频繁星期
    function calculatePeakWeekday() {
        var weekdayCounts = new Array(7).fill(0);
        var weekdayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
        
        alertRecords.forEach(function(record) {
            if (record.weekday >= 0 && record.weekday < 7) {
                weekdayCounts[record.weekday]++;
            }
        });
        
        var maxIndex = weekdayCounts.indexOf(Math.max(...weekdayCounts));
        return weekdayNames[maxIndex];
    }
    
    // 计算最频繁时段
    function calculatePeakHour() {
        var hourCounts = new Array(24).fill(0);
        
        alertRecords.forEach(function(record) {
            var hour = parseInt(record.time.split(':')[0]);
            if (!isNaN(hour) && hour >= 0 && hour < 24) {
                hourCounts[hour]++;
            }
        });
        
        var maxIndex = hourCounts.indexOf(Math.max(...hourCounts));
        return maxIndex + '时';
    }
    
    // 计算最频繁月份
    function calculatePeakMonth() {
        var monthCounts = new Array(12).fill(0);
        var monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        
        alertRecords.forEach(function(record) {
            if (record.month >= 1 && record.month <= 12) {
                monthCounts[record.month - 1]++;
            }
        });
        
        var maxIndex = monthCounts.indexOf(Math.max(...monthCounts));
        return monthNames[maxIndex];
    }
    
    // 计算预测下次
    function calculateNextPrediction() {
        if (alertRecords.length < 2) return '-';
        
        var avgInterval = calculateAverageInterval();
        if (avgInterval === '-') return '-';
        
        var lastRecord = getSortedRecordsDesc()[0];
        
        var lastDate = new Date(lastRecord.timestamp);
        var predictedDate = new Date(lastDate.getTime() + avgInterval * 24 * 60 * 60 * 1000);
        
        var now = new Date();
        var diffDays = Math.floor((predictedDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            return '已逾期';
        } else if (diffDays === 0) {
            return '今天';
        } else if (diffDays === 1) {
            return '明天';
        } else if (diffDays < 7) {
            return diffDays + '天后';
        } else {
            return predictedDate.getMonth() + 1 + '月' + predictedDate.getDate() + '日';
        }
    }
    
    // 生成智能建议
    function generateSmartAdvice() {
        if (alertRecords.length === 0) {
            document.getElementById('smartAdvice').innerHTML = '<p style="color: #666; text-align: center; margin: 0;">暂无数据，无法生成建议</p>';
            return;
        }
        
        var advice = [];
        
        // 使用缓存的风险分析数据
        var riskData = window.riskAnalysisData || {};
        var behaviorData = window.behaviorPatternData || {};
        
        // 基于风险等级的建议
        var riskLevel = riskData.riskLevel || calculateRiskLevel();
        if (riskLevel === '高风险') {
            advice.push('⚠️ <strong>高风险提醒</strong>：您的违章频率较高，建议立即调整驾驶习惯，避免连续违章。');
        } else if (riskLevel === '中风险') {
            advice.push('⚠️ <strong>中风险提醒</strong>：您的违章频率中等，建议注意驾驶规范，减少违章发生。');
        }
        
        // 基于连续天数的建议
        var maxConsecutive = riskData.maxConsecutiveDays || calculateMaxConsecutiveDays();
        if (maxConsecutive >= 3) {
            advice.push('🚨 <strong>连续违章警告</strong>：您曾连续' + maxConsecutive + '天违章，请特别注意避免连续违章行为。');
        }
        
        // 基于时间模式的建议
        var peakWeekday = behaviorData.peakWeekday || calculatePeakWeekday();
        var peakHour = behaviorData.peakHour || calculatePeakHour();
        advice.push('📅 <strong>时间提醒</strong>：您在' + peakWeekday + peakHour + '最容易违章，请在这些时段特别注意。');
        
        // 基于趋势的建议
        var trendStatus = riskData.trendStatus || calculateTrendStatus();
        if (trendStatus === '上升') {
            advice.push('📈 <strong>趋势提醒</strong>：您的违章频率呈上升趋势，建议加强安全意识。');
        } else if (trendStatus === '下降') {
            advice.push('📉 <strong>进步提醒</strong>：您的违章频率呈下降趋势，继续保持！');
        }
        
        // 基于预测的建议
        var nextPrediction = behaviorData.nextPrediction || calculateNextPrediction();
        if (nextPrediction !== '-' && nextPrediction !== '已逾期') {
            advice.push('🔮 <strong>预测提醒</strong>：根据历史数据，下次可能违章时间在' + nextPrediction + '，请提前注意。');
        }
        
        // 通用建议
        advice.push('💡 <strong>通用建议</strong>：遵守交通规则，保持安全车距，避免疲劳驾驶。');
        
        // 生成HTML
        var adviceHTML = '';
        advice.forEach(function(item) {
            adviceHTML += '<p style="margin: 8px 0; line-height: 1.5;">' + item + '</p>';
        });
        
        document.getElementById('smartAdvice').innerHTML = adviceHTML;
    }

    // 生成时段分布图
    function generateTimeChart() {
        var timeData = new Array(24).fill(0);
        var timeLabels = [];
        for (var i = 0; i < 24; i++) {
            timeLabels.push(i + '时');
        }
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                var hour = parseInt(record.time.split(':')[0]);
                if (!isNaN(hour) && hour >= 0 && hour < 24) {
                    timeData[hour]++;
                }
            }
        });
        var maxValue = Math.max(...timeData);
        var chartHTML = '';
        var nonZeroData = timeData.map(function(count, index) {
            return { count: count, hour: index };
        }).filter(function(item) {
            return item.count > 0;
        });
        if (nonZeroData.length > 12) {
            var groupedData = [];
            var groupSize = Math.ceil(nonZeroData.length / 12);
            for (var i = 0; i < nonZeroData.length; i += groupSize) {
                var group = nonZeroData.slice(i, i + groupSize);
                var totalCount = group.reduce(function(sum, item) { return sum + item.count; }, 0);
                var avgHour = Math.round(group.reduce(function(sum, item) { return sum + item.hour; }, 0) / group.length);
                groupedData.push({ count: totalCount, hour: avgHour });
            }
            nonZeroData = groupedData;
        }
        nonZeroData.forEach(function(item) {
            var height = maxValue > 0 ? (item.count / maxValue * 150) : 0;
            var color = '#44aa44';
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end;">
                    <div style="font-size: 10px; color: #666; margin-bottom: 2px; font-weight: bold;">${item.count}</div>
                    <div class="chart-bar" style="width: 15px; height: 0px; background: ${color}; border-radius: 3px; margin-bottom: 2px; transition: height 0.8s ease; cursor: pointer;" 
                         title="${item.hour}时: ${item.count}次" 
                         data-height="${height}"
                         data-hour="${item.hour}"
                         data-count="${item.count}"
                         onclick="showChartTooltip(event, '${item.hour}时', ${item.count}, '时段分布')"></div>
                    <div style="font-size: 8px; color: #666; margin-top: 2px;">${item.hour}时</div>
                </div>
            `;
        });
        document.getElementById('timeChart').innerHTML = chartHTML;
        setTimeout(function() {
            var bars = document.querySelectorAll('#timeChart .chart-bar');
            bars.forEach(function(bar) {
                var height = bar.getAttribute('data-height');
                bar.style.height = height + 'px';
                // 让柱状图支持滑动冒泡到mescroll
                bar.addEventListener('touchstart', function(e) { /* 不阻止冒泡 */ });
                bar.addEventListener('touchmove', function(e) { /* 不阻止冒泡 */ });
                bar.addEventListener('touchend', function(e) { /* 不阻止冒泡 */ });
            });
        }, 300);
    }

    // 底部-生成详细记录列表
    function generateRecordsList() {
        var recordsList = document.getElementById('recordsList');
        var recordsHTML = '';
        
        if (alertRecords.length === 0) {
            recordsHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无警报记录</div>';
        } else {
                    // 按时间倒序排列
        var sortedRecords = getSortedRecordsDesc();
            
            sortedRecords.forEach(function(record) {
                var date = new Date(record.timestamp);
                var weekdayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                
                // 截取短信内容，避免过长
                var shortContent = record.content.length > 50 ? record.content.substring(0, 50) + '...' : record.content;
                
                // 判断是否为测试记录：测试记录为浅灰色，正常记录为黑色，颜色区分便于阅读
                var isTestRecord = record.content.indexOf('测试') !== -1 || record.content.indexOf('TEST') !== -1 || record.content.indexOf('Test') !== -1;
                var textColor = isTestRecord ? '#999' : '#333'; // 测试记录为浅灰色，正常记录为黑色
                var bgColor = isTestRecord ? '#f0f0f0' : '#f8f8f8'; // 测试记录背景色稍浅
                var borderColor = isTestRecord ? '#ccc' : '#ff4444'; // 测试记录边框为灰色
                
                var isSelected = selectedRecords.indexOf(record.id.toString()) !== -1;
                var selectionStyle = isSelected ? 'background: #007aff; color: white;' : '';
                var selectionIcon = isSelected ? '✓' : '';
                
                // 允许通过长按触发多选删除，同时支持滑动删除
                recordsHTML += `
                    <div class="records-item-container">
                        <div class="records-item${isSelected ? ' selected' : ''}" 
                             style="background: ${bgColor}; border-left: 4px solid ${borderColor};" 
                             data-record-id="${record.id}"
                             data-touch-start-x="0"
                             data-touch-start-y="0"
                             data-touch-current-x="0"
                             data-touch-current-y="0"
                             data-is-touching="false"
                             data-swipe-threshold="50"
                             onclick="handleRecordClick('${record.id}')"
                             onmousedown="handleMouseDown(event, '${record.id}')"
                             onmousemove="handleMouseMove(event)"
                             onmouseup="handleMouseUp(event, '${record.id}')"
                             onmouseleave="handleMouseLeave()">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="font-weight: bold; color: ${textColor};">${record.date} ${record.time}</div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="font-size: 12px; color: ${isTestRecord ? '#999' : '#666'};">${weekdayNames[record.weekday]}</div>
                                    ${isMultiSelectMode ? `<div class="selection-box" 
                                        style="width: 24px; height: 24px; border: 2px solid #007aff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin-left: 10px; z-index: 1000; position: relative; cursor: pointer; ${selectionStyle}" 
                                        onclick="event.stopPropagation(); toggleRecordSelection('${record.id}');"
                                        onmousedown="event.stopPropagation();"
                                        onmouseup="event.stopPropagation();">${selectionIcon}</div>` : ''}
                                </div>
                            </div>
                            <div style="font-size: 12px; color: ${isTestRecord ? '#999' : '#666'}; margin-bottom: 5px;">来自: ${record.phoneNumber}</div>
                            <div style="font-size: 12px; color: ${textColor}; line-height: 1.4; word-break: break-all;">${shortContent}</div>
                        </div>
                        <div class="delete-button" onclick="deleteSingleRecord('${record.id}')">
                            删除
                        </div>
                        ${!isMultiSelectMode ? '<div class="swipe-hint">← 左滑删除</div>' : ''}
                    </div>
                `;
            });
        }
        
        recordsList.innerHTML = recordsHTML;
        
        // 绑定触摸事件监听器
        bindTouchEvents();
    }

    // 绑定触摸和鼠标事件监听器
    function bindTouchEvents() {
        var recordItems = document.querySelectorAll('.records-item');
        recordItems.forEach(function(item) {
            // 移除之前的事件监听器
            item.removeEventListener('touchstart', handleTouchStart);
            item.removeEventListener('touchmove', handleTouchMove);
            item.removeEventListener('touchend', handleTouchEnd);
            item.removeEventListener('mousedown', handleMouseDownForSwipe);
            item.removeEventListener('mousemove', handleMouseMoveForSwipe);
            item.removeEventListener('mouseup', handleMouseUpForSwipe);
            item.removeEventListener('mouseleave', handleMouseLeaveForSwipe);
            
            // 添加触摸事件监听器，使用更安全的方式
            item.addEventListener('touchstart', handleTouchStart, { passive: true });
            item.addEventListener('touchmove', handleTouchMove, { passive: false });
            item.addEventListener('touchend', handleTouchEnd, { passive: true });
            
            // 添加鼠标事件监听器（用于桌面端）
            item.addEventListener('mousedown', handleMouseDownForSwipe, { passive: true });
            item.addEventListener('mousemove', handleMouseMoveForSwipe, { passive: true });
            item.addEventListener('mouseup', handleMouseUpForSwipe, { passive: true });
            item.addEventListener('mouseleave', handleMouseLeaveForSwipe, { passive: true });
        });
    }

    // 切换年份
    function changeYear(year) {
        currentYear = parseInt(year);
        
        // 更新标题
        document.getElementById('pageTitle').textContent = currentYear + '年违停警报统计';
        
        // 重新生成年份选择器选项（保持当前选中状态）
        // generateYearOptions(); // 不需要重新生成
        
        // 加载对应年份的数据
        loadYearData(currentYear);
        
        // 重新生成统计
        generateStatistics();
        
        console.log('已切换到' + currentYear + '年');
    }

    // 加载指定年份的数据
    function loadYearData(year) {
        try {
            var savedRecords = api.getPrefs({sync: true, key: 'alertRecords_' + year});
            if (savedRecords) {
                alertRecords = JSON.parse(savedRecords);
                console.log('已加载' + year + '年的' + alertRecords.length + '条警报记录');
            } else {
                alertRecords = [];
                console.log('未找到' + year + '年的警报记录');
            }
        } catch (e) {
            alertRecords = [];
            console.log('加载' + year + '年警报记录失败: ' + e.message);
        }
    }

    // 显示记录详情
    function showRecordDetail(recordId) {
        var record = alertRecords.find(function(r) {
            return r.id.toString() === recordId;
        });
        
        if (!record) {
            api.toast({
                msg: '未找到记录',
                duration: 2000,
                location: 'bottom'
            });
            return;
        }
        
        var weekdayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
        
        // 判断是否为测试记录：测试记录为浅灰色，正常记录为黑色，颜色区分便于阅读
        var isTestRecord = record.content.indexOf('TEST') !== -1 || record.content.indexOf('测试') !== -1;
        var textColor = isTestRecord ? '#999' : '#333';
        var bgColor = isTestRecord ? '#f0f0f0' : '#f8f8f8';
        var titleColor = isTestRecord ? '#999' : '#333';
        var titleText = isTestRecord ? '测试警报详情' : '警报详情';
        
        var detailHTML = `
        <div class="detail-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
            <div class="detail-modal" style="background: white; border-radius: 10px; padding: 20px; margin: 20px; max-width: 90%; max-height: 80%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: ${titleColor};">${titleText}</h3>
                    <button onclick="closeRecordDetail()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">×</button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: ${textColor};">时间：</span>
                        <span style="color: ${isTestRecord ? '#999' : '#666'};">${record.date} ${record.time}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: ${textColor};">星期：</span>
                        <span style="color: ${isTestRecord ? '#999' : '#666'};">${weekdayNames[record.weekday]}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: ${textColor};">来源号码：</span>
                        <span style="color: ${isTestRecord ? '#999' : '#666'};">${record.phoneNumber}</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; color: ${textColor}; margin-bottom: 8px;">短信内容：</div>
                    <div style="background: ${bgColor}; padding: 10px; border-radius: 5px; line-height: 1.5; color: ${textColor}; white-space: pre-wrap; word-break: break-all;">${record.content}</div>
                </div>
                
                <div style="text-align: center; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="deleteSingleRecord('${recordId}')" style="padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">删除</button>
                    <button onclick="closeRecordDetail()" style="padding: 10px 20px; background: #007aff; color: white; border: none; border-radius: 5px; cursor: pointer;">关闭</button>
                </div>
            </div>
        </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailHTML);

        // 防止滑动穿透
        document.body.style.overflow = 'hidden';
        
        // 添加淡入动画
        var detailModal = document.querySelector('.detail-modal');
        if (detailModal) {
            detailModal.classList.add('dialog-fade');
            setTimeout(function() {
                detailModal.classList.add('show');
            }, 10);
        }
        
        // 增强滑动穿透防护：阻止背景页面滚动
        function preventBackgroundScroll(e) {
            e.preventDefault();
        }
        document.addEventListener('touchmove', preventBackgroundScroll, { passive: false });
        
        // 实现点击弹窗外部区域关闭弹窗
        var detailOverlay = document.querySelector('.detail-overlay');
        var detailModal = document.querySelector('.detail-modal');
        if (detailOverlay && detailModal) {
            // 使用setTimeout确保弹窗完全渲染后再绑定事件
            setTimeout(function() {
                detailOverlay.addEventListener('click', function(e) {
                    // 检查点击目标是否是覆盖层本身，而不是弹窗内容
                    if (e.target === detailOverlay) {
                        closeRecordDetail();
                    }
                });
            }, 100);
        }
        
        // 保存事件引用以便后续移除
        window.detailEventListeners = {
            preventBackgroundScroll: preventBackgroundScroll
        };
    }

    // 关闭记录详情
    function closeRecordDetail() {
        var detailOverlay = document.querySelector('.detail-overlay');
        var detailModal = document.querySelector('.detail-modal');
        
        // 移除滑动穿透防护
        if (window.detailEventListeners && window.detailEventListeners.preventBackgroundScroll) {
            document.removeEventListener('touchmove', window.detailEventListeners.preventBackgroundScroll);
            window.detailEventListeners = null;
        }
        
        if (detailModal) {
            detailModal.classList.remove('show');
            setTimeout(function() {
                if (detailOverlay) detailOverlay.remove();
                document.body.style.overflow = '';
            }, 250); // 动画时长要和CSS一致
        } else {
            if (detailOverlay) detailOverlay.remove();
            document.body.style.overflow = '';
        }
    }



    // 触摸开始处理
    function handleTouchStart(event) {
        if (isMultiSelectMode) return; // 多选模式下禁用滑动删除
        
        var touch = event.touches[0];
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        recordItem.setAttribute('data-touch-start-x', touch.clientX);
        recordItem.setAttribute('data-touch-start-y', touch.clientY);
        recordItem.setAttribute('data-touch-current-x', touch.clientX);
        recordItem.setAttribute('data-touch-current-y', touch.clientY);
        recordItem.setAttribute('data-is-touching', 'true');
        
        isSwipeInProgress = false; // 重置滑动状态
        
        // 同时触发长按逻辑
        handleMouseDown(event, recordId);
        // 不要在touchstart中调用preventDefault
    }



    // 鼠标按下处理（也处理触摸事件）
    function handleMouseDown(event, recordId) {
        // 获取正确的坐标（支持触摸和鼠标）
        var clientY = event.clientY || (event.touches && event.touches[0] ? event.touches[0].clientY : 0);
        
        touchStartY = clientY;
        touchStartTime = Date.now();
        hasMoved = false;
        
        // 添加长按视觉反馈
        var element = event.target.closest('.records-item');
        if (element) {
            element.classList.add('long-pressing');
        }
        
        // 开始长按计时器
        longPressTimer = setTimeout(function() {
            if (!hasMoved && !isMultiSelectMode && !isSwipeInProgress) {
                enterMultiSelectMode(recordId);
            }
        }, longPressThreshold);
    }

    // 鼠标移动处理（也处理触摸事件）
    function handleMouseMove(event) {
        if (longPressTimer) {
            // 获取正确的坐标（支持触摸和鼠标）
            var clientY = event.clientY || (event.touches && event.touches[0] ? event.touches[0].clientY : 0);
            var moveDistance = Math.abs(clientY - touchStartY);
            
            if (moveDistance > moveThreshold) {
                hasMoved = true;
                clearTimeout(longPressTimer);
                longPressTimer = null;
                
                // 移除长按视觉反馈
                var element = document.querySelector('.records-item.long-pressing');
                if (element) {
                    element.classList.remove('long-pressing');
                }
            }
        }
    }

    // 鼠标抬起处理
    function handleMouseUp(event, recordId) {
        var touchDuration = Date.now() - touchStartTime;
        
        // 移除长按视觉反馈
        var element = event.target.closest('.records-item');
        if (element) {
            element.classList.remove('long-pressing');
        }
        
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
        
        // 新增：如果刚刚长按进入多选，则本次不处理点击
        if (justEnteredMultiSelectByLongPress) {
            justEnteredMultiSelectByLongPress = false;
            return;
        }
        
        // 如果没有移动且时间足够短，则认为是点击
        if (!hasMoved && touchDuration < longPressThreshold) {
            handleRecordClick(recordId);
        }
        
        // 重置状态
        hasMoved = false;
        touchStartY = 0;
        touchStartTime = 0;
    }

    // 鼠标离开处理
    function handleMouseLeave() {
        // 移除长按视觉反馈
        var element = document.querySelector('.records-item.long-pressing');
        if (element) {
            element.classList.remove('long-pressing');
        }
        
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
        hasMoved = false;
        touchStartY = 0;
        touchStartTime = 0;
    }

    // 处理记录点击
    function handleRecordClick(recordId) {
        // 检查是否在滑动状态或记录项正在滑动中
        if (isSwipeInProgress) {
            return; // 如果正在滑动，不触发点击事件
        }
        
        var recordItem = document.querySelector(`[data-record-id="${recordId}"]`);
        if (!recordItem) {
            return;
        }
        
        // 如果记录项正在滑动中或已滑动显示删除按钮，不触发点击事件
        if (recordItem.classList.contains('swiping') || recordItem.classList.contains('swiped')) {
            return;
        }
        
        if (isMultiSelectMode) {
            // 在多选模式下，点击整行记录都可以切换选择状态
            toggleRecordSelection(recordId);
        } else {
            showRecordDetail(recordId);
        }
    }

    // 切换多选模式
    function toggleMultiSelect() {
        if (isMultiSelectMode) {
            exitMultiSelectMode();
        } else {
            enterMultiSelectMode();
        }
    }

    // 进入多选模式
    function enterMultiSelectMode(preSelectRecordId) {
        isMultiSelectMode = true;
        selectedRecords = [];
        
        // 如果指定了要预先选中的记录，则添加到选中列表
        if (preSelectRecordId) {
            selectedRecords.push(preSelectRecordId);
            justEnteredMultiSelectByLongPress = true;
        }
        
        document.getElementById('multiSelectBtn').textContent = '退出多选';
        document.getElementById('multiSelectBtn').style.background = '#ff8800';
        document.getElementById('multiSelectActions').style.display = 'block';
        updateSelectedCount();
        
        // 重置所有滑动状态
        resetAllSwipeStates();
        
        generateRecordsList(); // 重新生成列表以显示选择框
    }

    // 退出多选模式
    function exitMultiSelectMode() {
        isMultiSelectMode = false;
        selectedRecords = [];
        document.getElementById('multiSelectBtn').textContent = '多选删除';
        document.getElementById('multiSelectBtn').style.background = '#007aff';
        document.getElementById('multiSelectActions').style.display = 'none';
        
        // 重置所有滑动状态
        resetAllSwipeStates();
        
        generateRecordsList(); // 重新生成列表以隐藏选择框
    }

    // 切换记录选择状态
    function toggleRecordSelection(recordId) {
        var index = selectedRecords.indexOf(recordId);
        if (index === -1) {
            selectedRecords.push(recordId);
        } else {
            selectedRecords.splice(index, 1);
        }
        
        updateSelectedCount();
        
        // 更新当前项的样式和选择框
        var recordItem = document.querySelector(`[data-record-id="${recordId}"]`);
        if (recordItem) {
            // 更新记录项的选中状态
            if (selectedRecords.indexOf(recordId) !== -1) {
                recordItem.classList.add('selected');
            } else {
                recordItem.classList.remove('selected');
            }
            
            // 更新选择框的样式
            var selectionBox = recordItem.querySelector('.selection-box');
            if (selectionBox) {
                var isSelected = selectedRecords.indexOf(recordId) !== -1;
                if (isSelected) {
                    selectionBox.style.background = '#007aff';
                    selectionBox.style.color = 'white';
                    selectionBox.style.fontWeight = 'bold';
                    selectionBox.style.fontSize = '14px';
                    selectionBox.style.borderColor = '#0056cc';
                    selectionBox.style.boxShadow = '0 2px 4px rgba(0,122,255,0.3)';
                    selectionBox.textContent = '✓';
                } else {
                    selectionBox.style.background = '#f0f0f0';
                    selectionBox.style.color = '#999';
                    selectionBox.style.fontWeight = 'normal';
                    selectionBox.style.fontSize = '12px';
                    selectionBox.style.borderColor = '#007aff';
                    selectionBox.style.boxShadow = 'none';
                    selectionBox.textContent = '';
                }
            }
        }
    }

    // 全选记录
    function selectAllRecords() {
        selectedRecords = alertRecords.map(function(record) {
            return record.id.toString();
        });
        updateSelectedCount();
        generateRecordsList();
    }

    // 取消全选
    function deselectAllRecords() {
        selectedRecords = [];
        updateSelectedCount();
        generateRecordsList();
    }

    // 更新选中数量显示
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = selectedRecords.length;
    }

    // 删除选中的记录
    function deleteSelectedRecords() {
        let deleteCount = selectedRecords.length;
        if (deleteCount === 0) {
            api.toast({
                msg: '请先选择要删除的记录',
                duration: 2000,
                location: 'bottom'
            });
            return;
        }

        // 设置对话框打开状态
        isConfirmDialogOpen = true;

        api.confirm({
            title: '确认删除',
            msg: '确定要删除选中的 ' + deleteCount + ' 条记录吗？此操作不可恢复。',
            buttons: ['取消', '确定删除']
        }, function(ret) {
            // 重置对话框状态
            isConfirmDialogOpen = false;

            if (ret.buttonIndex === 2) {
                // 删除选中的记录
                alertRecords = alertRecords.filter(function(record) {
                    return selectedRecords.indexOf(record.id.toString()) === -1;
                });
                
                // 保存更新后的记录
                saveAlertRecords();
                
                // 退出多选模式
                exitMultiSelectMode();
                
                // 重新生成统计
                generateStatistics();
                
                api.toast({
                    msg: '已删除 ' + deleteCount + ' 条记录',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
    }



    // 导出统计数据
    function exportStatistics() {
        if (alertRecords.length === 0) {
            api.toast({
                msg: '暂无数据可导出',
                duration: 2000,
                location: 'bottom'
            });
            return;
        }
        
        try {
            var exportData = {
                year: currentYear,
                totalAlerts: alertRecords.length,
                records: alertRecords,
                exportTime: new Date().toISOString()
            };
            
            var dataStr = JSON.stringify(exportData, null, 2);
            var fileName = `违停警报统计_${currentYear}年_${new Date().toISOString().split('T')[0]}.json`;
            
            // 这里可以调用文件保存API            
            api.writeFile({
                path: "fs://export/" + fileName,
                data: dataStr
            }, function(ret, err) {
                if (ret && ret.status) {
                    console.log('数据已写入文件：' + fileName );
                    api.toast({
                        msg: '数据已写入文件：' + fileName,
                        duration: 2000,
                        location: 'bottom'
                    });
                } else {
                    console.log('写入文件失败: ' + JSON.stringify(err));
                }
            });
            
            console.log('统计数据导出成功: ' + fileName);
        } catch (e) {
            console.log('数据导出失败: ' + e.message);
            api.toast({
                msg: '数据导出失败: ' + e.message,
                duration: 2000,
                location: 'bottom'
            });
        }
    }

    // 清空统计记录
    function clearStatistics() {
        // 设置对话框打开状态
        isConfirmDialogOpen = true;

        api.confirm({
            title: '确认清空',
            msg: '确定要清空' + currentYear + '年的所有警报记录吗？此操作不可恢复。',
            buttons: ['取消', '确定清空']
        }, function(ret) {
            // 重置对话框状态
            isConfirmDialogOpen = false;

            if (ret.buttonIndex === 2) {
                alertRecords = [];
                saveAlertRecords();
                console.log('已清空' + currentYear + '年的所有警报记录');
                
                // 刷新统计页面
                generateStatistics();
                
                api.toast({
                    msg: currentYear + '年记录已清空',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
    }

    // 保存警报记录到本地存储
    function saveAlertRecords() {
        try {
            api.setPrefs({
                key: 'alertRecords_' + currentYear,
                value: JSON.stringify(alertRecords)
            });
        } catch (e) {
            console.log('保存警报记录失败: ' + e.message);
        }
    }

    // 分享统计结果
    function shareStatistics() {
        if (alertRecords.length === 0) {
            api.toast({
                msg: '暂无数据可分享',
                duration: 2000,
                location: 'bottom'
            });
            return;
        }
        
        try {
            // 生成分享文本
            var shareText = generateShareText();
            console.log('分享文本：' + shareText);
            
            // 调用系统分享功能
            shareAction.shareText({
                text: shareText
            });
        } catch (e) {
            console.log('分享功能异常: ' + e.message);
            api.toast({
                msg: '分享功能异常',
                duration: 2000,
                location: 'bottom'
            });
        }
    }

    // 生成分享文本
    function generateShareText() {
        var totalAlerts = alertRecords.length;
        var avgPerMonth = totalAlerts > 0 ? (totalAlerts / 12).toFixed(1) : 0;
        
        // 计算最高月次数
        var monthlyData = new Array(12).fill(0);
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.month >= 1 && record.month <= 12) {
                    monthlyData[record.month - 1]++;
                }
            }
        });
        var maxMonth = Math.max(...monthlyData);
        
        // 计算最近警报时间
        var lastAlert = '无';
        if (alertRecords.length > 0) {
            var lastRecord = getSortedRecordsDesc()[0];
            
            // 获取当前日期和记录日期（只比较日期部分，忽略时间）
            var now = new Date();
            var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            var lastDate = new Date(lastRecord.timestamp);
            var recordDate = new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate());
            
            // 计算日期差（毫秒）
            var diffTime = today.getTime() - recordDate.getTime();
            var diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                lastAlert = '今天';
            } else if (diffDays === 1) {
                lastAlert = '昨天';
            } else if (diffDays < 7) {
                lastAlert = diffDays + '天前';
            } else {
                // 只显示月和日，不显示年份
                var dateParts = lastRecord.date.split('-');
                if (dateParts.length === 3) {
                    lastAlert = dateParts[1] + '-' + dateParts[2];
                } else {
                    lastAlert = lastRecord.date;
                }
            }
        }
        
        // 使用缓存的风险分析数据和行为模式数据
        var riskData = window.riskAnalysisData || {};
        var behaviorData = window.behaviorPatternData || {};
        
        var maxConsecutiveDays = riskData.maxConsecutiveDays || calculateMaxConsecutiveDays();
        var avgInterval = riskData.avgInterval || calculateAverageInterval();
        var trendStatus = riskData.trendStatus || calculateTrendStatus();
        var riskLevel = riskData.riskLevel || calculateRiskLevel();
        
        var peakWeekday = behaviorData.peakWeekday || calculatePeakWeekday();
        var peakHour = behaviorData.peakHour || calculatePeakHour();
        var peakMonth = behaviorData.peakMonth || calculatePeakMonth();
        var nextPrediction = behaviorData.nextPrediction || calculateNextPrediction();
        
        var shareText = `🚨 ${currentYear}年违停警报统计报告
        
📊 统计概览：
• 总警报次数：${totalAlerts}次
• 月平均次数：${avgPerMonth}次
• 最高月次数：${maxMonth}次
• 最近警报：${lastAlert}

⚠️ 风险分析：
• 最长连续天数：${maxConsecutiveDays}天
• 平均间隔：${avgInterval}天
• 近期趋势：${trendStatus}
• 风险等级：${riskLevel}

📈 行为模式：
• 最频繁星期：${peakWeekday}
• 最频繁时段：${peakHour}
• 最频繁月份：${peakMonth}
• 预测下次：${nextPrediction}

💡 使用交警短信提醒APP，及时掌握违章信息，避免逾期处理！

#交警短信提醒 #违章统计 #安全驾驶`;
        
        return shareText;
    }

    // 显示图表悬浮提示框
    function showChartTooltip(event, label, count, chartType) {
        // 移除之前的选中状态
        document.querySelectorAll('.chart-bar.selected').forEach(function(bar) {
            bar.classList.remove('selected');
        });
        
        // 添加当前柱子的选中状态
        event.target.classList.add('selected');
        
        var tooltip = document.getElementById('chartTooltip');
        var rect = event.target.getBoundingClientRect();
        
        // 计算提示框位置
        var left = rect.left + rect.width / 2;
        var top = rect.top - 10;
        
        // 计算百分比
        var totalCount = 0;
        switch(chartType) {
            case '月度趋势':
                var monthlyData = new Array(12).fill(0);
                alertRecords.forEach(function(record) {
                    if (record.year === currentYear && record.month >= 1 && record.month <= 12) {
                        monthlyData[record.month - 1]++;
                    }
                });
                totalCount = monthlyData.reduce((sum, val) => sum + val, 0);
                break;
            case '星期分布':
                var weekdayData = new Array(7).fill(0);
                alertRecords.forEach(function(record) {
                    if (record.year === currentYear && record.weekday >= 0 && record.weekday < 7) {
                        weekdayData[record.weekday]++;
                    }
                });
                totalCount = weekdayData.reduce((sum, val) => sum + val, 0);
                break;
            case '时段分布':
                var timeData = new Array(24).fill(0);
                alertRecords.forEach(function(record) {
                    if (record.year === currentYear) {
                        var hour = parseInt(record.time.split(':')[0]);
                        if (!isNaN(hour) && hour >= 0 && hour < 24) {
                            timeData[hour]++;
                        }
                    }
                });
                totalCount = timeData.reduce((sum, val) => sum + val, 0);
                break;
        }
        
        var percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(1) : 0;
        
        // 生成提示内容
        var tooltipContent = '';
        var icon = '';
        switch(chartType) {
            case '月度趋势':
                icon = '📅';
                tooltipContent = `${icon} <strong>${label}</strong><br>警报次数：${count}次<br>占比：${percentage}%`;
                break;
            case '星期分布':
                icon = '📆';
                tooltipContent = `${icon} <strong>${label}</strong><br>警报次数：${count}次<br>占比：${percentage}%`;
                break;
            case '时段分布':
                icon = '🕐';
                tooltipContent = `${icon} <strong>${label}</strong><br>警报次数：${count}次<br>占比：${percentage}%`;
                break;
            default:
                tooltipContent = `${label}：${count}次`;
        }
        
        // 设置提示框内容和位置
        tooltip.innerHTML = tooltipContent;
        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
        
        // 显示提示框
        tooltip.classList.add('show');
        // 滑动时自动隐藏tooltip
        var hideTooltipOnMove = function() {
            hideChartTooltip();
            document.removeEventListener('touchmove', hideTooltipOnMove);
            document.removeEventListener('scroll', hideTooltipOnMove);
        };
        document.addEventListener('touchmove', hideTooltipOnMove, { passive: true });
        document.addEventListener('scroll', hideTooltipOnMove, { passive: true });
        // 4秒后自动隐藏
        setTimeout(function() {
            hideChartTooltip();
            document.removeEventListener('touchmove', hideTooltipOnMove);
            document.removeEventListener('scroll', hideTooltipOnMove);
        }, 4000);
    }

    // 隐藏图表悬浮提示框
    function hideChartTooltip() {
        var tooltip = document.getElementById('chartTooltip');
        tooltip.classList.remove('show');
    }

    // 点击页面其他地方时隐藏提示框
    document.addEventListener('click', function(event) {
        if (!event.target.classList.contains('chart-bar')) {
            hideChartTooltip();
        }
    });

    // 触摸事件处理 - 滑动删除功能
    function handleTouchStart(event) {
        if (isMultiSelectMode) return; // 多选模式下禁用滑动删除
        
        var touch = event.touches[0];
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        recordItem.setAttribute('data-touch-start-x', touch.clientX);
        recordItem.setAttribute('data-touch-start-y', touch.clientY);
        recordItem.setAttribute('data-touch-current-x', touch.clientX);
        recordItem.setAttribute('data-touch-current-y', touch.clientY);
        recordItem.setAttribute('data-is-touching', 'true');
        
        isSwipeInProgress = false; // 重置滑动状态
        
        // 同时触发长按逻辑
        handleMouseDown(event, recordId);
        // 不要在touchstart中调用preventDefault
    }

    function handleTouchMove(event) {
        var touch = event.touches[0];
        var recordItem = event.currentTarget;
        
        if (recordItem.getAttribute('data-is-touching') !== 'true') return;
        
        // 更新当前触摸位置
        recordItem.setAttribute('data-touch-current-x', touch.clientX);
        recordItem.setAttribute('data-touch-current-y', touch.clientY);
        
        if (isMultiSelectMode) {
            // 多选模式下只记录位置，不处理滑动
            return;
        }
        
        // 非多选模式下的滑动删除逻辑
        var startX = parseInt(recordItem.getAttribute('data-touch-start-x'));
        var currentX = parseInt(recordItem.getAttribute('data-touch-current-x'));
        var startY = parseInt(recordItem.getAttribute('data-touch-start-y'));
        var currentY = parseInt(recordItem.getAttribute('data-touch-current-y'));
        
        var deltaX = currentX - startX;
        var deltaY = Math.abs(currentY - startY);
        
        // 同时触发长按移动逻辑
        handleMouseMove(event);
        
        // 只处理水平滑动，垂直滑动距离不能太大
        if (deltaY < 50 && deltaX < 0) {
            var swipeDistance = Math.min(Math.abs(deltaX), 80);
            recordItem.style.transform = `translateX(-${swipeDistance}px)`;
            recordItem.classList.add('swiping');
            isSwipeInProgress = true; // 标记正在滑动
            // 只有在实际进行滑动时才阻止默认滚动
            if (event.cancelable) {
                event.preventDefault();
            }
        }
    }

    function handleTouchEnd(event) {
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        // 新增：如果刚刚长按进入多选，则本次不处理点击
        if (justEnteredMultiSelectByLongPress) {
            justEnteredMultiSelectByLongPress = false;
            return;
        }
        
        if (isMultiSelectMode) {
            // 多选模式下，直接处理点击事件
            if (recordItem.getAttribute('data-is-touching') === 'true') {
                var startX = parseInt(recordItem.getAttribute('data-touch-start-x'));
                var currentX = parseInt(recordItem.getAttribute('data-touch-current-x'));
                var startY = parseInt(recordItem.getAttribute('data-touch-start-y'));
                var currentY = parseInt(recordItem.getAttribute('data-touch-current-y'));
                
                var deltaX = Math.abs(currentX - startX);
                var deltaY = Math.abs(currentY - startY);
                
                // 如果移动距离很小，认为是点击
                if (deltaX < 10 && deltaY < 10) {
                    handleRecordClick(recordId);
                }
            }
            return;
        }
        
        // 非多选模式下的滑动删除逻辑
        if (recordItem.getAttribute('data-is-touching') !== 'true') return;
        
        var startX = parseInt(recordItem.getAttribute('data-touch-start-x'));
        var currentX = parseInt(recordItem.getAttribute('data-touch-current-x'));
        var swipeThreshold = parseInt(recordItem.getAttribute('data-swipe-threshold'));
        
        var deltaX = currentX - startX;
        
        // 移除滑动状态
        recordItem.classList.remove('swiping');
        
        // 如果滑动距离超过阈值，显示删除按钮
        if (deltaX < -swipeThreshold) {
            // 先重置其他项的滑动状态，确保只有当前项显示删除按钮
            resetOtherSwipeStates(recordId);
            // 使用transform实现平滑过渡到显示删除按钮的位置
            recordItem.style.transform = 'translateX(-80px)';
            // 添加延迟以确保过渡动画完成后再添加swiped类
            setTimeout(function() {
                recordItem.classList.add('swiped');
            }, 300);
        } else {
            // 平滑过渡回原始位置
            recordItem.style.transform = 'translateX(0)';
            // 添加延迟以确保过渡动画完成后再移除swiped类
            setTimeout(function() {
                recordItem.classList.remove('swiped');
            }, 300);
        }
        
        recordItem.setAttribute('data-is-touching', 'false');
        // 延迟重置滑动状态，确保动画完成
        setTimeout(function() {
            isSwipeInProgress = false; // 重置滑动状态
        }, 300);
        
        // 同时触发长按结束逻辑
        handleMouseUp(event, recordId);
    }

    // 鼠标事件处理 - 滑动删除功能（桌面端支持）
    function handleMouseDownForSwipe(event) {
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        // 记录鼠标开始位置
        recordItem.setAttribute('data-mouse-start-x', event.clientX);
        recordItem.setAttribute('data-mouse-start-y', event.clientY);
        recordItem.setAttribute('data-mouse-current-x', event.clientX);
        recordItem.setAttribute('data-mouse-current-y', event.clientY);
        recordItem.setAttribute('data-is-mousing', 'true');
        
        // 同时触发长按逻辑
        handleMouseDown(event, recordId);
        // 不要在mousedown中调用preventDefault
    }

    function handleMouseMoveForSwipe(event) {
        var recordItem = event.currentTarget;
        
        if (recordItem.getAttribute('data-is-mousing') !== 'true') return;
        
        // 更新当前鼠标位置
        recordItem.setAttribute('data-mouse-current-x', event.clientX);
        recordItem.setAttribute('data-mouse-current-y', event.clientY);
        
        if (isMultiSelectMode) {
            // 多选模式下只记录位置，不处理滑动
            return;
        }
        
        // 非多选模式下的滑动删除逻辑
        var startX = parseInt(recordItem.getAttribute('data-mouse-start-x'));
        var currentX = parseInt(recordItem.getAttribute('data-mouse-current-x'));
        var startY = parseInt(recordItem.getAttribute('data-mouse-start-y'));
        var currentY = parseInt(recordItem.getAttribute('data-mouse-current-y'));
        
        var deltaX = currentX - startX;
        var deltaY = Math.abs(currentY - startY);
        
        // 同时触发长按移动逻辑
        handleMouseMove(event);
        
        // 只处理水平滑动，垂直滑动距离不能太大
        if (deltaY < 50 && deltaX < 0) {
            var swipeDistance = Math.min(Math.abs(deltaX), 80);
            recordItem.style.transform = `translateX(-${swipeDistance}px)`;
            recordItem.classList.add('swiping');
            isSwipeInProgress = true; // 标记正在滑动
        }
        // 不要在mousemove中调用preventDefault
    }

    function handleMouseUpForSwipe(event) {
        var recordItem = event.currentTarget;
        var recordId = recordItem.getAttribute('data-record-id');
        
        if (isMultiSelectMode) {
            // 多选模式下，直接处理点击事件
            if (recordItem.getAttribute('data-is-mousing') === 'true') {
                var startX = parseInt(recordItem.getAttribute('data-mouse-start-x'));
                var currentX = parseInt(recordItem.getAttribute('data-mouse-current-x'));
                var startY = parseInt(recordItem.getAttribute('data-mouse-start-y'));
                var currentY = parseInt(recordItem.getAttribute('data-mouse-current-y'));
                
                var deltaX = Math.abs(currentX - startX);
                var deltaY = Math.abs(currentY - startY);
                
                // 如果移动距离很小，认为是点击
                if (deltaX < 10 && deltaY < 10) {
                    handleRecordClick(recordId);
                }
            }
            return;
        }
        
        // 非多选模式下的滑动删除逻辑
        if (recordItem.getAttribute('data-is-mousing') !== 'true') return;
        
        var startX = parseInt(recordItem.getAttribute('data-mouse-start-x'));
        var currentX = parseInt(recordItem.getAttribute('data-mouse-current-x'));
        var swipeThreshold = parseInt(recordItem.getAttribute('data-swipe-threshold'));
        
        var deltaX = currentX - startX;
        
        // 移除滑动状态
        recordItem.classList.remove('swiping');
        
        // 如果滑动距离超过阈值，显示删除按钮
        if (deltaX < -swipeThreshold) {
            // 先重置其他项的滑动状态，确保只有当前项显示删除按钮
            resetOtherSwipeStates(recordId);
            // 使用transform实现平滑过渡到显示删除按钮的位置
            recordItem.style.transform = 'translateX(-80px)';
            // 添加延迟以确保过渡动画完成后再添加swiped类
            setTimeout(function() {
                recordItem.classList.add('swiped');
            }, 300);
        } else {
            // 平滑过渡回原始位置
            recordItem.style.transform = 'translateX(0)';
            // 添加延迟以确保过渡动画完成后再移除swiped类
            setTimeout(function() {
                recordItem.classList.remove('swiped');
            }, 300);
        }
        
        recordItem.setAttribute('data-is-mousing', 'false');
        isSwipeInProgress = false; // 重置滑动状态
        
        // 同时触发长按结束逻辑
        handleMouseUp(event, recordId);
    }

    function handleMouseLeaveForSwipe(event) {
        if (isMultiSelectMode) return; // 多选模式下禁用滑动删除
        
        var recordItem = event.currentTarget;
        
        if (recordItem.getAttribute('data-is-mousing') === 'true') {
            recordItem.classList.remove('swiping');
            recordItem.classList.remove('swiped');
            recordItem.style.transform = '';
            recordItem.setAttribute('data-is-mousing', 'false');
            // 延迟重置滑动状态，确保动画完成
            setTimeout(function() {
                isSwipeInProgress = false; // 重置滑动状态
            }, 300);
        }
    }

    // 删除单条记录
    function deleteSingleRecord(recordId) {
        var record = alertRecords.find(function(r) {
            return r.id.toString() === recordId;
        });
        
        if (!record) {
            api.toast({
                msg: '未找到记录',
                duration: 2000,
                location: 'bottom'
            });
            return;
        }
        
        // 显示确认弹窗
        var confirmMsg = '确定要删除这条警报记录吗？\n\n';
        confirmMsg += '📅 时间：' + record.date + ' ' + record.time + '\n';
        confirmMsg += '📱 来源：' + record.phoneNumber + '\n';
        confirmMsg += '📝 内容：' + (record.content.length > 40 ? record.content.substring(0, 40) + '...' : record.content);
        
        api.confirm({
            title: '确认删除',
            msg: confirmMsg,
            buttons: ['取消', '确定删除']
        }, function(ret) {
            if (ret.buttonIndex === 2) {
                // 从数组中移除记录
                var index = alertRecords.findIndex(function(r) {
                    return r.id.toString() === recordId;
                });
                
                if (index !== -1) {
                    alertRecords.splice(index, 1);
                    
                    // 保存到本地存储
                    saveAlertRecords();
                    
                    // 清除缓存
                    clearCache();
                    
                    // 重新生成统计和列表
                    generateStatistics();
                    
                    // 隐藏删除按钮
                    var recordItem = document.querySelector(`[data-record-id="${recordId}"]`);
                    if (recordItem) {
                        recordItem.classList.remove('swiped');
                        recordItem.style.transform = '';
                    }
                    
                    api.toast({
                        msg: '记录已删除',
                        duration: 2000,
                        location: 'bottom'
                    });
                    
                    console.log('已删除记录：' + recordId);
                }
            }
        });
    }

    // 重置所有滑动状态
    function resetAllSwipeStates() {
        document.querySelectorAll('.records-item.swiped').forEach(function(item) {
            item.classList.remove('swiped');
            item.style.transform = '';
        });
        
        document.querySelectorAll('.records-item.swiping').forEach(function(item) {
            item.classList.remove('swiping');
            item.style.transform = '';
        });
    }

    // 重置除指定项外的所有滑动状态
    function resetOtherSwipeStates(exceptRecordId) {
        var allRecordItems = document.querySelectorAll('.records-item');
        allRecordItems.forEach(function(item) {
            var itemRecordId = item.getAttribute('data-record-id');
            if (itemRecordId !== exceptRecordId) {
                item.classList.remove('swiped');
                item.classList.remove('swiping');
                item.style.transform = '';
            }
        });
    }

    // 页面点击时重置滑动状态
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.records-item-container') && !event.target.closest('.delete-button')) {
            resetAllSwipeStates();
        }
    });

    // 显示行为模式详情
    function showPatternDetail(type) {
        var title = '';
        var content = '';
        var records = [];
        
        switch(type) {
            case 'weekday':
                var peakWeekday = document.getElementById('peakWeekday').textContent;
                if (peakWeekday === '-') {
                    api.toast({
                        msg: '暂无数据',
                        duration: 2000,
                        location: 'bottom'
                    });
                    return;
                }
                
                title = '星期详情 - ' + peakWeekday;
                
                // 获取该星期的所有记录
                var weekdayIndex = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'].indexOf(peakWeekday);
                records = alertRecords.filter(function(record) {
                    return record.weekday === weekdayIndex;
                });
                
                content = generatePatternDetailContent(records, '星期', peakWeekday);
                break;
                
            case 'hour':
                var peakHour = document.getElementById('peakHour').textContent;
                if (peakHour === '-') {
                    api.toast({
                        msg: '暂无数据',
                        duration: 2000,
                        location: 'bottom'
                    });
                    return;
                }
                
                title = '时段详情 - ' + peakHour;
                
                // 获取该时段的所有记录
                var hour = parseInt(peakHour.replace('时', ''));
                records = alertRecords.filter(function(record) {
                    var recordHour = parseInt(record.time.split(':')[0]);
                    return recordHour === hour;
                });
                
                content = generatePatternDetailContent(records, '时段', peakHour);
                break;
                
            case 'month':
                var peakMonth = document.getElementById('peakMonth').textContent;
                if (peakMonth === '-') {
                    api.toast({
                        msg: '暂无数据',
                        duration: 2000,
                        location: 'bottom'
                    });
                    return;
                }
                
                title = '月份详情 - ' + peakMonth;
                
                // 获取该月份的所有记录
                var month = parseInt(peakMonth.replace('月', ''));
                records = alertRecords.filter(function(record) {
                    return record.month === month;
                });
                
                content = generatePatternDetailContent(records, '月份', peakMonth);
                break;
                
            case 'prediction':
                var nextPrediction = document.getElementById('nextPrediction').textContent;
                if (nextPrediction === '-') {
                    api.toast({
                        msg: '暂无预测数据',
                        duration: 2000,
                        location: 'bottom'
                    });
                    return;
                }
                
                title = '预测详情';
                content = generatePredictionDetailContent();
                break;
        }
        
        // 显示详情弹窗
        showDetailDialog(title, content);
    }
    
    // 生成行为模式详情内容-样式渲染数据
    function generatePatternDetailContent(records, type, value) {
        if (records.length === 0) {
            return '<p id="pattern_dialog" style="text-align: center; color: #666;">暂无相关数据</p>';
        }
        
        var content = '<div id = "pattern_dialog" style="max-height: 400px; overflow-y: auto;">';
        
        // 统计信息
        content += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
        content += '<h4 style="margin: 0 0 10px 0; color: #495057;">📊 统计信息</h4>';
        content += '<p style="margin: 5px 0; color: #666;">• 总记录数：<strong>' + records.length + '</strong> 条</p>';
        content += '<p style="margin: 5px 0; color: #666;">• 占比：<strong>' + ((records.length / alertRecords.length) * 100).toFixed(1) + '%</strong></p>';
        
        // 计算平均间隔
        if (records.length > 1) {
            var sortedRecords = records.sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });
            
            var totalInterval = 0;
            for (var i = 1; i < sortedRecords.length; i++) {
                var interval = (new Date(sortedRecords[i].timestamp) - new Date(sortedRecords[i-1].timestamp)) / (1000 * 60 * 60 * 24);
                totalInterval += interval;
            }
            var avgInterval = totalInterval / (sortedRecords.length - 1);
            content += '<p style="margin: 5px 0; color: #666;">• 平均间隔：<strong>' + avgInterval.toFixed(1) + '</strong> 天</p>';
        }
        
        content += '</div>';
        
        // 详细记录列表
        content += '<div style="background: white; border-radius: 8px; padding: 15px;">';
        content += '<h4 style="margin: 0 0 15px 0; color: #495057;">📝 详细记录</h4>';
        
        // 按时间倒序排列
        var sortedRecords = records.sort(function(a, b) {
            return new Date(b.timestamp) - new Date(a.timestamp);
        });
        
        sortedRecords.forEach(function(record, index) {
            if (index < 10) { // 只显示最近10条记录
                content += '<div style="border-bottom: 1px solid #eee; padding: 10px 0; margin-bottom: 10px;">';
                content += '<div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 5px;">';
                content += '<span style="font-weight: bold; color: #333;">' + record.date + ' ' + record.time + '</span>';
                // 去除ID展示
                // content += '<span style="font-size: 12px; color: #666;">#' + record.id + '</span>';
                content += '</div>';
                content += '<div style="color: #666; font-size: 14px; line-height: 1.4;">' + record.content + '</div>';
                content += '<div style="font-size: 12px; color: #999; margin-top: 5px;">来源：' + record.phoneNumber + '</div>';
                content += '</div>';
            }
        });
        
        if (records.length > 10) {
            content += '<div style="text-align: center; color: #666; font-size: 12px; padding: 10px;">还有 ' + (records.length - 10) + ' 条记录...</div>';
        }
        
        content += '</div>';
        content += '</div>';
        
        return content;
    }
    
    // 生成预测详情内容
    function generatePredictionDetailContent() {
        var content = '<div style="max-height: 400px; overflow-y: auto;">';
        
        // 预测算法说明
        content += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
        content += '<h4 style="margin: 0 0 10px 0; color: #495057;">🔮 预测算法</h4>';
        content += '<p style="margin: 5px 0; color: #666; line-height: 1.5;">基于历史数据的间隔分析，计算平均违章间隔时间，预测下次可能违章的时间点。</p>';
        content += '</div>';
        
        // 历史间隔分析
        if (alertRecords.length >= 2) {
            var sortedRecords = alertRecords.sort(function(a, b) {
                return new Date(a.timestamp) - new Date(b.timestamp);
            });
            
            content += '<div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">';
            content += '<h4 style="margin: 0 0 10px 0; color: #495057;">📈 间隔分析</h4>';
            
            var intervals = [];
            for (var i = 1; i < sortedRecords.length; i++) {
                var interval = (new Date(sortedRecords[i].timestamp) - new Date(sortedRecords[i-1].timestamp)) / (1000 * 60 * 60 * 24);
                intervals.push(interval);
            }
            
            var avgInterval = intervals.reduce(function(sum, val) { return sum + val; }, 0) / intervals.length;
            var minInterval = Math.min(...intervals);
            var maxInterval = Math.max(...intervals);
            
            content += '<p style="margin: 5px 0; color: #666;">• 平均间隔：<strong>' + avgInterval.toFixed(1) + '</strong> 天</p>';
            content += '<p style="margin: 5px 0; color: #666;">• 最短间隔：<strong>' + minInterval.toFixed(1) + '</strong> 天</p>';
            content += '<p style="margin: 5px 0; color: #666;">• 最长间隔：<strong>' + maxInterval.toFixed(1) + '</strong> 天</p>';
            content += '</div>';
        }
        
        // 预测建议
        content += '<div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">';
        content += '<h4 style="margin: 0 0 10px 0; color: #1976d2;">💡 预测建议</h4>';
        content += '<p style="margin: 5px 0; color: #333; line-height: 1.5;">• 预测仅供参考，实际违章时间可能因各种因素而变化</p>';
        content += '<p style="margin: 5px 0; color: #333; line-height: 1.5;">• 建议在预测时间前后特别注意驾驶行为</p>';
        content += '<p style="margin: 5px 0; color: #333; line-height: 1.5;">• 保持良好的驾驶习惯是避免违章的最佳方法</p>';
        content += '</div>';
        
        content += '</div>';
        
        return content;
    }
    
    // 行为模式框的显示详情弹窗
    function showDetailDialog(title, content) {
        // 创建弹窗容器
        var dialog = document.createElement('div');
        dialog.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        `;
        // 创建弹窗内容
        var dialogContent = document.createElement('div');
        dialogContent.style.cssText = `
            background: white;
            border-radius: 12px;
            max-width: 90%;
            max-height: 80%;
            width: 100%;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        `;
        // 创建弹窗头部
        var dialogHeader = document.createElement('div');
        dialogHeader.style.cssText = `
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        `;
        dialogHeader.innerHTML = `
            <h3 style="margin: 0; color: #333; font-size: 18px;">${title}</h3>
            <button onclick="closeDetailDialog()" style="
                background: none;
                border: none;
                font-size: 24px;
                color: #666;
                cursor: pointer;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.2s;
            " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='transparent'">×</button>
        `;
        // 创建弹窗主体
        var dialogBody = document.createElement('div');
        dialogBody.style.cssText = `
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        `;
        dialogBody.innerHTML = content;
        // 组装弹窗
        dialogContent.appendChild(dialogHeader);
        dialogContent.appendChild(dialogBody);
        dialog.appendChild(dialogContent);
        // 防止内容区滚动穿透
        let startY = 0;
        let startScrollTop = 0;
        dialogBody.addEventListener('touchstart', function(e) {
            if (e.touches.length === 1) {
                startY = e.touches[0].clientY;
                startScrollTop = dialogBody.scrollTop;
            }
        }, { passive: false });
        dialogBody.addEventListener('touchmove', function(e) {
            if (e.touches.length !== 1) return;
            const currentY = e.touches[0].clientY;
            const scrollTop = dialogBody.scrollTop;
            const scrollHeight = dialogBody.scrollHeight;
            const offsetHeight = dialogBody.offsetHeight;
            const isAtTop = scrollTop === 0;
            const isAtBottom = scrollTop + offsetHeight >= scrollHeight - 1;
            const deltaY = currentY - startY;
            
            // 优化滑动穿透处理
            if ((isAtTop && deltaY > 0) || (isAtBottom && deltaY < 0)) {
                // 当在顶部向上滑动或底部向下滑动时，阻止默认行为
                e.preventDefault();
                e.stopPropagation();
            } else if (scrollTop !== startScrollTop) {
                // 如果内容正在滚动，阻止事件传播到背景
                e.stopPropagation();
            }
        }, { passive: false });
        
        // 防止背景页面滚动
        function preventBackgroundScroll(e) {
            e.preventDefault();
        }
        document.addEventListener('touchmove', preventBackgroundScroll, { passive: false });
        
        // 只在蒙层滑动时关闭弹窗，内容区滑动不关闭
        var closeOnMove = function(e) {
            if (!dialogContent.contains(e.target)) {
                closeDetailDialog();
            }
        };
        dialog.addEventListener('touchmove', closeOnMove, { passive: true });
        // 添加到页面
        document.body.appendChild(dialog);
        // 禁止页面滚动，防止滑动穿透
        document.body.style.overflow = 'hidden';
        // 点击背景关闭弹窗
        dialog.addEventListener('click', function(e) {
            if (e.target === dialog) {
                closeDetailDialog();
            }
        });
        // 添加关闭函数到全局
        window.closeDetailDialog = function() {
            if (dialog && dialog.parentNode) {
                dialog.parentNode.removeChild(dialog);
            }
            // 恢复页面滚动
            document.body.style.overflow = '';
            // 移除滑动监听
            dialog.removeEventListener('touchmove', closeOnMove);
            // 移除背景滚动阻止
            document.removeEventListener('touchmove', preventBackgroundScroll);
        };
    }

</script>

</body>
</html>