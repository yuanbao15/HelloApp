<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <title>è¿åœè­¦æŠ¥ç»Ÿè®¡</title>
    <link rel="stylesheet" href="../css/api.css">
    <style>
        .container {padding: 15px;}
        .stats-container {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;}
        .stats-header {background: #007aff; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;}
        .stats-header button:hover {opacity: 0.8;}
        .stats-summary .grid-item {transition: transform 0.2s;}
        .stats-summary .grid-item:hover {transform: scale(1.05);}
        .stats-charts {transition: all 0.3s ease;}
        .stats-charts:hover {box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .chart-bar {transition: height 0.5s ease;}
        .chart-bar:hover {opacity: 0.8;}
        .records-item {transition: all 0.2s ease;}
        .records-item:hover {background: #f0f0f0 !important; transform: translateX(2px);}
        .stats-actions button {transition: all 0.2s ease;}
        .stats-actions button:hover {transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
        .stats-actions button:active {transform: translateY(0);}
        .btn {padding: 10px 10px; margin: 5px; background: #007aff; color: white; border: none; border-radius: 5px; cursor: pointer;}
        .btn:disabled {background: #ccc; cursor: not-allowed; opacity: 0.6;}
        .btn:enabled:hover {background: #0056cc;}
        .btn-danger {background: #ff4444;}
        .btn-danger:hover {background: #cc0000;}
        .btn-success {background: #44aa44;}
        .btn-success:hover {background: #338833;}
        
        /* å¤šé€‰æ¨¡å¼æ ·å¼ */
        .records-item.multi-select { border: 2px solid #007aff; }
        .records-item.multi-select.selected { background: #e3f2fd !important; }
        .selection-indicator { 
            width: 20px; 
            height: 20px; 
            border: 2px solid #007aff; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px;
            font-weight: bold;
        }
        .selection-indicator.selected { 
            background: #007aff; 
            color: white; 
        }
    </style>
</head>
<body>
<div class="stats-container">
    <div class="stats-header">
        <h2 style="margin: 0;" id="pageTitle">å¹´åº¦è¿åœè­¦æŠ¥ç»Ÿè®¡</h2>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="yearSelector" onchange="changeYear(this.value)" style="padding: 5px; border: none; border-radius: 3px; background: white; color: #333;">
                <!-- å¹´ä»½é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </select>
            <button onclick="goBack()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">Ã—</button>
        </div>
    </div>
    
    <div class="stats-content" style="padding: 15px;">
        <div class="stats-summary" style="background: #f8f8f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #333;">ç»Ÿè®¡æ¦‚è§ˆ</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 24px; font-weight: bold; color: #ff4444;" id="totalAlerts">0</div>
                    <div style="font-size: 12px; color: #666;">æ€»è­¦æŠ¥æ¬¡æ•°</div>
                </div>
                <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 24px; font-weight: bold; color: #007aff;" id="avgPerMonth">0</div>
                    <div style="font-size: 12px; color: #666;">æœˆå¹³å‡æ¬¡æ•°</div>
                </div>
                <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 24px; font-weight: bold; color: #44aa44;" id="maxMonth">0</div>
                    <div style="font-size: 12px; color: #666;">æœ€é«˜æœˆæ¬¡æ•°</div>
                </div>
                <div class="grid-item" style="text-align: center; padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-size: 24px; font-weight: bold; color: #ff8800;" id="lastAlert">-</div>
                    <div style="font-size: 12px; color: #666;">æœ€è¿‘è­¦æŠ¥</div>
                </div>
            </div>
        </div>
        
        <div class="stats-charts" style="margin-bottom: 20px;">
            <h3 style="color: #333;">æœˆåº¦è¶‹åŠ¿</h3>
            <div id="monthlyChart" style="height: 200px; background: #f8f8f8; border-radius: 8px; display: flex; align-items: end; justify-content: space-around; padding: 20px;">
                <!-- æœˆåº¦æŸ±çŠ¶å›¾å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="stats-charts" style="margin-bottom: 20px;">
            <h3 style="color: #333;">æ˜ŸæœŸåˆ†å¸ƒ</h3>
            <div id="weekdayChart" style="height: 200px; background: #f8f8f8; border-radius: 8px; display: flex; align-items: end; justify-content: space-around; padding: 20px;">
                <!-- æ˜ŸæœŸæŸ±çŠ¶å›¾å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="stats-charts" style="margin-bottom: 20px;">
            <h3 style="color: #333;">æ—¶æ®µåˆ†å¸ƒ</h3>
            <div id="timeChart" style="height: 200px; background: #f8f8f8; border-radius: 8px; display: flex; align-items: end; justify-content: space-around; padding: 20px;">
                <!-- æ—¶æ®µæŸ±çŠ¶å›¾å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </div>
        
        <div class="stats-actions" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn" onclick="exportStatistics()" style="flex: 1;">å¯¼å‡ºæ•°æ®</button>
            <button class="btn btn-success" onclick="shareStatistics()" style="flex: 1;">åˆ†äº«ç»Ÿè®¡</button>
            <button class="btn" onclick="toggleMultiSelect()" style="flex: 1;" id="multiSelectBtn">å¤šé€‰åˆ é™¤</button>
            <button class="btn btn-danger" onclick="clearStatistics()" style="flex: 1;">æ¸…ç©ºè®°å½•</button>
        </div>
        
        <div id="multiSelectActions" style="display: none; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <button class="btn" onclick="selectAllRecords()" style="flex: 1;">å…¨é€‰</button>
                <button class="btn" onclick="deselectAllRecords()" style="flex: 1;">å–æ¶ˆå…¨é€‰</button>
                <button class="btn btn-danger" onclick="deleteSelectedRecords()" style="flex: 1;">åˆ é™¤é€‰ä¸­</button>
            </div>
            <div style="text-align: center; color: #666; font-size: 12px;">
                å·²é€‰æ‹© <span id="selectedCount">0</span> æ¡è®°å½•
            </div>
        </div>
        
        <div class="stats-list">
            <h3 style="color: #333;">è¯¦ç»†è®°å½•</h3>
            <div id="recordsList" style="max-height: 300px; overflow-y: auto;">
                <!-- è¯¦ç»†è®°å½•å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </div>
    </div>
</div>

<script src="../script/api.js"></script>
<script>
    var alertRecords = []; // è­¦æŠ¥è®°å½•æ•°ç»„
    var currentYear = new Date().getFullYear(); // å½“å‰å¹´ä»½
    var isMultiSelectMode = false; // æ˜¯å¦å¤„äºå¤šé€‰æ¨¡å¼
    var selectedRecords = []; // é€‰ä¸­çš„è®°å½•IDæ•°ç»„
    var longPressTimer = null; // é•¿æŒ‰è®¡æ—¶å™¨

    apiready = function() {
        // è·å–é¡µé¢å‚æ•°
        var pageParam = api.pageParam;
        if (pageParam && pageParam.currentYear) {
            currentYear = pageParam.currentYear;
        }
        
        // è®¾ç½®é¡µé¢æ ‡é¢˜
        document.getElementById('pageTitle').textContent = currentYear + 'å¹´è¿åœè­¦æŠ¥ç»Ÿè®¡';
        
        // åŠ¨æ€ç”Ÿæˆå¹´ä»½é€‰æ‹©å™¨é€‰é¡¹
        generateYearOptions();
        
        // è®¾ç½®å¹´ä»½é€‰æ‹©å™¨é»˜è®¤å€¼
        document.getElementById('yearSelector').value = currentYear;
        
        // åŠ è½½è­¦æŠ¥è®°å½•
        loadAlertRecords();
        
        // ç”Ÿæˆç»Ÿè®¡æ•°æ®
        generateStatistics();
        
        // ç›‘å¬è¿”å›é”®
        api.addEventListener({
            name: 'keyback'
        }, function(ret, err) {
            goBack();
        });
    };

    // è¿”å›ä¸Šä¸€é¡µ
    function goBack() {
        api.closeWin();
    }

    // åŠ¨æ€ç”Ÿæˆå¹´ä»½é€‰æ‹©å™¨é€‰é¡¹
    function generateYearOptions() {
        var yearSelector = document.getElementById('yearSelector');
        var optionsHTML = '';
        
        // ç”Ÿæˆå½“å‰å¹´ä»½åŠå‰ä¸¤å¹´çš„é€‰é¡¹
        for (var i = 0; i < 3; i++) {
            var year = currentYear - i;
            var selected = i === 0 ? ' selected' : '';
            optionsHTML += '<option value="' + year + '"' + selected + '>' + year + 'å¹´</option>';
        }
        
        yearSelector.innerHTML = optionsHTML;
    }

    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è­¦æŠ¥è®°å½•
    function loadAlertRecords() {
        try {
            var savedRecords = api.getPrefs({sync: true, key: 'alertRecords_' + currentYear});
            if (savedRecords) {
                alertRecords = JSON.parse(savedRecords);
                console.log('å·²åŠ è½½' + alertRecords.length + 'æ¡è­¦æŠ¥è®°å½•');
            } else {
                alertRecords = [];
                console.log('æœªæ‰¾åˆ°å†å²è­¦æŠ¥è®°å½•');
            }
        } catch (e) {
            alertRecords = [];
            console.log('åŠ è½½è­¦æŠ¥è®°å½•å¤±è´¥: ' + e.message);
        }
    }

    // ç”Ÿæˆç»Ÿè®¡æ•°æ®
    function generateStatistics() {
        // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
        updateSummaryStats();
        
        // ç”Ÿæˆæœˆåº¦è¶‹åŠ¿å›¾
        generateMonthlyChart();
        
        // ç”Ÿæˆæ˜ŸæœŸåˆ†å¸ƒå›¾
        generateWeekdayChart();
        
        // ç”Ÿæˆæ—¶æ®µåˆ†å¸ƒå›¾
        generateTimeChart();
        
        // ç”Ÿæˆè¯¦ç»†è®°å½•åˆ—è¡¨
        generateRecordsList();
    }

    // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
    function updateSummaryStats() {
        var totalAlerts = alertRecords.length;
        var avgPerMonth = totalAlerts > 0 ? (totalAlerts / 12).toFixed(1) : 0;
        
        // è®¡ç®—æœ€é«˜æœˆæ¬¡æ•°
        var monthlyData = new Array(12).fill(0);
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.month >= 1 && record.month <= 12) {
                    monthlyData[record.month - 1]++;
                }
            }
        });
        var maxMonth = Math.max(...monthlyData);
        
        // è®¡ç®—æœ€è¿‘è­¦æŠ¥æ—¶é—´
        var lastAlert = '-';
        if (alertRecords.length > 0) {
            var sortedRecords = alertRecords.slice().sort(function(a, b) {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            var lastRecord = sortedRecords[0];
            var lastDate = new Date(lastRecord.timestamp);
            var now = new Date();
            var diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                lastAlert = 'ä»Šå¤©';
            } else if (diffDays === 1) {
                lastAlert = 'æ˜¨å¤©';
            } else if (diffDays < 7) {
                lastAlert = diffDays + 'å¤©å‰';
            } else {
                lastAlert = lastRecord.date;
            }
        }
        
        document.getElementById('totalAlerts').textContent = totalAlerts;
        document.getElementById('avgPerMonth').textContent = avgPerMonth;
        document.getElementById('maxMonth').textContent = maxMonth;
        document.getElementById('lastAlert').textContent = lastAlert;
    }

    // ç”Ÿæˆæœˆåº¦è¶‹åŠ¿å›¾
    function generateMonthlyChart() {
        var monthlyData = new Array(12).fill(0);
        var monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        
        // ç»Ÿè®¡æ¯æœˆè­¦æŠ¥æ¬¡æ•°
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.month >= 1 && record.month <= 12) {
                    monthlyData[record.month - 1]++;
                }
            }
        });
        
        var maxValue = Math.max(...monthlyData);
        var chartHTML = '';
        
        monthlyData.forEach(function(count, index) {
            var height = maxValue > 0 ? (count / maxValue * 150) : 0;
            var color = count > 0 ? '#ff4444' : '#ddd';
            
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
                    <div class="chart-bar" style="width: 20px; height: 0px; background: ${color}; border-radius: 3px; margin-bottom: 5px; transition: height 0.8s ease;" title="${monthNames[index]}: ${count}æ¬¡" data-height="${height}"></div>
                    <div style="font-size: 10px; color: #666;">${monthNames[index]}</div>
                    <div style="font-size: 8px; color: #999;">${count}</div>
                </div>
            `;
        });
        
        document.getElementById('monthlyChart').innerHTML = chartHTML;
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        setTimeout(function() {
            var bars = document.querySelectorAll('#monthlyChart .chart-bar');
            bars.forEach(function(bar) {
                var height = bar.getAttribute('data-height');
                bar.style.height = height + 'px';
            });
        }, 100);
    }

    // ç”Ÿæˆæ˜ŸæœŸåˆ†å¸ƒå›¾
    function generateWeekdayChart() {
        var weekdayData = new Array(7).fill(0);
        var weekdayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        
        // ç»Ÿè®¡æ¯å‘¨å‡ çš„è­¦æŠ¥æ¬¡æ•°
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.weekday >= 0 && record.weekday < 7) {
                    weekdayData[record.weekday]++;
                }
            }
        });
        
        var maxValue = Math.max(...weekdayData);
        var chartHTML = '';
        
        weekdayData.forEach(function(count, index) {
            var height = maxValue > 0 ? (count / maxValue * 150) : 0;
            var color = count > 0 ? '#007aff' : '#ddd';
            
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
                    <div class="chart-bar" style="width: 20px; height: 0px; background: ${color}; border-radius: 3px; margin-bottom: 5px; transition: height 0.8s ease;" title="${weekdayNames[index]}: ${count}æ¬¡" data-height="${height}"></div>
                    <div style="font-size: 10px; color: #666;">${weekdayNames[index]}</div>
                    <div style="font-size: 8px; color: #999;">${count}</div>
                </div>
            `;
        });
        
        document.getElementById('weekdayChart').innerHTML = chartHTML;
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        setTimeout(function() {
            var bars = document.querySelectorAll('#weekdayChart .chart-bar');
            bars.forEach(function(bar) {
                var height = bar.getAttribute('data-height');
                bar.style.height = height + 'px';
            });
        }, 200);
    }

    // ç”Ÿæˆæ—¶æ®µåˆ†å¸ƒå›¾
    function generateTimeChart() {
        var timeData = new Array(24).fill(0);
        var timeLabels = [];
        
        // ç”Ÿæˆæ—¶æ®µæ ‡ç­¾
        for (var i = 0; i < 24; i++) {
            timeLabels.push(i + 'æ—¶');
        }
        
        // ç»Ÿè®¡æ¯å°æ—¶çš„è­¦æŠ¥æ¬¡æ•°
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                var hour = parseInt(record.time.split(':')[0]);
                if (!isNaN(hour) && hour >= 0 && hour < 24) {
                    timeData[hour]++;
                }
            }
        });
        
        var maxValue = Math.max(...timeData);
        var chartHTML = '';
        
        // åªæ˜¾ç¤ºæœ‰æ•°æ®çš„æ—¶æ®µï¼Œæœ€å¤šæ˜¾ç¤º12ä¸ªæŸ±å­
        var nonZeroData = timeData.map(function(count, index) {
            return { count: count, hour: index };
        }).filter(function(item) {
            return item.count > 0;
        });
        
        // å¦‚æœæ•°æ®ç‚¹å¤ªå¤šï¼Œè¿›è¡Œåˆ†ç»„
        if (nonZeroData.length > 12) {
            var groupedData = [];
            var groupSize = Math.ceil(nonZeroData.length / 12);
            
            for (var i = 0; i < nonZeroData.length; i += groupSize) {
                var group = nonZeroData.slice(i, i + groupSize);
                var totalCount = group.reduce(function(sum, item) { return sum + item.count; }, 0);
                var avgHour = Math.round(group.reduce(function(sum, item) { return sum + item.hour; }, 0) / group.length);
                groupedData.push({ count: totalCount, hour: avgHour });
            }
            nonZeroData = groupedData;
        }
        
        nonZeroData.forEach(function(item) {
            var height = maxValue > 0 ? (item.count / maxValue * 150) : 0;
            var color = '#44aa44';
            
            chartHTML += `
                <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
                    <div class="chart-bar" style="width: 15px; height: 0px; background: ${color}; border-radius: 3px; margin-bottom: 5px; transition: height 0.8s ease;" title="${item.hour}æ—¶: ${item.count}æ¬¡" data-height="${height}"></div>
                    <div style="font-size: 8px; color: #666;">${item.hour}æ—¶</div>
                    <div style="font-size: 8px; color: #999;">${item.count}</div>
                </div>
            `;
        });
        
        document.getElementById('timeChart').innerHTML = chartHTML;
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        setTimeout(function() {
            var bars = document.querySelectorAll('#timeChart .chart-bar');
            bars.forEach(function(bar) {
                var height = bar.getAttribute('data-height');
                bar.style.height = height + 'px';
            });
        }, 300);
    }

    // ç”Ÿæˆè¯¦ç»†è®°å½•åˆ—è¡¨
    function generateRecordsList() {
        var recordsList = document.getElementById('recordsList');
        var recordsHTML = '';
        
        if (alertRecords.length === 0) {
            recordsHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è­¦æŠ¥è®°å½•</div>';
        } else {
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            var sortedRecords = alertRecords.slice().sort(function(a, b) {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            sortedRecords.forEach(function(record) {
                var date = new Date(record.timestamp);
                var weekdayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                
                // æˆªå–çŸ­ä¿¡å†…å®¹ï¼Œé¿å…è¿‡é•¿
                var shortContent = record.content.length > 50 ? record.content.substring(0, 50) + '...' : record.content;
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºæµ‹è¯•è®°å½•ï¼šæµ‹è¯•è®°å½•ä¸ºæµ…ç°è‰²ï¼Œæ­£å¸¸è®°å½•ä¸ºé»‘è‰²ï¼Œé¢œè‰²åŒºåˆ†ä¾¿äºé˜…è¯»
                var isTestRecord = record.content.indexOf('æµ‹è¯•') !== -1 || record.content.indexOf('TEST') !== -1 || record.content.indexOf('Test') !== -1;
                var textColor = isTestRecord ? '#999' : '#333'; // æµ‹è¯•è®°å½•ä¸ºæµ…ç°è‰²ï¼Œæ­£å¸¸è®°å½•ä¸ºé»‘è‰²
                var bgColor = isTestRecord ? '#f0f0f0' : '#f8f8f8'; // æµ‹è¯•è®°å½•èƒŒæ™¯è‰²ç¨æµ…
                var borderColor = isTestRecord ? '#ccc' : '#ff4444'; // æµ‹è¯•è®°å½•è¾¹æ¡†ä¸ºç°è‰²
                
                var isSelected = selectedRecords.indexOf(record.id.toString()) !== -1;
                var selectionStyle = isSelected ? 'background: #007aff; color: white;' : '';
                var selectionIcon = isSelected ? 'âœ“' : '';
                
                // å…è®¸é€šè¿‡é•¿æŒ‰è§¦å‘å¤šé€‰åˆ é™¤
                recordsHTML += `
                    <div class="records-item" 
                         style="background: ${bgColor}; margin: 5px 0; padding: 10px; border-radius: 5px; border-left: 4px solid ${borderColor}; cursor: pointer; position: relative;" 
                         data-record-id="${record.id}"
                         onclick="handleRecordClick('${record.id}')"
                         onmousedown="startLongPress('${record.id}')"
                         onmouseup="endLongPress()"
                         onmouseleave="endLongPress()"
                         ontouchstart="startLongPress('${record.id}')"
                         ontouchend="endLongPress()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <div style="font-weight: bold; color: ${textColor};">${record.date} ${record.time}</div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="font-size: 12px; color: ${isTestRecord ? '#999' : '#666'};">${weekdayNames[record.weekday]}</div>
                                ${isMultiSelectMode ? `<div style="width: 20px; height: 20px; border: 2px solid #007aff; border-radius: 50%; display: flex; align-items: center; justify-content: center; ${selectionStyle}">${selectionIcon}</div>` : ''}
                            </div>
                        </div>
                        <div style="font-size: 12px; color: ${isTestRecord ? '#999' : '#666'}; margin-bottom: 5px;">æ¥è‡ª: ${record.phoneNumber}</div>
                        <div style="font-size: 12px; color: ${textColor}; line-height: 1.4; word-break: break-all;">${shortContent}</div>
                    </div>
                `;
            });
        }
        
        recordsList.innerHTML = recordsHTML;
    }

    // åˆ‡æ¢å¹´ä»½
    function changeYear(year) {
        currentYear = parseInt(year);
        
        // æ›´æ–°æ ‡é¢˜
        document.getElementById('pageTitle').textContent = currentYear + 'å¹´è¿åœè­¦æŠ¥ç»Ÿè®¡';
        
        // é‡æ–°ç”Ÿæˆå¹´ä»½é€‰æ‹©å™¨é€‰é¡¹ï¼ˆä¿æŒå½“å‰é€‰ä¸­çŠ¶æ€ï¼‰
        // generateYearOptions(); // ä¸éœ€è¦é‡æ–°ç”Ÿæˆ
        
        // åŠ è½½å¯¹åº”å¹´ä»½çš„æ•°æ®
        loadYearData(currentYear);
        
        // é‡æ–°ç”Ÿæˆç»Ÿè®¡
        generateStatistics();
        
        console.log('å·²åˆ‡æ¢åˆ°' + currentYear + 'å¹´');
    }

    // åŠ è½½æŒ‡å®šå¹´ä»½çš„æ•°æ®
    function loadYearData(year) {
        try {
            var savedRecords = api.getPrefs({sync: true, key: 'alertRecords_' + year});
            if (savedRecords) {
                alertRecords = JSON.parse(savedRecords);
                console.log('å·²åŠ è½½' + year + 'å¹´çš„' + alertRecords.length + 'æ¡è­¦æŠ¥è®°å½•');
            } else {
                alertRecords = [];
                console.log('æœªæ‰¾åˆ°' + year + 'å¹´çš„è­¦æŠ¥è®°å½•');
            }
        } catch (e) {
            alertRecords = [];
            console.log('åŠ è½½' + year + 'å¹´è­¦æŠ¥è®°å½•å¤±è´¥: ' + e.message);
        }
    }

    // æ˜¾ç¤ºè®°å½•è¯¦æƒ…
    function showRecordDetail(recordId) {
        var record = alertRecords.find(function(r) {
            return r.id.toString() === recordId;
        });
        
        if (!record) {
            api.toast({
                msg: 'æœªæ‰¾åˆ°è®°å½•',
                duration: 2000,
                location: 'top'
            });
            return;
        }
        
        var weekdayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºæµ‹è¯•è®°å½•ï¼šæµ‹è¯•è®°å½•ä¸ºæµ…ç°è‰²ï¼Œæ­£å¸¸è®°å½•ä¸ºé»‘è‰²ï¼Œé¢œè‰²åŒºåˆ†ä¾¿äºé˜…è¯»
        var isTestRecord = record.content.indexOf('TEST') !== -1 || record.content.indexOf('æµ‹è¯•') !== -1;
        var textColor = isTestRecord ? '#999' : '#333';
        var bgColor = isTestRecord ? '#f0f0f0' : '#f8f8f8';
        var titleColor = isTestRecord ? '#999' : '#333';
        var titleText = isTestRecord ? 'æµ‹è¯•è­¦æŠ¥è¯¦æƒ…' : 'è­¦æŠ¥è¯¦æƒ…';
        
        var detailHTML = `
        <div class="detail-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
            <div class="detail-modal" style="background: white; border-radius: 10px; padding: 20px; margin: 20px; max-width: 90%; max-height: 80%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: ${titleColor};">${titleText}</h3>
                    <button onclick="closeRecordDetail()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">Ã—</button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: ${textColor};">æ—¶é—´ï¼š</span>
                        <span style="color: ${isTestRecord ? '#999' : '#666'};">${record.date} ${record.time}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: ${textColor};">æ˜ŸæœŸï¼š</span>
                        <span style="color: ${isTestRecord ? '#999' : '#666'};">${weekdayNames[record.weekday]}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-weight: bold; color: ${textColor};">æ¥æºå·ç ï¼š</span>
                        <span style="color: ${isTestRecord ? '#999' : '#666'};">${record.phoneNumber}</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-weight: bold; color: ${textColor}; margin-bottom: 8px;">çŸ­ä¿¡å†…å®¹ï¼š</div>
                    <div style="background: ${bgColor}; padding: 10px; border-radius: 5px; line-height: 1.5; color: ${textColor}; white-space: pre-wrap; word-break: break-all;">${record.content}</div>
                </div>
                
                <div style="text-align: center; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="deleteSingleRecord('${recordId}')" style="padding: 10px 20px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">åˆ é™¤</button>
                    <button onclick="closeRecordDetail()" style="padding: 10px 20px; background: #007aff; color: white; border: none; border-radius: 5px; cursor: pointer;">å…³é—­</button>
                </div>
            </div>
        </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailHTML);
    }

    // å…³é—­è®°å½•è¯¦æƒ…
    function closeRecordDetail() {
        var detailOverlay = document.querySelector('.detail-overlay');
        if (detailOverlay) {
            detailOverlay.remove();
        }
    }

    // é•¿æŒ‰å¼€å§‹
    function startLongPress(recordId) {
        longPressTimer = setTimeout(function() {
            if (!isMultiSelectMode) {
                enterMultiSelectMode();
            }
            toggleRecordSelection(recordId);
        }, 500); // 500msé•¿æŒ‰è§¦å‘
    }

    // é•¿æŒ‰ç»“æŸ
    function endLongPress() {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    }

    // å¤„ç†è®°å½•ç‚¹å‡»
    function handleRecordClick(recordId) {
        if (isMultiSelectMode) {
            toggleRecordSelection(recordId);
        } else {
            showRecordDetail(recordId);
        }
    }

    // åˆ‡æ¢å¤šé€‰æ¨¡å¼
    function toggleMultiSelect() {
        if (isMultiSelectMode) {
            exitMultiSelectMode();
        } else {
            enterMultiSelectMode();
        }
    }

    // è¿›å…¥å¤šé€‰æ¨¡å¼
    function enterMultiSelectMode() {
        isMultiSelectMode = true;
        selectedRecords = [];
        document.getElementById('multiSelectBtn').textContent = 'é€€å‡ºå¤šé€‰';
        document.getElementById('multiSelectBtn').style.background = '#ff8800';
        document.getElementById('multiSelectActions').style.display = 'block';
        updateSelectedCount();
        generateRecordsList(); // é‡æ–°ç”Ÿæˆåˆ—è¡¨ä»¥æ˜¾ç¤ºé€‰æ‹©æ¡†
    }

    // é€€å‡ºå¤šé€‰æ¨¡å¼
    function exitMultiSelectMode() {
        isMultiSelectMode = false;
        selectedRecords = [];
        document.getElementById('multiSelectBtn').textContent = 'å¤šé€‰åˆ é™¤';
        document.getElementById('multiSelectBtn').style.background = '#007aff';
        document.getElementById('multiSelectActions').style.display = 'none';
        generateRecordsList(); // é‡æ–°ç”Ÿæˆåˆ—è¡¨ä»¥éšè—é€‰æ‹©æ¡†
    }

    // åˆ‡æ¢è®°å½•é€‰æ‹©çŠ¶æ€
    function toggleRecordSelection(recordId) {
        var index = selectedRecords.indexOf(recordId);
        if (index === -1) {
            selectedRecords.push(recordId);
        } else {
            selectedRecords.splice(index, 1);
        }
        updateSelectedCount();
        generateRecordsList(); // é‡æ–°ç”Ÿæˆåˆ—è¡¨ä»¥æ›´æ–°é€‰æ‹©çŠ¶æ€
    }

    // å…¨é€‰è®°å½•
    function selectAllRecords() {
        selectedRecords = alertRecords.map(function(record) {
            return record.id.toString();
        });
        updateSelectedCount();
        generateRecordsList();
    }

    // å–æ¶ˆå…¨é€‰
    function deselectAllRecords() {
        selectedRecords = [];
        updateSelectedCount();
        generateRecordsList();
    }

    // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = selectedRecords.length;
    }

    // åˆ é™¤é€‰ä¸­çš„è®°å½•
    function deleteSelectedRecords() {
        if (selectedRecords.length === 0) {
            api.toast({
                msg: 'è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•',
                duration: 2000,
                location: 'top'
            });
            return;
        }

        api.confirm({
            title: 'ç¡®è®¤åˆ é™¤',
            msg: 'ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ' + selectedRecords.length + ' æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
            buttons: ['å–æ¶ˆ', 'ç¡®å®šåˆ é™¤']
        }, function(ret) {
            if (ret.buttonIndex === 2) {
                // åˆ é™¤é€‰ä¸­çš„è®°å½•
                alertRecords = alertRecords.filter(function(record) {
                    return selectedRecords.indexOf(record.id.toString()) === -1;
                });
                
                // ä¿å­˜æ›´æ–°åçš„è®°å½•
                saveAlertRecords();
                
                // é€€å‡ºå¤šé€‰æ¨¡å¼
                exitMultiSelectMode();
                
                // é‡æ–°ç”Ÿæˆç»Ÿè®¡
                generateStatistics();
                
                api.toast({
                    msg: 'å·²åˆ é™¤ ' + selectedRecords.length + ' æ¡è®°å½•',
                    duration: 2000,
                    location: 'top'
                });
            }
        });
    }

    // åˆ é™¤å•æ¡è®°å½•
    function deleteSingleRecord(recordId) {
        var record = alertRecords.find(function(r) {
            return r.id.toString() === recordId;
        });
        
        if (!record) {
            api.toast({
                msg: 'æœªæ‰¾åˆ°è®°å½•',
                duration: 2000,
                location: 'top'
            });
            return;
        }

        api.confirm({
            title: 'ç¡®è®¤åˆ é™¤',
            msg: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
            buttons: ['å–æ¶ˆ', 'ç¡®å®šåˆ é™¤']
        }, function(ret) {
            if (ret.buttonIndex === 2) {
                // åˆ é™¤è®°å½•
                alertRecords = alertRecords.filter(function(r) {
                    return r.id.toString() !== recordId;
                });
                
                // ä¿å­˜æ›´æ–°åçš„è®°å½•
                saveAlertRecords();
                
                // å…³é—­è¯¦æƒ…å¼¹çª—
                closeRecordDetail();
                
                // é‡æ–°ç”Ÿæˆç»Ÿè®¡
                generateStatistics();
                
                api.toast({
                    msg: 'è®°å½•å·²åˆ é™¤',
                    duration: 2000,
                    location: 'top'
                });
            }
        });
    }

    // å¯¼å‡ºç»Ÿè®¡æ•°æ®
    function exportStatistics() {
        if (alertRecords.length === 0) {
            api.toast({
                msg: 'æš‚æ— æ•°æ®å¯å¯¼å‡º',
                duration: 2000,
                location: 'top'
            });
            return;
        }
        
        try {
            var exportData = {
                year: currentYear,
                totalAlerts: alertRecords.length,
                records: alertRecords,
                exportTime: new Date().toISOString()
            };
            
            var dataStr = JSON.stringify(exportData, null, 2);
            var fileName = `è¿åœè­¦æŠ¥ç»Ÿè®¡_${currentYear}å¹´_${new Date().toISOString().split('T')[0]}.json`;
            
            // è¿™é‡Œå¯ä»¥è°ƒç”¨æ–‡ä»¶ä¿å­˜API            
            api.writeFile({
                path: "fs://export/" + fileName,
                data: dataStr
            }, function(ret, err) {
                if (ret && ret.status) {
                    console.log('æ•°æ®å·²å†™å…¥æ–‡ä»¶ï¼š' + fileName );
                    api.toast({
                        msg: 'æ•°æ®å·²å†™å…¥æ–‡ä»¶ï¼š' + fileName,
                        duration: 2000,
                        location: 'top'
                    });
                } else {
                    console.log('å†™å…¥æ–‡ä»¶å¤±è´¥: ' + JSON.stringify(err));
                }
            });
            
            console.log('ç»Ÿè®¡æ•°æ®å¯¼å‡ºæˆåŠŸ: ' + fileName);
        } catch (e) {
            console.log('æ•°æ®å¯¼å‡ºå¤±è´¥: ' + e.message);
            api.toast({
                msg: 'æ•°æ®å¯¼å‡ºå¤±è´¥: ' + e.message,
                duration: 2000,
                location: 'top'
            });
        }
    }

    // æ¸…ç©ºç»Ÿè®¡è®°å½•
    function clearStatistics() {
        api.confirm({
            title: 'ç¡®è®¤æ¸…ç©º',
            msg: 'ç¡®å®šè¦æ¸…ç©º' + currentYear + 'å¹´çš„æ‰€æœ‰è­¦æŠ¥è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚',
            buttons: ['å–æ¶ˆ', 'ç¡®å®šæ¸…ç©º']
        }, function(ret) {
            if (ret.buttonIndex === 2) {
                alertRecords = [];
                saveAlertRecords();
                console.log('å·²æ¸…ç©º' + currentYear + 'å¹´çš„æ‰€æœ‰è­¦æŠ¥è®°å½•');
                
                // åˆ·æ–°ç»Ÿè®¡é¡µé¢
                generateStatistics();
                
                api.toast({
                    msg: currentYear + 'å¹´è®°å½•å·²æ¸…ç©º',
                    duration: 2000,
                    location: 'top'
                });
            }
        });
    }

    // ä¿å­˜è­¦æŠ¥è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
    function saveAlertRecords() {
        try {
            api.setPrefs({
                key: 'alertRecords_' + currentYear,
                value: JSON.stringify(alertRecords)
            });
        } catch (e) {
            console.log('ä¿å­˜è­¦æŠ¥è®°å½•å¤±è´¥: ' + e.message);
        }
    }

    // åˆ†äº«ç»Ÿè®¡ç»“æœ
    function shareStatistics() {
        if (alertRecords.length === 0) {
            api.toast({
                msg: 'æš‚æ— æ•°æ®å¯åˆ†äº«',
                duration: 2000,
                location: 'top'
            });
            return;
        }
        
        try {
            // ç”Ÿæˆåˆ†äº«æ–‡æœ¬
            var shareText = generateShareText();
            console.log('åˆ†äº«æ–‡æœ¬ï¼š' + shareText);
            
            // è°ƒç”¨ç³»ç»Ÿåˆ†äº«åŠŸèƒ½
            var shareAction = api.require('shareAction');
            shareAction.shareText({
                text: shareText
            });
        } catch (e) {
            console.log('åˆ†äº«åŠŸèƒ½å¼‚å¸¸: ' + e.message);
            api.toast({
                msg: 'åˆ†äº«åŠŸèƒ½å¼‚å¸¸',
                duration: 2000,
                location: 'top'
            });
        }
    }

    // ç”Ÿæˆåˆ†äº«æ–‡æœ¬
    function generateShareText() {
        var totalAlerts = alertRecords.length;
        var avgPerMonth = totalAlerts > 0 ? (totalAlerts / 12).toFixed(1) : 0;
        
        // è®¡ç®—æœ€é«˜æœˆæ¬¡æ•°
        var monthlyData = new Array(12).fill(0);
        alertRecords.forEach(function(record) {
            if (record.year === currentYear) {
                if (record.month >= 1 && record.month <= 12) {
                    monthlyData[record.month - 1]++;
                }
            }
        });
        var maxMonth = Math.max(...monthlyData);
        
        // è®¡ç®—æœ€è¿‘è­¦æŠ¥æ—¶é—´
        var lastAlert = 'æ— ';
        if (alertRecords.length > 0) {
            var sortedRecords = alertRecords.slice().sort(function(a, b) {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            var lastRecord = sortedRecords[0];
            var lastDate = new Date(lastRecord.timestamp);
            var now = new Date();
            var diffDays = Math.floor((now - lastDate) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                lastAlert = 'ä»Šå¤©';
            } else if (diffDays === 1) {
                lastAlert = 'æ˜¨å¤©';
            } else if (diffDays < 7) {
                lastAlert = diffDays + 'å¤©å‰';
            } else {
                lastAlert = lastRecord.date;
            }
        }
        
        var shareText = `ğŸš¨ ${currentYear}å¹´è¿åœè­¦æŠ¥ç»Ÿè®¡æŠ¥å‘Š
        
ğŸ“Š ç»Ÿè®¡æ¦‚è§ˆï¼š
â€¢ æ€»è­¦æŠ¥æ¬¡æ•°ï¼š${totalAlerts}æ¬¡
â€¢ æœˆå¹³å‡æ¬¡æ•°ï¼š${avgPerMonth}æ¬¡
â€¢ æœ€é«˜æœˆæ¬¡æ•°ï¼š${maxMonth}æ¬¡
â€¢ æœ€è¿‘è­¦æŠ¥ï¼š${lastAlert}

ğŸ“ˆ ä½¿ç”¨äº¤è­¦çŸ­ä¿¡æé†’APPï¼ŒåŠæ—¶æŒæ¡è¿ç« ä¿¡æ¯ï¼Œé¿å…é€¾æœŸå¤„ç†ï¼

#äº¤è­¦çŸ­ä¿¡æé†’ #è¿ç« ç»Ÿè®¡ #å®‰å…¨é©¾é©¶`;
        
        return shareText;
    }
</script>

</body>
</html> 