<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <title>交警短信增强提醒</title>
    <link rel="stylesheet" href="../css/api.css">
    <style>
        .container {padding: 15px;}
        .switch-box {display: flex; justify-content: space-between; align-items: center; margin: 20px 0;}
        .status {color: #666; font-size: 14px;}
        .error {color: #ff4444; font-size: 12px; margin-top: 10px;}
        .success {color: #44aa44; font-size: 12px; margin-top: 10px;}
        .log-item {margin: 5px 0; padding: 5px; background: #f5f5f5; border-radius: 3px;}
        .log-time {color: #999; font-size: 10px;}
        .log-content {color: #333; font-size: 12px;}
        .btn {padding: 10px 20px; margin: 5px; background: #007aff; color: white; border: none; border-radius: 5px; cursor: pointer;}
        .btn:disabled {background: #ccc; cursor: not-allowed; opacity: 0.6;}
        .btn:enabled:hover {background: #0056cc;}
        .btn-small {padding: 5px 10px; font-size: 12px;}
        .btn-danger {background: #ff4444;}
        .btn-danger:hover {background: #cc0000;}
        .settings {background: #f8f8f8; padding: 10px; border-radius: 5px; margin: 0px 0;}
        .warning {background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0; color: #856404;}
        .button-group {display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;}
        .button-group .btn {flex: 1; min-width: 120px;}
        .keyword-item {display: flex; align-items: center; margin: 5px 0; gap: 10px;}
        .keyword-input {flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 3px;}
        .logic-selector {margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 5px;}
        .logic-selector label {margin-right: 15px; font-weight: bold;}
        .volume-control {margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 5px;}
        .volume-item {margin: 5px 0; display: flex; align-items: center; gap: 10px;}
        .volume-item span {font-weight: bold; color: #007aff;}
        
        /* 删除按钮样式 */
        .btn-delete {width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #ffffff;}
        
        /* 音量控制样式 */
        .volume-slider {width: 150px; accent-color: #ff0000;}
        .volume-value {color: #ff0000; font-weight: bold; min-width: 40px; text-align: right; display: inline-block;}
        .current-volume-display {font-weight: bold; color: #007aff;}
        
        /* 防止音量显示抖动 */
        .volume-item {margin: 5px 0; display: flex; align-items: center; gap: 10px; min-height: 30px;}
        .volume-item span {font-weight: bold; color: #007aff; white-space: nowrap;}
        
        /* 其他样式 */
        .add-keyword-btn {margin-top: 10px;}
        .log-area {margin-top: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fafafa;}
        .error-hidden {display: none;}

        /* 音效控制样式 */
        .sound-control {margin: 15px 0; padding: 10px; background: #f0f0f0; border-radius: 5px;}
        .sound-item {margin: 5px 0; display: flex; align-items: center; gap: 10px;}
        .sound-selector {flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 3px;}
        
        /* 号码匹配样式 */
        .number-disabled {color: #999; font-weight: normal;}
        .number-enabled {color: #000; font-weight: bold;}
        
        /* 开关控制样式 */
        .section-disabled {opacity: 0.5; pointer-events: none;}
        .number-input-disabled {color: #999; }
        .number-input-enabled {color: #000; }
        
        /* 适配框架页面 */
        .container {
            padding-bottom: 20px; /* 减少底部间距 */
        }
        
        /* 自定义开关样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            background-color: #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: none;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .switch:checked {
            background-color: #4CAF50;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 0 2px rgba(76, 175, 80, 0.2);
        }
        
        .switch:not(:checked) {
            background-color: #9e9e9e;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 0 2px rgba(158, 158, 158, 0.2);
        }
        
        .switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .switch:checked::before {
            transform: translateX(20px);
        }
        
        .switch:focus {
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 0 3px rgba(33, 150, 243, 0.3);
        }
        
        .switch:hover::before {
            box-shadow: 0 3px 6px rgba(0,0,0,0.25), 0 2px 4px rgba(0,0,0,0.15);
        }
        

    </style>
</head>
<body>
<div class="container">
    <h1>交警短信增强提醒</h1>
    
    <div class="warning">
        <strong>注意：</strong>需开启最高权限，如读取短信、关闭电源优化策略等。本应用不会联网，数据存储和分析均在本地，请放心使用。<br>
    </div>
    
    <div class="settings">
        <div class="switch-box">
            <span>短信监听开关</span>
            <input type="checkbox" id="smsSwitch" class="switch">
        </div>
        
        <div class="switch-box">
            <span>监听号码</span>
            <input type="text" id="targetNumber" placeholder="例如: 12123" value="12123" style="text-align: center;">
            <input type="checkbox" id="enableNumberMatch" class="switch" style="margin-left: 10px;">
        </div>

        
        <div id="keywordSection">
            <span>短信内容关键词：</span>
            <div id="keywordList">
                <div class="keyword-item">
                    <input type="text" class="keyword-input" value="湖北交警" placeholder="输入关键词">
                    <button class="btn btn-small btn-danger btn-delete" onclick="removeKeyword(this)">−</button>
                </div>
                <div class="keyword-item">
                    <input type="text" class="keyword-input" value="鄂AY366Q" placeholder="输入关键词">
                    <button class="btn btn-small btn-danger btn-delete" onclick="removeKeyword(this)">−</button>
                </div>
            </div>
            <button class="btn btn-small add-keyword-btn" onclick="addKeyword()">添加关键词</button>
        </div>
                
        <div id="logicSection" class="logic-selector">
            <label>关键词匹配：</label>
            <input type="radio" id="logicOr" name="logic" value="or" checked>
            <label for="logicOr">逻辑或</label>
            <input type="radio" id="logicAnd" name="logic" value="and">
            <label for="logicAnd">逻辑与</label>
        </div>

        <div class="volume-control">
            <label>音量控制：</label>
            <div class="volume-item">
                <span>当前系统音量：</span>
                <span id="currentVolume" class="current-volume-display">获取中...</span>
                <button class="btn btn-small" onclick="refreshCurrentVolume()">刷新</button>
            </div>
            <div class="volume-item">
                <span>设置警报音量：</span>
                <input type="range" id="alertVolume" class="volume-slider" min="0" max="100" value="30">
                <span id="alertVolumeValue" class="volume-value">30%</span>
            </div>
        </div>

        <div class="sound-control">
            <label>音效选择：</label>
            <button class="btn btn-small" id="testSoundBtn" onclick="testSound()">试听</button>
            <br>
            <input type="radio" id="soundShort" name="sound" value="short_ring.mp3" checked>
            <label for="soundShort">简短铃声</label>
            <input type="radio" id="soundPolice" name="sound" value="policeCar_alert.mp3">
            <label for="soundPolice">警车警报</label>
        </div>
    </div>
    
    <div class="status" id="statusText">当前状态: 未监听</div>
    <div id="errorText" class="error error-hidden"></div>
    
    <div class="button-group">
        <button class="btn" onclick="checkSMSPermission()">检查权限</button>
        <button class="btn" onclick="clearLogs()">清空日志</button>
        <button class="btn" onclick="manualTestAlert()">手动测试警报</button>
        <!-- <button class="btn" onclick="stopAlert()">停止警报铃声</button> -->
        <!-- <button class="btn" onclick="showStatistics()">查看统计</button> -->
    </div>
    
    <div id="logArea" class="log-area"></div>
</div>

<script src="../script/api.js"></script>
<script>
    var smsListenerModule = null; // 短信监听模块
    var acc5Util = null; // 引入acc5Util模块-控制音量
    var moduleProcessAlive = null; // YB-自己的进程守护模块，用于保活
    var moduleNotification = null; // YB-自己的通知模块
    var isListening = false; // 是否开启监听
    var targetNumber = '12123'; // 监听短信的目标号码
    var keywords = ['湖北交警', '鄂AY366Q']; // 初始化默认关键词
    var matchLogic = 'or'; // 逻辑：'or' 或 'and'
    var isPlaying = false; // 是否正在播放警报铃声
    var selectedSound = 'short_ring.mp3'; // 当前选择的音效文件
    var isTestPlaying = false; // 是否正在试听音效
    var enableNumberMatch = false; // 是否启用号码匹配
    var isDialogShowing = false; // 是否正在显示对话框
    
    // 统计相关变量
    var alertRecords = []; // 警报记录数组
    var currentYear = new Date().getFullYear(); // 当前年份

    // ========== 唯一实例ID和互斥锁 ===========
    window.__SMS_MONITOR_INSTANCE_ID = window.__SMS_MONITOR_INSTANCE_ID || Date.now() + '-' + Math.floor(10000 + Math.random() * 90000);
    window.__SMS_MONITOR_LOCK = window.__SMS_MONITOR_LOCK || false;

    apiready = function() {
        // 互斥锁判断，若已有实例则直接return
        if (window.__SMS_MONITOR_LOCK) {
            console.log('【SMS监听】已有实例在运行，本实例不再注册监听:', window.__SMS_MONITOR_INSTANCE_ID);
            return;
        }
        window.__SMS_MONITOR_LOCK = true;
        console.log('【SMS监听】实例启动:', window.__SMS_MONITOR_INSTANCE_ID);
        
        // 检查权限
        checkSMSPermission();
        
        // 尝试初始化短信监听模块
        initSMSListenerModule();

        // 初始化UI
        initUI();

        // 初始化acc5Util模块
        initAcc5Util();
        
        // 加载警报记录
        loadAlertRecords();
        
        // 页面卸载时确保停止播放
        api.addEventListener({
            name: 'pause'
        }, function(ret, err) {
            if (isPlaying) {
                api.stopPlay();
                isPlaying = false;
                updateStatusDisplay();
                addLog('页面暂停，停止警报铃声', 'warning');
                
                // 恢复原始音量
                restoreOriginalVolume();
            }
            
            // 重置试听状态
            if (isTestPlaying) {
                api.stopPlay();
                isTestPlaying = false;
                document.getElementById('testSoundBtn').textContent = '试听';
                addLog('页面暂停，停止音效试听', 'warning');
                
                // 恢复原始音量
                restoreOriginalVolume();
            }
            // 页面暂停时释放互斥锁
            window.__SMS_MONITOR_LOCK = false;
            console.log('【SMS监听】实例释放锁:', window.__SMS_MONITOR_INSTANCE_ID);
        });
    };

    // 初始化UI
    function initUI() {
        // 获取开关元素
        var smsSwitch = document.getElementById('smsSwitch');
        var statusText = document.getElementById('statusText');
        
        // 从本地存储加载设置
        var savedListening = api.getPrefs({sync: true, key: 'isListening'});
        if(savedListening === 'true') {
            smsSwitch.checked = true;
            statusText.textContent = '当前状态: 监听中';
            // 启用相关区域
            enableSections();
            // 延迟启动监听，确保模块已初始化
            setTimeout(function() {
                startSMSListener();
            }, 500);
        } else {
            // 禁用相关区域
            disableSections();
        }
        
        // 监听开关变化
        smsSwitch.addEventListener('change', function(e) {
            if(e.target.checked) {
                statusText.textContent = '当前状态: 正在启动监听...';
                startSMSListener();
                // 启用相关区域
                enableSections();
            } else {
                statusText.textContent = '当前状态: 已停止监听';
                stopSMSListener();
                // 禁用相关区域
                disableSections();
            }
            // 保存设置
            api.setPrefs({
                key: 'isListening',
                value: e.target.checked.toString()
            });
        });
        
        // 加载目标号码
        var savedTargetNumber = api.getPrefs({sync: true, key: 'targetNumber'});
        if(savedTargetNumber) {
            document.getElementById('targetNumber').value = savedTargetNumber;
            targetNumber = savedTargetNumber;
        }
        
        // 加载号码匹配设置
        var savedNumberMatch = api.getPrefs({sync: true, key: 'enableNumberMatch'});
        if(savedNumberMatch === 'true') {
            enableNumberMatch = true;
            document.getElementById('enableNumberMatch').checked = true;
            updateNumberDisplay(true);
        } else {
            updateNumberDisplay(false);
        }
        
        // 监听号码输入变化
        document.getElementById('targetNumber').addEventListener('input', function(e) {
            targetNumber = e.target.value;
            api.setPrefs({
                key: 'targetNumber',
                value: targetNumber
            });
        });
        
        // 监听号码匹配checkbox变化
        document.getElementById('enableNumberMatch').addEventListener('change', function(e) {
            enableNumberMatch = e.target.checked;
            updateNumberDisplay(enableNumberMatch);
            
            // 保存设置
            api.setPrefs({
                key: 'enableNumberMatch',
                value: enableNumberMatch.toString()
            });
            
            addLog('号码匹配已' + (enableNumberMatch ? '启用' : '禁用'), 'success');
        });
        
        // 加载关键词
        var savedKeywords = api.getPrefs({sync: true, key: 'keywords'});
        if(savedKeywords) {
            keywords = JSON.parse(savedKeywords);
            updateKeywordUI();
        }
        
        // 加载匹配逻辑
        var savedLogic = api.getPrefs({sync: true, key: 'matchLogic'});
        if(savedLogic) {
            matchLogic = savedLogic;
            document.getElementById('logic' + matchLogic.charAt(0).toUpperCase() + matchLogic.slice(1)).checked = true;
        }
        
        // 监听逻辑选择变化
        document.querySelectorAll('input[name="logic"]').forEach(function(radio) {
            radio.addEventListener('change', function(e) {
                matchLogic = e.target.value;
                api.setPrefs({
                    key: 'matchLogic',
                    value: matchLogic
                });
                addLog('匹配逻辑已更改为: ' + (matchLogic === 'or' ? '逻辑或' : '逻辑与'), 'success');
            });
        });

        // 初始化音量控制
        initVolumeControl();
        
        // 初始化音效控制
        initSoundControl();
    }

    // 更新关键词UI
    function updateKeywordUI() {
        var keywordList = document.getElementById('keywordList');
        keywordList.innerHTML = '';
        
        keywords.forEach(function(keyword, index) {
            var item = document.createElement('div');
            item.className = 'keyword-item';
            item.innerHTML = `
                <input type="text" class="keyword-input" value="${keyword}" placeholder="输入关键词" onchange="updateKeyword(${index}, this.value)">
                <button class="btn btn-small btn-danger btn-delete" onclick="removeKeyword(this, ${index})">−</button>
            `;
            keywordList.appendChild(item);
        });
    }

    // 添加关键词的操作
    function addKeyword() {
        keywords.push('');
        updateKeywordUI();
        saveKeywords();
        addLog('已添加新关键词', 'success');
    }

    // 删除关键词的操作
    function removeKeyword(button, index) {
        if (keywords.length <= 1) {
            api.toast({
                msg: '至少需要保留一个关键词',
                duration: 3000,
                location: 'top'
            });
            addLog('至少需要保留一个关键词', 'error');
            return;
        }
        keywords.splice(index, 1);
        updateKeywordUI();
        saveKeywords();
        addLog('已删除关键词', 'success');
    }

    // 更新关键词的操作
    function updateKeyword(index, value) {
        keywords[index] = value;
        saveKeywords();
        addLog('关键词已更新: ' + value, 'success');
    }

    function saveKeywords() {
        api.setPrefs({
            key: 'keywords',
            value: JSON.stringify(keywords)
        });
    }

    // 初始化短信监听模块
    function initSMSListenerModule() {
        try {
            // 使用正确的smsListener模块，用于监听短信
            smsListenerModule = api.require('smsListener');
            moduleProcessAlive = api.require('moduleProcessAlive_2024'); // YB-自己的进程守护模块，用于保活
            moduleNotification = api.require('moduleNotification_2022'); // YB-自己的通知模块
            addLog('短信监听模块初始化成功，另有进程守护模块和通知模块', 'success');
        } catch (e) {
            addLog('短信监听模块初始化失败: ' + e.message, 'error');
            showError('短信监听模块不可用，请检查APICloud配置');
        }
    }

    // 初始化acc5Util模块-用于控制音量
    function initAcc5Util() {
        try {
            // 使用正确的acc5Util模块，用于控制音量
            acc5Util = api.require('acc5Util');
            addLog('acc5Util模块初始化成功', 'success');
            
            // 模块初始化成功后立即获取系统音量
            setTimeout(function() {
                refreshCurrentVolume();
            }, 200); // 延迟200ms确保模块完全初始化
            
        } catch (e) {
            addLog('acc5Util模块初始化失败: ' + e.message, 'error');
            showError('acc5Util模块不可用，请检查APICloud配置');
        }
    }

    // 检查短信读取权限
    function checkSMSPermission() {
        var permissions = ['sms']; // 短信读取权限，查询官网确定
        
        try {
            api.requestPermission({
                list: permissions,
                code: 100001
            }, function(ret, err) {
                
                if (err) {
                    addLog('权限请求出错: ' + JSON.stringify(err), 'error');
                    showError('权限请求出错: ' + err.msg);
                    return;
                }
                
                if (ret) {
                    if (ret.list && ret.list.length > 0) {
                        var granted = ret.list.filter(function(item) {
                            return item.granted;
                        });
                        
                        if (granted.length > 0) {
                            addLog('短信读取权限已授权', 'success');
                        } else {
                            addLog('短信读取权限被拒绝', 'error');
                            showError('需要短信读取权限才能使用此功能');
                            
                            // 提示用户手动开启权限
                            api.confirm({
                                title: '权限被拒绝',
                                msg: '短信读取权限被拒绝，请在系统设置中手动开启权限。是否前往设置？',
                                buttons: ['取消', '去设置']
                            }, function(ret) {
                                if (ret.buttonIndex === 2) {
                                    // 打开应用设置页面
                                    api.openApp({
                                        androidPkg: 'com.android.settings',
                                        mimeType: 'text/html',
                                        uri: 'package:' + api.appId
                                    });
                                }
                            });
                        }
                    } else {
                        addLog('权限列表为空', 'error');
                        showError('权限列表为空，请检查权限配置');
                    }
                } else {
                    addLog('权限请求无返回结果', 'error');
                    showError('权限请求无返回结果');
                }
            });
        } catch (e) {
            addLog('权限请求异常: ' + e.message, 'error');
            showError('权限请求异常: ' + e.message);
        }
    }


    // 启动短信监听功能
    function startSMSListener() {
        if (!smsListenerModule) {
            addLog('短信监听模块未初始化，无法启动监听', 'error');
            showError('短信监听模块未初始化');
            return;
        }

        if (isListening) {
            addLog('监听已启动，跳过重复注册', 'info');
            return;
        }

        try {
             // 先注销，确保不会重复注册
            smsListenerModule.unRegisterSmsListener();

            // 使用正确的API注册短信监听
            smsListenerModule.registerSmsListener(function(ret) {
                // addLog('收到短信: ' + JSON.stringify(ret), 'success');
                processSMS(ret);
            });
            
            isListening = true;
            addLog('短信监听已启动', 'success');
            startAlive(); // 同时开启线程常驻
        } catch (e) {
            addLog('启动短信监听失败: ' + e.message, 'error');
            showError('启动短信监听失败');
        }
    }

    // 停止短信监听功能
    function stopSMSListener() {
        try {
            if (smsListenerModule) {
                // 使用正确的API注销短信监听
                smsListenerModule.unRegisterSmsListener();
            }
            
            isListening = false;
            addLog('短信监听已停止', 'success');
            
        } catch (e) {
            addLog('停止短信监听失败: ' + e.message, 'error');
        }
    }

    // 存储最近处理的短信（用于去重）
    // 从localStorage加载最近处理记录（跨会话/实例共享）
    var storedRecentSMS = localStorage.getItem('recentSMS');
    var recentSMS = storedRecentSMS ? JSON.parse(storedRecentSMS) : { timestamp: 0, tel: '', content: '' };
    var SMS_DUPLICATE_WINDOW = 5000; // 去重时间窗口（毫秒）

    // 对监听到的短信进行处理，满足条件后触发提醒
    function processSMS(sms) {
        if (!sms || !sms.tel) {
            return;
        }
        
        // 读取最新的去重记录（解决多实例同步问题）
        var storedRecentSMS = localStorage.getItem('recentSMS');
        var storedAlertRecords = api.getPrefs({sync: true, key: 'alertRecords_' + currentYear});
        var currentRecentSMS = storedRecentSMS ? JSON.parse(storedRecentSMS) : { timestamp: 0, tel: '', content: '' };

        // 刷新警报记录确保使用最新数据
        loadAlertRecords();

        // 检查是否为重复短信   
        // 去重逻辑：检查是否在短时间内收到相同内容的短信
        var now = Date.now();
        // 按天去重逻辑：同一天内相同手机号和内容视为重复
        var currentDate = new Date().toISOString().split('T')[0];
        var recentDate = new Date(currentRecentSMS.timestamp).toISOString().split('T')[0];
        var isDuplicate = (currentDate === recentDate && 
                          currentRecentSMS.tel === sms.tel && 
                          currentRecentSMS.content === sms.content);
        
        // 同时检查历史警报记录防止多实例重复
        if (!isDuplicate) {
            var storedAlertRecords = api.getPrefs({sync: true, key: 'alertRecords_' + currentYear});
            var latestAlertRecords = storedAlertRecords ? JSON.parse(storedAlertRecords) : [];
            var recentAlert = latestAlertRecords.find(function(record) {
                var recordTimestamp = new Date(record.timestamp).getTime();
                var recordDate = new Date(recordTimestamp).toISOString().split('T')[0];
                var currentDate = new Date().toISOString().split('T')[0];
                return (currentDate === recordDate &&
                    record.phoneNumber === sms.tel &&
                    record.content === sms.content);
            });
            isDuplicate = !!recentAlert;
        }
        
        if (isDuplicate) {
            addLog('检测到重复短信，已忽略处理', 'warning');
            return;
        }
        
        // 并发更新检测：验证期间是否有其他实例修改了数据
        var latestStoredRecentSMS = localStorage.getItem('recentSMS');
        var latestStoredAlertRecords = api.getPrefs({sync: true, key: 'alertRecords_' + currentYear});
        if (latestStoredRecentSMS !== storedRecentSMS || latestStoredAlertRecords !== storedAlertRecords) {
            addLog('检测到并发更新，重新检查重复', 'info');
            return processSMS(sms); // 重试检测流程
        }
        
        // 确定非重复后立即同步到localStorage（防止竞态条件）
        var newRecentSMS = { timestamp: now, tel: sms.tel, content: sms.content };
        localStorage.setItem('recentSMS', JSON.stringify(newRecentSMS));
        recentSMS = newRecentSMS;
        
        addLog('收到短信来自: ' + sms.tel + ', 内容: ' + (sms.content ? sms.content.substr(0, 30) + '...' : '无内容'));
        
        // 如果启用了号码匹配，先检查号码
        if (enableNumberMatch) {
            if (sms.tel.indexOf(targetNumber) === -1) {
                addLog('号码不匹配，忽略短信', 'success');
                return;
            }
            addLog('号码匹配成功: ' + sms.tel, 'success');
        } else {
            addLog('号码匹配已禁用，跳过号码检查', 'success');
        }
        
        // 检查短信内容是否匹配关键词
        if (checkContentMatch(sms.content)) {
            addLog('短信内容匹配关键词，触发提醒', 'success');
            // 推送通知到通知栏
            showNotification('【紧急】交警短信', sms.content);
            
            // 记录警报事件
            recordAlert(sms);

            // 重点：播放提醒音效并在APP内弹窗
            playAlert(sms.content);
        } else {
            addLog('短信内容不匹配关键词，忽略', 'success');
        }
    }
    // 判断关键词是否匹配
    function checkContentMatch(content) {
        if (!content || keywords.length === 0) {
            return false;
        }
        
        var matchedKeywords = keywords.filter(function(keyword) {
            return keyword && content.indexOf(keyword) !== -1;
        });
        
        if (matchLogic === 'or') {
            // 逻辑或：任一关键词匹配即可
            return matchedKeywords.length > 0;
        } else {
            // 逻辑与：所有关键词都必须匹配
            return matchedKeywords.length === keywords.filter(function(k) { return k; }).length;
        }
    }

    // 播放提醒警报音效
    function playAlert(smsContent) {
        try {
            // 如果正在播放，先停止
            if (isPlaying) {
                api.stopPlay();
                isPlaying = false;
                addLog('停止之前的警报铃声', 'success');
            }
            
            // 播放提醒音效
            // 警车长音效：policeCar_alert.mp3
            // 简短三秒音效：short_ring.mp3
            var audioPath = 'widget://res/' + selectedSound; // 需要准备一个提醒音效
            
            isPlaying = true;
            addLog('开始连续播放警报铃声，点击"我知道了"停止', 'success');
            updateStatusDisplay();

            // 获取设置的警报音量
            var alertVolumePercent = document.getElementById('alertVolume').value;
            var alertVolume = alertVolumePercent / 100;
            
            // 保存当前音量并设置警报音量，通过回调接口实现音量设置后触发播放，避免异步问题
            saveAndSetVolume(alertVolume, function(success) {
                if (success) {
                    // 开始连续播放铃声
                    startContinuousPlay(audioPath, smsContent);
                } else {
                    isPlaying = false;
                    addLog('音量设置失败，无法播放警报铃声', 'error');
                    updateStatusDisplay();
                    restoreOriginalVolume();
                }
            });

            // 显示提醒对话框（如果还没有显示）
            if (!isDialogShowing) {
                showAlertDialog(smsContent);
            }
            
        } catch (e) {
            isPlaying = false;
            addLog('警报铃声播放异常: ' + e.message, 'error');
            updateStatusDisplay();
            // 异常情况下也要恢复原始音量
            restoreOriginalVolume();
        }
    }

    // 连续播放函数
    function startContinuousPlay(audioPath, smsContent) {
        if (!isPlaying) {
            return; // 如果已经停止播放，退出循环
        }
        
        api.startPlay({
            path: audioPath,
        }, function(ret, err) {
            if (ret) {
                // 播放完成，如果还在播放状态，继续播放下一遍
                if (isPlaying) {
                    addLog('警报铃声播放完成，继续下一遍...', 'success');
                    // 短暂延迟后继续播放
                    setTimeout(function() {
                        if (isPlaying) {
                            startContinuousPlay(audioPath, smsContent);
                        }
                    }, 500); // 500ms延迟确保音频设备完成播放周期
                } else {
                    addLog('警报铃声已停止', 'success');
                    updateStatusDisplay();
                    // 恢复原始音量
                    restoreOriginalVolume();
                }
            } else {
                isPlaying = false;
                addLog('警报铃声播放失败: ' + JSON.stringify(err), 'error');
                updateStatusDisplay();
                // 播放失败也要恢复原始音量
                restoreOriginalVolume();
                
            }
        });
    }

    // 显示提醒对话框
    function showAlertDialog(smsContent) {
        // 如果已经有对话框在显示，则不重复显示
        if (isDialogShowing) {
            addLog('对话框已在显示中，跳过重复显示', 'warning');
            return;
        }
        
        isDialogShowing = true;
        api.alert({
            title: '交警短信提醒',
            msg: '短信内容：' + smsContent,
            buttons: ['我知道了']
        }, function(ret) {
            // 用户点击后停止播放
            isDialogShowing = false; // 重置对话框状态
            if (isPlaying) {
                api.stopPlay();
                isPlaying = false;
                addLog('用户点击确认，停止警报铃声', 'success');
                updateStatusDisplay();
                // 确保恢复原始音量
                restoreOriginalVolume();
            }
        });
    }

    // 显示错误信息
    function showError(message) {
        var errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorText.classList.remove('error-hidden');
        
        // 3秒后自动隐藏错误信息
        setTimeout(function() {
            errorText.classList.add('error-hidden');
        }, 3000);
    }

    // 清空日志
    function clearLogs() {
        var logArea = document.getElementById('logArea');
        logArea.innerHTML = '';
        addLog('日志已清空', 'success');
    }

    // 添加日志：成功、失败、警告
    function addLog(text, type) {
        var logArea = document.getElementById('logArea');
        var time = new Date().toLocaleTimeString();
        var logItem = document.createElement('div');
        logItem.className = 'log-item';
        
        var timeSpan = document.createElement('div');
        timeSpan.className = 'log-time';
        timeSpan.textContent = time;
        
        var contentSpan = document.createElement('div');
        contentSpan.className = 'log-content';
        contentSpan.textContent = text;
        
        if (type === 'error') {
            contentSpan.style.color = '#ff4444';
        } else if (type === 'success') {
            contentSpan.style.color = '#44aa44';
        }
        
        logItem.appendChild(timeSpan);
        logItem.appendChild(contentSpan);
        
        // 在顶部插入新的日志
        if (logArea.firstChild) {
            logArea.insertBefore(logItem, logArea.firstChild);
        } else {
            logArea.appendChild(logItem);
        }
        
        // 限制日志数量，最多显示50条
        while (logArea.children.length > 50) {
            logArea.removeChild(logArea.lastChild);
        }
        
        console.log(time + ': ' + text);
    }

    // 手动测试提醒功能-触发短信后续逻辑
    function manualTestAlert() {
        addLog('手动测试提醒功能', 'success');
        
        // 模拟收到目标号码的短信
        var mockSMS = {
            tel: targetNumber,
            content: keywords.join('、') + '\n提醒：您的车辆在XX路段有违章记录，请及时处理。'
        };
        
        addLog('模拟收到短信: ' + JSON.stringify(mockSMS), 'success');
        processSMS(mockSMS);
        
        // 添加一些测试数据用于演示统计功能
        // addTestData();
    }
    
    // 添加测试数据
    function addTestData() {
        // 只在开发模式下添加测试数据
        if (alertRecords.length < 5) {
            var testData = [
                {
                    tel: '12123',
                    content: '【TEST】湖北交警提醒：您的车辆鄂AY366Q在XX路段有违停记录，请及时处理。'
                },
                {
                    tel: '12123', 
                    content: '【TEST】湖北交警提醒：鄂AY366Q车辆在YY路段违停，请尽快处理。'
                },
                {
                    tel: '12123',
                    content: '【TEST】湖北交警提醒：鄂AY366Q在ZZ路段有违章，请及时处理。'
                }
            ];
            
            testData.forEach(function(sms, index) {
                // 创建不同时间的测试记录
                var testDate = new Date();
                testDate.setDate(testDate.getDate() - (index + 1) * 7); // 每周一条记录
                
                var testRecord = {
                    id: Date.now() + index, // 唯一标识：毫秒级时间戳+index，确保唯一，位数不变
                    timestamp: testDate.toISOString(),
                    date: testDate.toISOString().split('T')[0], // 日期 2025-06-24
                    time: testDate.toLocaleTimeString(), // 时间 10:00:00
                    phoneNumber: sms.tel, // 手机号
                    content: sms.content, // 短信内容
                    year: testDate.getFullYear(),
                    month: testDate.getMonth() + 1,
                    day: testDate.getDate(),
                    weekday: testDate.getDay()
                };
                
                alertRecords.push(testRecord);
            });
            
            saveAlertRecords();
            addLog('已添加' + testData.length + '条测试数据用于演示统计功能', 'success');
        }
    }
    // 用于停止警报铃声
    function stopAlert() {
        if (isPlaying) {
            try {
                api.stopPlay();
                isPlaying = false;
                addLog('警报铃声已手动停止', 'success');
                updateStatusDisplay();
                
                // 恢复原始音量
                restoreOriginalVolume();
                
                api.toast({
                    msg: '警报铃声已停止',
                    duration: 2000,
                    location: 'top'
                });
            } catch (e) {
                addLog('停止警报铃声失败: ' + e.message, 'error');
                // 即使停止失败，也要重置状态
                isPlaying = false;
                updateStatusDisplay();
                // 确保恢复原始音量
                restoreOriginalVolume();
            }
        } else {
            addLog('没有正在播放的警报铃声', 'warning');
            api.toast({
                msg: '当前没有播放中的警报铃声',
                duration: 2000,
                location: 'top'
            });
        }
    }

    // 获取播放状态
    function getPlayingStatus() {
        return isPlaying;
    }

    // 更新铃声播放状态显示
    function updateStatusDisplay() {
        var statusText = document.getElementById('statusText');
        var currentStatus = statusText.textContent;
        var playingStatus = isPlaying ? ' (警报播放中)' : '';
        
        // 如果状态文本不包含播放状态，则添加
        if (isPlaying && currentStatus.indexOf('警报播放中') === -1) {
            statusText.textContent = currentStatus + playingStatus;
        } else if (!isPlaying && currentStatus.indexOf('警报播放中') !== -1) {
            // 移除播放状态
            statusText.textContent = currentStatus.replace(' (警报播放中)', '');
        }
    }

    // 初始化音量控制
    function initVolumeControl() {
        // 加载保存的警报音量设置
        var savedAlertVolume = api.getPrefs({sync: true, key: 'alertVolume'});
        if(savedAlertVolume) {
            var volumePercent = parseFloat(savedAlertVolume) * 100;
            document.getElementById('alertVolume').value = volumePercent;
            document.getElementById('alertVolumeValue').textContent = volumePercent.toFixed(0) + '%';
        }
        
        // 节流函数，减少频繁更新
        var updateTimeout = null;
        var lastUpdateTime = 0;
        
        // 监听音量滑块变化 - 使用节流减少更新频率
        document.getElementById('alertVolume').addEventListener('input', function(e) {
            var volumePercent = e.target.value;
            var currentTime = Date.now();
            
            // 立即更新显示，但限制更新频率
            if (currentTime - lastUpdateTime > 50) { // 50ms节流
                document.getElementById('alertVolumeValue').textContent = volumePercent + '%';
                lastUpdateTime = currentTime;
            }
            
            // 清除之前的定时器
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // 延迟保存设置，避免频繁写入
            updateTimeout = setTimeout(function() {
                api.setPrefs({
                    key: 'alertVolume',
                    value: (volumePercent / 100).toString()
                });
            }, 200); // 200ms后保存
        });
        
        // 监听音量滑块拖动结束 - 只在拖动结束后打印日志
        document.getElementById('alertVolume').addEventListener('change', function(e) {
            var volumePercent = e.target.value;
            // 确保最终值正确显示
            document.getElementById('alertVolumeValue').textContent = volumePercent + '%';
            addLog('警报音量已设置为: ' + volumePercent + '%', 'success');
        });
    }

    // 刷新当前系统音量
    function refreshCurrentVolume() {
        if (!acc5Util) {
            document.getElementById('currentVolume').textContent = '模块未初始化';
            addLog('acc5Util模块未初始化，无法获取系统音量', 'warning');
            return;
        }
        
        // 先获取当前音量：system：系统音量，music：媒体音量，ring：铃声音量，call：通话音量，alarm：闹钟音量，notice
        acc5Util.getVol({}, function(ret, err) {
            if (ret && ret.data) {
                console.log('----------------当前系统音量：' + JSON.stringify(ret));
                var currentVolume = ret.data.music;
                document.getElementById('currentVolume').textContent = (currentVolume * 100).toFixed(0) + '%';
                addLog('当前系统音量: ' + (currentVolume * 100).toFixed(0) + '%', 'success');
            } else {
                document.getElementById('currentVolume').textContent = '获取失败';
                addLog('获取系统音量失败: ' + JSON.stringify(err), 'error');
                
                // 如果获取失败，可能是模块还未完全初始化，延迟重试
                setTimeout(function() {
                    if (acc5Util) {
                        addLog('重试获取系统音量...', 'warning');
                        refreshCurrentVolume();
                    }
                }, 1000);
            }
        });
    }

    // 记录原始音量
    var originalVolume = 0; // 值为0到1之间的小数，0为静音，1为最大音量。
    
    // 保存当前音量并设置新音量
    function saveAndSetVolume(newVolume, callback) {
    if (!acc5Util) {
        addLog('acc5Util模块未初始化，无法控制音量', 'error');
        if (callback) callback(false);
        return false;
    }
    
    // 先获取当前音量：system：系统音量，music：媒体音量，ring：铃声音量，call：通话音量，alarm：闹钟音量，notice: 通知音量
    acc5Util.getVol({}, function(ret, err) {
        if (ret && ret.data) {
            originalVolume = ret.data.music;
            console.log('----------------当前系统音量2：' + JSON.stringify(ret));
            addLog('保存原始音量: ' + (originalVolume * 100).toFixed(0) + '%', 'success');
            
            // 设置新音量
            acc5Util.setVol({value: newVolume}, function(setRet, setErr) {
                if (setRet) {
                    addLog('设置警报音量: ' + (newVolume * 100).toFixed(0) + '%', 'success');
                    if (callback) callback(true);
                } else {
                    addLog('设置音量失败: ' + JSON.stringify(setErr), 'error');
                    if (callback) callback(false);
                }
            });
        } else {
            addLog('获取原始音量失败: ' + JSON.stringify(err), 'error');
            if (callback) callback(false);
        }
    });
    
    return true;
}
    
    // 恢复原始音量
    function restoreOriginalVolume() {
        if (!acc5Util || originalVolume === 0) {
            return;
        }
        
        acc5Util.setVol({value: originalVolume}, function(ret, err) {
            if (ret) {
                addLog('恢复原始音量: ' + (originalVolume * 100).toFixed(0) + '%', 'success');
                // 恢复原始音量后，更新当前音量显示
                refreshCurrentVolume();
            } else {
                addLog('恢复音量失败: ' + JSON.stringify(err), 'error');
            }
        });
    }

    // 开启线程常驻
    function startAlive() {
        console.log('----------------：开启线程常驻');
        var params = {
        };
        console.log('----------------线程常驻对象1：' + moduleProcessAlive);
        moduleProcessAlive = api.require('moduleProcessAlive_2024');
        moduleProcessAlive.startAlive(params, function (ret, err) {
            console.log('----------------线程常驻返回：' + JSON.stringify(ret));
            if (ret) {
                var data = ret.data;
                addLog('线程常驻已启动', 'success');
            } else {
                addLog('线程常驻启动失败: ' + JSON.stringify(err), 'error');
            }
        });
    }
    // 停止线程常驻-未成功
    function stopAlive() {
        var params = {
        };
        moduleProcessAlive.stopAlive(params, function (ret, err) {
            if (ret) {
                var data = ret.data;
                addLog('线程常驻已停止', 'success');
            } else {
                addLog('线程常驻停止失败: ' + JSON.stringify(err), 'error');
            }
        });
    }
    // 显示通知
    function showNotification(title, content){
			var params = {
				title : title,
				content : content
			};
			moduleNotification.showNotification(params, function(ret, err){
                if (ret) {
                    addLog('显示通知成功: ' + JSON.stringify(ret), 'success');
                } else {
                    addLog('显示通知失败: ' + JSON.stringify(err), 'error');
                }
            });
		}

    // 初始化音效控制
    function initSoundControl() {
        // 加载保存的音效设置
        var savedSound = api.getPrefs({sync: true, key: 'selectedSound'});
        if(savedSound) {
            selectedSound = savedSound;
            if(selectedSound === 'short_ring.mp3') {
                document.getElementById('soundShort').checked = true;
                document.getElementById('soundPolice').checked = false;
            } else {
                document.getElementById('soundShort').checked = false;
                document.getElementById('soundPolice').checked = true;
            }
        }
        
        // 监听音效选择变化
        document.querySelectorAll('input[name="sound"]').forEach(function(radio) {
            radio.addEventListener('change', function(e) {
                if(e.target.checked) {
                    selectedSound = e.target.value;
                    
                    // 保存音效设置
                    api.setPrefs({
                        key: 'selectedSound',
                        value: selectedSound
                    });
                    
                    var soundName = selectedSound === 'short_ring.mp3' ? '简短铃声 (3秒)' : '警车警报 (长音)';
                    addLog('警报音效已更改为: ' + soundName, 'success');
                }
            });
        });
    }

    // 试听音效
    function testSound() {
        var testBtn = document.getElementById('testSoundBtn');
        
        if (isTestPlaying) {
            // 如果正在试听，则停止试听
            try {
                api.stopPlay();
                isTestPlaying = false;
                testBtn.textContent = '试听';
                addLog('音效试听已停止', 'success');
                
                // 停止试听时也要恢复原始音量
                restoreOriginalVolume();
            } catch (e) {
                addLog('停止试听失败: ' + e.message, 'error');
                // 即使停止失败，也要重置状态和恢复音量
                isTestPlaying = false;
                testBtn.textContent = '试听';
                restoreOriginalVolume();
            }
            return;
        }
        
        if (isPlaying) {
            api.toast({
                msg: '请先停止当前播放的警报铃声',
                duration: 2000,
                location: 'top'
            });
            return;
        }
        
        try {
            var audioPath = 'widget://res/' + selectedSound;
            addLog('开始试听音效: ' + selectedSound, 'success');
            
            isTestPlaying = true;
            testBtn.textContent = '停止';
            
            // 获取设置的警报音量
            var alertVolumePercent = document.getElementById('alertVolume').value;
            var alertVolume = alertVolumePercent / 100;
            // 保存当前音量并设置警报音量
            saveAndSetVolume(alertVolume);
            
            api.startPlay({
                path: audioPath,
            }, function(ret, err) {
                if (ret) {
                    addLog('音效试听完成', 'success');
                } else {
                    addLog('音效试听失败: ' + JSON.stringify(err), 'error');
                }
                
                // 试听完成后恢复按钮状态
                isTestPlaying = false;
                testBtn.textContent = '试听';

                // 试听完成后恢复原始音量
                restoreOriginalVolume();
            });
        } catch (e) {
            addLog('音效试听异常: ' + e.message, 'error');
            isTestPlaying = false;
            testBtn.textContent = '试听';
            
            // 异常情况下也要恢复原始音量
            restoreOriginalVolume();
        }
    }

    // 更新号码显示样式
    function updateNumberDisplay(enabled) {
        var numberLabel = document.querySelector('.switch-box:nth-child(2) span');
        var numberInput = document.getElementById('targetNumber');
        if (enabled) {
            numberLabel.classList.add('number-enabled');
            numberLabel.classList.remove('number-disabled');
            numberInput.classList.remove('number-input-disabled');
            numberInput.classList.add('number-input-enabled');
        } else {
            numberLabel.classList.add('number-disabled');
            numberLabel.classList.remove('number-enabled');
            numberInput.classList.add('number-input-disabled');
            numberInput.classList.remove('number-input-enabled');
        }
    }

    
    // 启用相关区域
    function enableSections() {
        document.getElementById('keywordSection').classList.remove('section-disabled');
        document.getElementById('logicSection').classList.remove('section-disabled');
        addLog('已启用关键词和逻辑匹配区域', 'success');
    }
    
    // 禁用相关区域
    function disableSections() {
        document.getElementById('keywordSection').classList.add('section-disabled');
        document.getElementById('logicSection').classList.add('section-disabled');
        addLog('已禁用关键词和逻辑匹配区域', 'success');
    }
    
    // ==================== 统计功能相关函数 ====================
    
    // 记录警报事件
    function recordAlert(sms) {
        // 第一次检查：加载最新记录
        loadAlertRecords();
        var currentDate = new Date().toISOString().split('T')[0];
        var exists = alertRecords.some(function(r) {
            return r.phoneNumber === sms.tel && r.content === sms.content && r.date === currentDate;
        });
        if (exists) {
            addLog('该短信已处理，跳过重复', 'info');
            return;
        }

        // 准备新记录
        let record = {
            id: Date.now(),
            timestamp: new Date().toISOString(),
            date: new Date().toISOString().split('T')[0],
            time: new Date().toLocaleTimeString(),
            phoneNumber: sms.tel,
            content: sms.content,
            year: new Date().getFullYear(),
            month: new Date().getMonth() + 1,
            day: new Date().getDate(),
            weekday: new Date().getDay()
        };


        // 第二次检查：保存前再次验证（防止并发添加）
        loadAlertRecords();
        exists = alertRecords.some(function(r) {
            return r.phoneNumber === sms.tel && r.content === sms.content && r.date === currentDate;
        });
        if (exists) {
            addLog('并发检测到重复记录，已自动跳过', 'info');
            return;
        }
        // 使用已准备的记录对象
        alertRecords.push(record);
        
        // 确保记录只被添加一次
        saveAlertRecords();
        addLog('已记录警报事件: ' + record.date + ' ' + record.time, 'success');
    }
    
    // 保存警报记录到本地存储
    function saveAlertRecords() {
        try {
            api.setPrefs({
                key: 'alertRecords_' + currentYear,
                value: JSON.stringify(alertRecords)
            });
        } catch (e) {
            addLog('保存警报记录失败: ' + e.message, 'error');
        }
    }
    
    // 从本地存储加载警报记录
    function loadAlertRecords() {
        try {
            var savedRecords = api.getPrefs({sync: true, key: 'alertRecords_' + currentYear});
            if (savedRecords) {
                alertRecords = JSON.parse(savedRecords);
                addLog('已加载' + alertRecords.length + '条警报记录', 'success');
            } else {
                alertRecords = [];
                addLog('未找到历史警报记录', 'info');
            }
        } catch (e) {
            alertRecords = [];
            addLog('加载警报记录失败: ' + e.message, 'error');
        }
    }
    
    // 显示统计页面
    function showStatistics() {
        // 通过父窗口切换页面
        if (api.winName === 'homeFrame') {
            // 如果在框架中，通知父窗口切换
            api.execScript({
                name: 'main',
                script: 'switchPage("statistics");'
            });
        } else {
            // 独立运行时，打开统计页面
            api.openWin({
                name: 'test_SMS_monitor_statistics',
                url: './test_SMS_monitor_statistics.html',
                pageParam: {
                    currentYear: currentYear
                }
            });
        }
    }
    

</script>

</body>
</html>