<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <title>打赏捐赠</title>
    <link rel="stylesheet" href="../css/api.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .donate-container {
            background: #fff;
            border-radius: 12px;
            margin-top: 40px;
            padding: 24px 16px 16px 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            text-align: center;
            max-width: 95vw;
        }
        .donate-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .donate-tip {
            font-size: 14px;
            color: #888;
            margin-bottom: 18px;
        }
        .donate-qrcodes {
            display: flex;
            gap: 24px;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
        }
        .donate-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .donate-item img {
            width: 140px;
            height: 140px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            background: #eee;
        }
        .donate-label {
            margin-top: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        .wechat {
            color: #44b549;
        }
        .alipay {
            color: #1677ff;
        }
        .donate-close {
            margin-top: 18px;
            padding: 8px 32px;
            background: #007aff;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="donate-container">
    <div class="donate-title">打赏捐赠</div>
    <div class="donate-tip">感谢您的支持！可长按保存收款码</div>
    <div class="donate-qrcodes">
        <div class="donate-item">
            <img src="../image/yb_wechat_qrcode.jpg" alt="微信收款码" oncontextmenu="saveDonateImg(this)" ontouchstart="donateImgTouchStart(event,this)" ontouchend="donateImgTouchEnd(event,this)">
            <div class="donate-label wechat">微信</div>
        </div>
        <div class="donate-item">
            <img src="../image/yb_alipay_qrcode.jpg" alt="支付宝收款码" oncontextmenu="saveDonateImg(this)" ontouchstart="donateImgTouchStart(event,this)" ontouchend="donateImgTouchEnd(event,this)">
            <div class="donate-label alipay">支付宝</div>
        </div>
    </div>
    <!-- 新增支付宝支付按钮 -->
    <div style="text-align:center; margin:20px 0;">
        <button class="btn btn-success" onclick="payByAlipay()">跳转支付宝支付</button>
        <!-- <button class="btn btn-success" onclick="payByWechat()">跳转微信支付</button> -->
    </div>
    <button class="donate-close" onclick="closeDonatePage()">关闭</button>
</div>
<script src="../script/api.js"></script>
<script>
    // 长按保存图片（移动端）
    var donateImgLongPressTimer = null;

    apiready = function() {

        // 监听返回键，捐赠页再返回才关闭 frame     --暂无效，不通过此方式实现返回
        if (window.api && api.addEventListener) {
            console.log("设置监听返回键");
            api.addEventListener({name: 'keyback'}, function(ret, err){
                console.log("返回键监听被触发：" + JSON.stringify(ret));
                goBackToSource();
            });
        }
        // 绑定二维码图片点击事件
        var imgs = document.querySelectorAll('.donate-item img');
        imgs.forEach(function(img) {
            img.onclick = function() {
                openFullImg(this.src);
            };
        });
    }

    function donateImgTouchStart(e, img) {
        donateImgLongPressTimer = setTimeout(function() {
            saveDonateImg(img);
        }, 700);
    }
    function donateImgTouchEnd(e, img) {
        if(donateImgLongPressTimer) clearTimeout(donateImgLongPressTimer);
    }
    // 右键保存图片（PC端）
    function saveDonateImg(img) {
        if(window.api && api.saveMediaToAlbum){
            api.saveMediaToAlbum({path: img.src}, function(ret, err){
                if(ret && ret.status){
                    api.toast({msg:'图片已保存到相册',duration:1500,location:'middle'});
                }else{
                    api.toast({msg:'保存失败',duration:1500,location:'middle'});
                }
            });
        }else{
            // PC端弹出新窗口
            window.open(img.src, '_blank');
        }
    }
    // 全屏查看图片     -未实现左右切换、单击返回的效果，且返回键无效
    function openFullImg(src) {
        if (window.api && api.require) {
            var imgs = Array.from(document.querySelectorAll('.donate-item img'));
            var images = imgs.map(function(img){ return getAbsolutePath(img.src); });
            var absSrc = getAbsolutePath(src);
            var activeIndex = images.indexOf(absSrc);
            if (activeIndex === -1) activeIndex = 0;
            var UIPhotoViewer = api.require('UIPhotoViewer');
            UIPhotoViewer.open({
                images: images,
                placeholderImg: images[activeIndex],
                bgColor: '#000',
                activeIndex: activeIndex
            }, function(ret, err) {
                if (ret) {
                    // 长按图片
                    if (ret.eventType === 'longPress') {
                        console.log("触发了长按图片事件");
                        // 弹窗提示是否保存图片到本地，点击确认即可保存到本地
                        api.confirm({
                            title: '保存图片',
                            msg: '是否将该图片保存到本地相册？',
                            buttons: ['取消', '保存']
                        }, function(res, err) {
                            if (res && res.buttonIndex === 2) {
                                // 用户点击“保存”
                                api.saveMediaToAlbum({path: images[activeIndex]}, function(ret, err){
                                    if(ret && ret.status){
                                        api.toast({msg:'图片已保存到相册',duration:1500,location:'middle'});
                                    }else{
                                        api.toast({msg:'保存失败',duration:1500,location:'middle'});
                                    }
                                });
                            }
                        });
                    }
                    // 单击图片或返回
                    if (ret.eventType === 'click' || ret.eventType === 'back') {
                        // 关闭UIPhotoViewer并返回上个页面
                        console.log("触发了单击图片或返回事件");
                        UIPhotoViewer.close();
                        // goBackToSource();
                    }
                }
            });
            return;
        }
        window.open(src, '_blank');
    }

    // 补充图片路径转绝对路径函数，兼容APICloud本地图片
    function getAbsolutePath(src) {
        if (/^(http|https|file|fs):\/\//.test(src)) {
            return src;
        }
        // 兼容APICloud本地资源
        if (window.api && api.fsDir) {
            var fileName = src.split('/').pop();
            return 'fs://image/' + fileName;
        }
        return src;
    }

    // 返回到来源页面或关闭
    function goBackToSource() {
        if(window.api && api.pageParam && api.pageParam.fromPage){
            // 通知主窗口切换回来源页面
            console.log("通知主窗口切换回来源页面：" + api.pageParam.fromPage);
            api.sendEvent({
                name: 'donateBack',
                extra: {fromPage: api.pageParam.fromPage}
            });
            setTimeout(function(){
                closeDonatePage();
            }, 100);
        }else{
            closeDonatePage();
        }
    }
    // 关闭页面
    function closeDonatePage() {
        if(window.api && api.closeFrame){
            api.closeFrame();
        }else{
            window.close();
        }
    }
     // 支付宝H5支付跳转
     function payByAlipay() {
        // 替换为你的收款支付宝账号或收款链接
        // 推荐使用官方收款链接格式：https://qr.alipay.com/fkxXXXXXX
        // 自己的：https://qr.alipay.com/fkx11751gsuloosuwuc4qe9
        // 或者使用转账协议格式
        var alipayUrl = 'https://render.alipay.com/p/s/i/?scheme=alipays://platformapi/startapp?appId=20000067&url=https%3A%2F%2Fqr.alipay.com%2Ffkx11751gsuloosuwuc4qe9';
        // 也可以直接用官方收款二维码链接
        var alipayUrl = 'https://qr.alipay.com/fkx11751gsuloosuwuc4qe9';
        // 也可以用转账协议（部分浏览器支持）：
        // var alipayUrl = 'alipays://platformapi/startapp?appId=20000123&actionType=toAccount&goBack=NO&amount=5&userId=2088123456789012&memo=统计页支付';
        window.open(alipayUrl, '_blank');
    }

    // 微信H5支付跳转   -暂未实现
    function payByWechat() {
        // 也可以直接用官方收款二维码链接
        var payUrl = '';
        window.open(payUrl, '_blank');
    }
</script>
</body>
</html> 