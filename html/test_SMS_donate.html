<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <title>打赏捐赠</title>
    <link rel="stylesheet" href="../css/api.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .donate-container {
            background: #fff;
            border-radius: 12px;
            margin-top: 40px;
            padding: 24px 16px 16px 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            text-align: center;
            max-width: 95vw;
        }
        .donate-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        .donate-tip {
            font-size: 14px;
            color: #888;
            margin-bottom: 18px;
        }
        .donate-qrcodes {
            display: flex;
            gap: 24px;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
        }
        .donate-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .donate-item img {
            width: 140px;
            height: 140px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            background: #eee;
        }
        .donate-label {
            margin-top: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        .wechat {
            color: #44b549;
        }
        .alipay {
            color: #1677ff;
        }
        .donate-close {
            margin-top: 18px;
            padding: 8px 32px;
            background: #007aff;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
        }

        .btn {padding: 10px 10px; margin: 5px; background: #007aff; color: white; border: none; border-radius: 5px; cursor: pointer;}
        .btn:disabled {background: #ccc; cursor: not-allowed; opacity: 0.6;}
        .btn:enabled:hover {background: #0056cc;}
        .btn-danger {background: #ff4444;}
        .btn-danger:hover {background: #cc0000;}
        .btn-success {background: #44aa44;}
        .btn-success:hover {background: #338833;}
    </style>
</head>
<body>
<div class="donate-container">
    <div class="donate-title">打赏捐赠</div>
    <div class="donate-tip">感谢您的支持！可长按保存收款码</div>
    <div class="donate-qrcodes">
        <div class="donate-item">
            <img src="../image/yb_wechat_qrcode.jpg" alt="微信收款码" oncontextmenu="saveDonateImg(this)" ontouchstart="donateImgTouchStart(event,this)" ontouchend="donateImgTouchEnd(event,this)">
            <div class="donate-label wechat">微信</div>
        </div>
        <div class="donate-item">
            <img src="../image/yb_alipay_qrcode.jpg" alt="支付宝收款码" oncontextmenu="saveDonateImg(this)" ontouchstart="donateImgTouchStart(event,this)" ontouchend="donateImgTouchEnd(event,this)">
            <div class="donate-label alipay">支付宝</div>
        </div>
    </div>
    <!-- 新增支付宝支付按钮 -->
    <div style="text-align:center; margin:20px 0;">
        <button class="btn btn-success" onclick="payByAlipay()">跳转支付宝支付</button>
        <!-- <button class="btn btn-success" onclick="payByAlipay2()">W2-跳转支付宝支付</button> -->
        <!-- <button class="btn btn-success" onclick="payByWechat()">跳转微信支付</button> -->
    </div>
    <button class="donate-close" onclick="closeDonatePage()">关闭</button>
</div>
<script src="../script/api.js"></script>
<script>
    // 长按保存图片（移动端）
    var donateImgLongPressTimer = null;
    var isImageViewing = false; // 是否图片查看模式
    var UIPhotoViewer = null;

    apiready = function() {

        // 监听返回键，捐赠页再返回才关闭 frame
        if (window.api && api.addEventListener) {
            // console.log("设置监听返回键");
            // api.addEventListener({name: 'keyback'}, function(ret, err){
            //     console.log("返回键监听被触发：" + JSON.stringify(ret));
            //     goBackToSource();
            // });

            // 新增：监听从支付窗口发来的成功事件
            api.addEventListener({
                name: 'paymentSuccess'
            }, function(ret, err) {
                // 这里是支付成功后的自定义回调逻辑
                api.toast({ msg: '支付已完成，感谢您的支持！' });
                // 在这里可以写真正的回调业务，比如刷新页面
            });
        }
        
        // 绑定二维码图片点击事件
        var imgs = document.querySelectorAll('.donate-item img');
        imgs.forEach(function(img) {
            img.onclick = function() {
                openFullImg(this.src);
            };
        });

        // 【重要】页面加载时，检查是否从支付宝回调
        checkAlipayCallback();

        UIPhotoViewer = api.require('UIPhotoViewer'); // 图片模块初始化
    }

    function donateImgTouchStart(e, img) {
        donateImgLongPressTimer = setTimeout(function() {
            saveDonateImg(img);
        }, 700);

        // 另一种方式直接触发跳转处理：
        // // H5环境下推荐用render跳转
        // var h5Url = 'https://render.alipay.com/p/s/i/?scheme=' + encodeURIComponent(alipayUrl);
        // console.log("h5Url:", h5Url);

        // if (!window.api) {
        //     alert('请在APP环境中使用');
        //     window.open(h5Url, '_blank');
        //     return;
        // }
        // // 【重要】改用 api.openWin 在新窗口打开，而不是在当前页面跳转
        // api.openWin({
        //     name: 'alipay_window_' + Date.now(),
        //     url: h5Url,
        //     bgColor: '#ffffff'
        // });
    }
    function donateImgTouchEnd(e, img) {
        if(donateImgLongPressTimer) clearTimeout(donateImgLongPressTimer);
    }
    // 右键保存图片（PC端）
    function saveDonateImg(img) {
        if(window.api && api.saveMediaToAlbum){
            api.saveMediaToAlbum({path: img.src}, function(ret, err){
                if(ret && ret.status){
                    api.toast({msg:'图片已保存到相册',duration:1500,location:'middle'});
                }else{
                    api.toast({msg:'保存失败',duration:1500,location:'middle'});
                }
            });
        }else{
            // PC端弹出新窗口
            window.open(img.src, '_blank');
        }
    }
    // 全屏查看图片     -未实现左右切换、单击返回的效果，且返回键无效
    function openFullImg(src) {
        if (window.api && api.require) {
            var imgs = Array.from(document.querySelectorAll('.donate-item img'));
            var images = imgs.map(function(img){ return getAbsolutePath(img.src); });
            var absSrc = getAbsolutePath(src);
            var activeIndex = images.indexOf(absSrc);
            if (activeIndex === -1) activeIndex = 0;
            
            UIPhotoViewer.open({
                images: images,
                placeholderImg: images[activeIndex],
                bgColor: '#000',
                activeIndex: activeIndex
            }, function(ret, err) {
                isImageViewing = true; // 标记图片查看中
                if (ret) {
                    console.log(JSON.stringify(ret))
                    // 长按图片
                    if (ret.eventType === 'longPress') {
                        console.log("触发了长按图片事件");
                        // 弹窗提示是否保存图片到本地，点击确认即可保存到本地
                        api.confirm({
                            title: '保存图片',
                            msg: '是否将该图片保存到本地相册？',
                            buttons: ['取消', '保存']
                        }, function(res, err) {
                            if (res && res.buttonIndex === 2) {
                                // 用户点击“保存”
                                api.saveMediaToAlbum({path: images[activeIndex]}, function(ret, err){
                                    if(ret && ret.status){
                                        api.toast({msg:'图片已保存到相册',duration:1500,location:'middle'});
                                    }else{
                                        api.toast({msg:'保存失败',duration:1500,location:'middle'});
                                    }
                                });
                            }
                        });
                    }
                    // 单击图片或返回
                    if (ret.eventType === 'click' || ret.eventType === 'back') {
                        // 关闭UIPhotoViewer并返回上个页面
                        console.log("触发了单击图片或返回事件");
                        isImageViewing = false; // 标记图片浏览结束
                        UIPhotoViewer.close();
                    }
                }
            });
            return;
        }
        window.open(src, '_blank');
    }

    // 补充图片路径转绝对路径函数，兼容APICloud本地图片
    function getAbsolutePath(src) {
        if (/^(http|https|file|fs):\/\//.test(src)) {
            return src;
        }
        // 兼容APICloud本地资源
        if (window.api && api.fsDir) {
            var fileName = src.split('/').pop();
            return 'fs://image/' + fileName;
        }
        return src;
    }

    // 返回到来源页面或关闭     -作废
    function goBackToSource() {
        if(window.api && api.pageParam && api.pageParam.fromPage){
            // 通知主窗口切换回来源页面
            console.log("通知主窗口切换回来源页面：" + api.pageParam.fromPage);
            api.sendEvent({
                name: 'donateBack',
                extra: {fromPage: api.pageParam.fromPage}
            });
            setTimeout(function(){
                closeDonatePage();
            }, 100);
        }else{
            console.log("触发了返回：goBackToSource" );
            // 【重要】简化这里的逻辑，直接关闭页面
            closeDonatePage();
        }
    }

    function goBack() {
        console.log('返回键被触发，当前图片查看状态：', isImageViewing);
        
        // 如果处于多选模式，先退出多选模式
        if (isImageViewing) {
            console.log('退出图片查看');
            UIPhotoViewer.close();
            isImageViewing = false; // 标记为非查看图片状态
        } else {
            console.log('关闭捐赠页面，回到上级页面');
            // 非图片查看状态，直接关闭frame
            closeDonatePage();
        }
    }

    // 关闭页面
    function closeDonatePage() {
        if(window.api && api.closeFrame){
            api.closeFrame();
        }else{
            window.close();
        }
    }
     // 支付宝H5支付跳转
     function payByAlipay() {
        // 替换为你的收款支付宝账号或收款链接
        // 推荐使用官方收款链接格式：https://qr.alipay.com/fkxXXXXXX
        // 自己的：https://qr.alipay.com/fkx11751gsuloosuwuc4qe9
        // 或者使用转账协议格式
        // var alipayUrl = 'https://render.alipay.com/p/s/i/?scheme=alipays://platformapi/startapp?appId=20000067&url=https%3A%2F%2Fqr.alipay.com%2Ffkx11751gsuloosuwuc4qe9';
        // 也可以直接用官方收款二维码链接
        var alipayUrl = 'https://qr.alipay.com/fkx11751gsuloosuwuc4qe9';
        // 也可以用转账协议（部分浏览器支持）：
        // var alipayUrl = 'alipays://platformapi/startapp?appId=20000123&actionType=toAccount&goBack=NO&amount=5&userId=2088123456789012&memo=统计页支付';
        api.openWin({
            name: 'alipay_win_1',
            url: alipayUrl
        });
    }

    // 微信H5支付跳转   -暂未实现
    function payByWechat() {
        // 也可以直接用官方收款二维码链接
        var payUrl = '';
        window.open(payUrl, '_blank');
    }


    // 支付宝第二种的方式-转账协议
    // 支付宝H5支付跳转
    function payByAlipay2() {
        // 希望增加支付后回调自定义方法
        const paymentId = 'pay_' + Date.now();
  
        // 存储本次支付ID
        localStorage.setItem('currentPaymentId', paymentId);
        
        // 支付宝返回URL（支付完成后跳转回你的页面）
        const returnUrl = encodeURIComponent(
            // 这里需要指向你的捐赠页面本身，以便它能执行回调检查逻辑
            '../html/test_SMS_donate.html' + `?paymentId=${paymentId}&fromAlipay=true`
        );
        console.log("paymentId", paymentId);
        console.log("returnUrl", returnUrl);

        // 真实支付宝转账协议，2元，userId请替换为你的收款方支付宝UID
        const alipayUserId = '2088602275251853';
        var alipayUrl = `alipays://platformapi/startapp?appId=20000123&actionType=toAccount&goBack=NO&amount=5&userId=${alipayUserId}&memo=SMS打赏捐赠&returnUrl=${returnUrl}`;
        // H5环境下推荐用render跳转
        var h5Url = 'https://render.alipay.com/p/s/i/?scheme=' + encodeURIComponent(alipayUrl);
        console.log("h5Url:", h5Url);
        // 【重要】改用 api.openWin 在新窗口打开。确保返回时能正常关闭窗口
        api.openWin({
            name: 'alipay_window_' + Date.now(),
            url: h5Url,
            bgColor: '#ffffff'
        });
    }

     // 页面加载时检测是否从支付宝回跳
     function checkAlipayCallback() {
        console.log("初始化检测结果")
        const params = new URLSearchParams(window.location.search);
        if (params.get('fromAlipay') === 'true') {
            const paymentId = params.get('paymentId');
            const storedId = localStorage.getItem('currentPaymentId');
            if (paymentId && paymentId === storedId) {
                localStorage.removeItem('currentPaymentId');

                // 检测到回调，说明当前是在支付成功后打开的新页面
                // 发送成功事件给原来的页面
                if (window.api) {
                    api.sendEvent({ name: 'paymentSuccess' });
                    // 延时一点关闭，确保事件发送成功
                    setTimeout(function() {
                        api.closeWin();
                    }, 200);
                }
            }
        }
    }

</script>
</body>
</html> 